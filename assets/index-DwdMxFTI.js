import{initializeApp as ve}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import{getAuth as ke,GoogleAuthProvider as Te,onAuthStateChanged as Se,signInWithPopup as Ee,signInWithEmailAndPassword as Le,createUserWithEmailAndPassword as xe,signOut as Ie}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import{getDatabase as Ae,ref as wt,get as qt,update as Ce,child as it,onValue as Bt,off as $t,set as vt,remove as kt}from"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const a of n)if(a.type==="childList")for(const r of a.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&s(r)}).observe(document,{childList:!0,subtree:!0});function e(n){const a={};return n.integrity&&(a.integrity=n.integrity),n.referrerPolicy&&(a.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?a.credentials="include":n.crossOrigin==="anonymous"?a.credentials="omit":a.credentials="same-origin",a}function s(n){if(n.ep)return;n.ep=!0;const a=e(n);fetch(n.href,a)}})();const Q={OFF:0,ALL:1,ONE:2},Me=["HI_RES_LOSSLESS","LOSSLESS","HIGH","LOW"],Be={HI_RES_LOSSLESS:["HI_RES_LOSSLESS","HIRES_LOSSLESS","HIRESLOSSLESS","HIFI_PLUS","HI_RES_FLAC","HI_RES","HIRES","MASTER","MASTER_QUALITY","MQA"],LOSSLESS:["LOSSLESS","HIFI"],HIGH:["HIGH","HIGH_QUALITY"],LOW:["LOW","LOW_QUALITY"]},ie="Too Many Requests. Please wait a moment and try again.",st='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><polygon points="7 3 21 12 7 21 7 3"></polygon></svg>',$e='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"></rect><rect x="14" y="4" width="4" height="16"></rect></svg>',Pe='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M19.07 4.93a10 10 0 0 1 0 14.14M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>',Fe='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><line x1="23" y1="9" x2="17" y2="15"></line><line x1="17" y1="9" x2="23" y2="15"></line></svg>',ct='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>',He='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>',Qt='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="heart-icon"><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>',It='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>',Re='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>',mt=i=>{if(isNaN(i))return"0:00";const t=Math.floor(i/60),e=Math.floor(i%60);return`${t}:${String(e).padStart(2,"0")}`},O=(i,t=!1)=>`<div class="placeholder-text ${t?"loading":""}">${i}</div>`,R=new WeakMap,rt=i=>i?i.replace(/[\\/:*?"<>|]/g,"_").replace(/\s+/g," ").trim():"Unknown",ae=i=>{switch(i){case"LOW":case"HIGH":return"m4a";default:return"flac"}},At=(i,t)=>{const e=localStorage.getItem("filename-template")||"{trackNumber} - {artist} - {title}",s=ae(t),n=i.artist?.name||i.artists?.[0]?.name||"Unknown Artist",a={trackNumber:i.trackNumber,artist:n,title:Y(i),album:i.album?.title};return Ct(e,a)+"."+s},_e=i=>i?i.trim().toUpperCase().replace(/[^A-Z0-9]+/g,"_"):"",re=i=>{if(!i)return null;const t=_e(i);for(const[e,s]of Object.entries(Be))if(s.includes(t))return e;return null},zt=i=>{if(!Array.isArray(i))return null;const t=[];for(const e of i){if(typeof e!="string")continue;const s=re(e);s&&!t.includes(s)&&t.push(s)}return oe(t)},oe=i=>{let t=null,e=1/0;for(const s of i){if(!s)continue;const n=Me.indexOf(s),a=n===-1?1/0:n;a<e&&(t=s,e=a)}return t},De=i=>{if(!i)return null;const t=[zt(i.mediaMetadata?.tags),zt(i.album?.mediaMetadata?.tags),re(i.audioQuality)];return oe(t)},Tt=i=>new Promise(t=>setTimeout(t,i)),Pt=i=>i?.explicit===!0||i?.explicitLyrics===!0,Oe=(i,t)=>{let e;return function(...n){const a=()=>{clearTimeout(e),i(...n)};clearTimeout(e),e=setTimeout(a,t)}},V=i=>typeof i!="string"?i:i.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"),Y=(i,{fallback:t="Unknown Title"}={})=>i?.title?i?.version?`${i.title} (${i.version})`:i.title:t,G=(i={},{fallback:t="Unknown Artist"}={})=>i?.artists?.length?i.artists.map(e=>e?.name).join(", "):t,Kt=(i={},{fallback:t="Unknown Artist"}={})=>i?.artists?.length?i.artists.map(e=>`<span class="artist-link" data-artist-id="${e.id}">${e.name}</span>`).join(", "):t,Ct=(i,t)=>{let e=i;return e=e.replace(/\{trackNumber\}/g,t.trackNumber?String(t.trackNumber).padStart(2,"0"):"00"),e=e.replace(/\{artist\}/g,rt(t.artist||"Unknown Artist")),e=e.replace(/\{title\}/g,rt(t.title||"Unknown Title")),e=e.replace(/\{album\}/g,rt(t.album||"Unknown Album")),e=e.replace(/\{albumArtist\}/g,rt(t.albumArtist||"Unknown Artist")),e=e.replace(/\{albumTitle\}/g,rt(t.albumTitle||"Unknown Album")),e=e.replace(/\{year\}/g,t.year||"Unknown"),e},St=i=>!Array.isArray(i)||i.length===0?0:i.reduce((t,e)=>t+(e.duration||0),0),Et=i=>{if(!i||isNaN(i))return"0 min";const t=Math.floor(i/3600),e=Math.floor(i%3600/60);return t>0?`${t} hr ${e} min`:`${e} min`},dt=new Map;async function bt(i,t){if(!t)return null;if(dt.has(t))return dt.get(t);const e=async s=>{try{const n=`https://corsproxy.io/?${encodeURIComponent(s)}`,a=await fetch(n);if(a.ok)return await a.blob()}catch(n){console.warn("Proxy fetch failed:",n)}return null};try{const s=i.getCoverUrl(t,"1280"),n=await fetch(s);if(n.ok){const a=await n.blob();return dt.set(t,a),a}else{const a=await e(s);if(a)return dt.set(t,a),a}}catch{const n=i.getCoverUrl(t,"1280"),a=await e(n);if(a)return dt.set(t,a),a}return null}class Ue{constructor(t={}){this.memoryCache=new Map,this.maxSize=t.maxSize||200,this.ttl=t.ttl||1e3*60*30,this.dbName="monochrome-cache",this.dbVersion=1,this.db=null,this.initDB()}async initDB(){if(!(typeof indexedDB>"u"))return new Promise((t,e)=>{const s=indexedDB.open(this.dbName,this.dbVersion);s.onerror=()=>e(s.error),s.onsuccess=()=>{this.db=s.result,t(this.db)},s.onupgradeneeded=n=>{const a=n.target.result;a.objectStoreNames.contains("responses")||a.createObjectStore("responses",{keyPath:"key"}).createIndex("timestamp","timestamp",{unique:!1})}})}generateKey(t,e){const s=typeof e=="object"?JSON.stringify(e):String(e);return`${t}:${s}`}async get(t,e){const s=this.generateKey(t,e);if(this.memoryCache.has(s)){const n=this.memoryCache.get(s);if(Date.now()-n.timestamp<this.ttl)return n.data;this.memoryCache.delete(s)}if(this.db)try{const n=await this.getFromIndexedDB(s);if(n&&Date.now()-n.timestamp<this.ttl)return this.memoryCache.set(s,n),n.data}catch(n){console.debug("IndexedDB read error:",n)}return null}async set(t,e,s){const n=this.generateKey(t,e),a={key:n,data:s,timestamp:Date.now()};if(this.memoryCache.set(n,a),this.memoryCache.size>this.maxSize){const r=this.memoryCache.keys().next().value;this.memoryCache.delete(r)}if(this.db)try{await this.setInIndexedDB(a)}catch(r){console.debug("IndexedDB write error:",r)}}getFromIndexedDB(t){return new Promise((e,s)=>{if(!this.db){e(null);return}const r=this.db.transaction(["responses"],"readonly").objectStore("responses").get(t);r.onsuccess=()=>e(r.result||null),r.onerror=()=>s(r.error)})}setInIndexedDB(t){return new Promise((e,s)=>{if(!this.db){e();return}const r=this.db.transaction(["responses"],"readwrite").objectStore("responses").put(t);r.onsuccess=()=>e(),r.onerror=()=>s(r.error)})}async clear(){if(this.memoryCache.clear(),this.db)return new Promise((t,e)=>{const a=this.db.transaction(["responses"],"readwrite").objectStore("responses").clear();a.onsuccess=()=>t(),a.onerror=()=>e(a.error)})}async clearExpired(){const t=Date.now(),e=[];for(const[s,n]of this.memoryCache.entries())t-n.timestamp>=this.ttl&&e.push(s);if(e.forEach(s=>this.memoryCache.delete(s)),this.db)try{const a=this.db.transaction(["responses"],"readwrite").objectStore("responses").index("timestamp"),r=IDBKeyRange.upperBound(t-this.ttl),c=a.openCursor(r);c.onsuccess=o=>{const l=o.target.result;l&&(l.delete(),l.continue())}}catch(s){console.debug("Failed to clear expired IndexedDB entries:",s)}}getCacheStats(){return{memoryEntries:this.memoryCache.size,maxSize:this.maxSize,ttl:this.ttl}}}const je="Monochrome",Ne="Unknown Title",Wt="Unknown Artist",qe="Unknown Album";async function le(i,t,e,s){const n=ae(s);return n==="flac"?await Qe(i,t,e):n==="m4a"?await Ve(i,t,e):i}async function Qe(i,t,e){try{const s=await i.arrayBuffer(),n=new DataView(s);if(!ze(n))return console.warn("Not a valid FLAC file, returning original"),i;const a=Ke(n),r=We(t);let c=null;if(t.album?.cover)try{c=await Ye(t.album.cover,e)}catch(l){console.warn("Failed to embed album art:",l)}const o=Ge(n,a,r,c);return new Blob([o],{type:"audio/flac"})}catch(s){return console.error("Failed to add FLAC metadata:",s),i}}function ze(i){return i.byteLength>=4&&i.getUint8(0)===102&&i.getUint8(1)===76&&i.getUint8(2)===97&&i.getUint8(3)===67}function Ke(i){const t=[];let e=4;for(;e+4<=i.byteLength;){const s=i.getUint8(e),n=(s&128)!==0,a=s&127,r=i.getUint8(e+1)<<16|i.getUint8(e+2)<<8|i.getUint8(e+3);if(e+4+r>i.byteLength){console.warn("Invalid block size detected, stopping parse");break}if(t.push({type:a,isLast:n,size:r,offset:e+4,headerOffset:e}),e+=4+r,n){t.audioDataOffset=e;break}}return t}function We(i){const t=[];i.title&&t.push(["TITLE",i.title]),i.artist?.name&&t.push(["ARTIST",i.artist.name]),i.album?.title&&t.push(["ALBUM",i.album.title]),i.album?.artist?.name&&t.push(["ALBUMARTIST",i.album.artist.name]),i.trackNumber&&t.push(["TRACKNUMBER",String(i.trackNumber)]),i.album?.numberOfTracks&&t.push(["TRACKTOTAL",String(i.album.numberOfTracks)]);const e=i.album?.releaseDate||(i.streamStartDate?i.streamStartDate.split("T")[0]:"");if(e)try{const m=new Date(e).getFullYear();isNaN(m)||t.push(["DATE",String(m)])}catch{}i.copyright&&t.push(["COPYRIGHT",i.copyright]),i.isrc&&t.push(["ISRC",i.isrc]);const s=je,n=new TextEncoder().encode(s);let a=4+n.length+4;const r=t.map(([m,u])=>{const h=`${m}=${u}`,f=new TextEncoder().encode(h);return a+=4+f.length,f}),c=new ArrayBuffer(a),o=new DataView(c),l=new Uint8Array(c);let d=0;o.setUint32(d,n.length,!0),d+=4,l.set(n,d),d+=n.length,o.setUint32(d,t.length,!0),d+=4;for(const m of r)o.setUint32(d,m.length,!0),d+=4,l.set(m,d),d+=m.length;return l}async function Ye(i,t){try{const e=await bt(t,i);if(!e)throw new Error("Failed to fetch album art");const s=new Uint8Array(await e.arrayBuffer()),n=e.type||"image/jpeg",a=new TextEncoder().encode(n),c=new TextEncoder().encode(""),o=8+a.length+4+c.length+4+4+4+4+4+s.length,l=new ArrayBuffer(o),d=new DataView(l),m=new Uint8Array(l);let u=0;return d.setUint32(u,3,!1),u+=4,d.setUint32(u,a.length,!1),u+=4,m.set(a,u),u+=a.length,d.setUint32(u,c.length,!1),u+=4,c.length>0&&(m.set(c,u),u+=c.length),d.setUint32(u,0,!1),u+=4,d.setUint32(u,0,!1),u+=4,d.setUint32(u,0,!1),u+=4,d.setUint32(u,0,!1),u+=4,d.setUint32(u,s.length,!1),u+=4,m.set(s,u),m}catch(e){return console.error("Failed to create FLAC picture block:",e),null}}function Ge(i,t,e,s){const n=new Uint8Array(i.buffer),a=t.filter(f=>f.type!==4&&f.type!==6);let r=4;for(const f of a)r+=4+f.size;r+=4+e.length,s&&(r+=4+s.length);const c=t.audioDataOffset;if(c===void 0)throw new Error("Invalid FLAC file structure: unable to locate audio data stream");const o=i.byteLength-c;r+=o;const l=new Uint8Array(r);let d=0;l[d++]=102,l[d++]=76,l[d++]=97,l[d++]=67;for(let f=0;f<a.length;f++){const p=a[f],g=0|p.type;l[d++]=g,l[d++]=p.size>>16&255,l[d++]=p.size>>8&255,l[d++]=p.size&255,l.set(n.subarray(p.offset,p.offset+p.size),d),d+=p.size}const m=d,u=4;l[d++]=u,l[d++]=e.length>>16&255,l[d++]=e.length>>8&255,l[d++]=e.length&255,l.set(e,d),d+=e.length;let h=m;if(s){const f=d,p=6;l[d++]=p,l[d++]=s.length>>16&255,l[d++]=s.length>>8&255,l[d++]=s.length&255,l.set(s,d),d+=s.length,h=f}return l[h]|=128,o>0&&l.set(n.subarray(c,c+o),d),l}async function Ve(i,t,e){try{const s=await i.arrayBuffer(),n=new DataView(s),a=ce(n),r=Je(t);if(t.album?.cover)try{const o=await bt(e,t.album.cover);if(o){const l=new Uint8Array(await o.arrayBuffer());r.cover={type:"covr",data:l}}}catch(o){console.warn("Failed to embed album art in M4A:",o)}const c=Xe(n,a,r);return new Blob([c],{type:"audio/mp4"})}catch(s){return console.error("Failed to add M4A metadata:",s),i}}function ce(i){const t=[];let e=0;for(;e+8<=i.byteLength;){let s=i.getUint32(e,!1);if(s===0)s=i.byteLength-e;else if(s===1){if(e+16>i.byteLength)break;const a=i.getUint32(e+8,!1),r=i.getUint32(e+12,!1);if(a!==0){console.warn("64-bit MP4 atoms larger than 4GB are not supported - file may be processed incompletely");break}s=r}if(s<8||e+s>i.byteLength)break;const n=String.fromCharCode(i.getUint8(e+4),i.getUint8(e+5),i.getUint8(e+6),i.getUint8(e+7));t.push({type:n,offset:e,size:s}),e+=s}return t}function Je(i){const t={"©nam":i.title||Ne,"©ART":i.artist?.name||Wt,"©alb":i.album?.title||qe,aART:i.album?.artist?.name||Wt};i.trackNumber&&(t.trkn=i.trackNumber);const e=i.album?.releaseDate||(i.streamStartDate?i.streamStartDate.split("T")[0]:"");if(e)try{const s=new Date(e).getFullYear();isNaN(s)||(t["©day"]=String(s))}catch{}return{tags:t}}function Xe(i,t,e){const s=new Uint8Array(i.buffer),n=t.find(w=>w.type==="moov");if(!n)return console.warn("No moov atom found in M4A file"),s;const a=Ze(e),c=ce(new DataView(s.buffer,n.offset+8,n.size-8)).filter(w=>w.type!=="udta");let o=8;for(const w of c)o+=w.size;o+=a.length;const l=o-n.size,d=s.length+l,m=new Uint8Array(d);let u=0,h=0;const f=t.filter(w=>w.offset<n.offset);for(const w of f)m.set(s.subarray(w.offset,w.offset+w.size),u),u+=w.size,h+=w.size;m[u++]=o>>24&255,m[u++]=o>>16&255,m[u++]=o>>8&255,m[u++]=o&255,m[u++]=109,m[u++]=111,m[u++]=111,m[u++]=118;for(const w of c){n.offset+8+w.offset;const b=n.offset+8+w.offset;m.set(s.subarray(b,b+w.size),u),u+=w.size}m.set(a,u),u+=a.length,h=n.offset+n.size;const p=t.find(w=>w.type==="mdat");return p&&n.offset<p.offset&&ns(m,u-o,o,l),h<s.length&&m.set(s.subarray(h),u),m}function Ze(i){const{tags:t,cover:e}=i,s=[];for(const[g,w]of Object.entries(t))g==="trkn"?s.push(es(g,w)):s.push(ts(g,w));e&&s.push(ss(e.data));const n=8+s.reduce((g,w)=>g+w.length,0),a=new Uint8Array(n);let r=0;W(a,r,n,"ilst"),r+=8;for(const g of s)a.set(g,r),r+=g.length;const c=12+n,o=new Uint8Array(c);r=0,W(o,r,c,"meta"),r+=8,o[r++]=0,o[r++]=0,o[r++]=0,o[r++]=0,o.set(a,r);const l=new Uint8Array([0,0,0,0,0,0,0,0,109,100,105,114,97,112,112,108,0,0,0,0,0,0,0,0,0,0]),d=8+l.length,m=new Uint8Array(d);W(m,0,d,"hdlr"),m.set(l,8);const u=12+d+n,h=new Uint8Array(u);r=0,W(h,r,u,"meta"),r+=8,h[r++]=0,h[r++]=0,h[r++]=0,h[r++]=0,h.set(m,r),r+=d,h.set(a,r);const f=8+u,p=new Uint8Array(f);return W(p,0,f,"udta"),p.set(h,8),p}function ts(i,t){const e=new TextEncoder().encode(t),s=16+e.length,n=8+s,a=new Uint8Array(n);let r=0;return W(a,r,n,i),r+=8,W(a,r,s,"data"),r+=8,a[r++]=0,a[r++]=0,a[r++]=0,a[r++]=1,a[r++]=0,a[r++]=0,a[r++]=0,a[r++]=0,a.set(e,r),a}function es(i,t){const n=new Uint8Array(32);let a=0;W(n,a,32,i),a+=8,W(n,a,24,"data"),a+=8,n[a++]=0,n[a++]=0,n[a++]=0,n[a++]=0,n[a++]=0,n[a++]=0,n[a++]=0,n[a++]=0,n[a++]=0,n[a++]=0;const r=parseInt(t)||0;return n[a++]=r>>8&255,n[a++]=r&255,n[a++]=0,n[a++]=0,n[a++]=0,n[a++]=0,n}function ss(i){const t=16+i.length,e=8+t,s=new Uint8Array(e);let n=0;W(s,n,e,"covr"),n+=8,W(s,n,t,"data"),n+=8;let a=13;return i[0]===137&&i[1]===80&&(a=14),s[n++]=0,s[n++]=0,s[n++]=0,s[n++]=a,s[n++]=0,s[n++]=0,s[n++]=0,s[n++]=0,s.set(i,n),s}function W(i,t,e,s){i[t++]=e>>24&255,i[t++]=e>>16&255,i[t++]=e>>8&255,i[t++]=e&255;for(let n=0;n<4;n++)i[t++]=s.charCodeAt(n)}function ns(i,t,e,s){const n=new DataView(i.buffer,i.byteOffset,i.byteLength);let a=t+8;const r=t+e;de(n,a,r,s)}function de(i,t,e,s){let n=t;for(;n+8<=e;){const a=i.getUint32(n,!1),r=String.fromCharCode(i.getUint8(n+4),i.getUint8(n+5),i.getUint8(n+6),i.getUint8(n+7));if(a<8)break;if(r==="trak"||r==="mdia"||r==="minf"||r==="stbl")de(i,n+8,n+a,s);else if(r==="stco"){const c=i.getUint32(n+12,!1);for(let o=0;o<c;o++){const l=n+16+o*4,d=i.getUint32(l,!1);i.setUint32(l,d+s,!1)}}else if(r==="co64"){const c=i.getUint32(n+12,!1);for(let o=0;o<c;o++){const l=n+16+o*8,d=i.getUint32(l,!1);let u=i.getUint32(l+4,!1)+s,h=0;u>4294967295&&(h=Math.floor(u/4294967296),u=u>>>0);const f=d+h;i.setUint32(l,f,!1),i.setUint32(l+4,u,!1)}}n+=a}}class is{constructor(t){this.settings=t,this.cache=new Ue({maxSize:200,ttl:1e3*60*30}),this.streamCache=new Map,setInterval(()=>{this.cache.clearExpired(),this.pruneStreamCache()},1e3*60*5)}pruneStreamCache(){if(this.streamCache.size>50){const t=Array.from(this.streamCache.entries());t.slice(0,t.length-50).forEach(([s])=>this.streamCache.delete(s))}}async fetchWithRetry(t,e={}){const s=e.type||"api",n=await this.settings.getInstances(s);if(n.length===0)throw new Error(`No API instances configured for type: ${s}`);const a=3;let r=null;for(const c of n){const o=c.endsWith("/")?`${c}${t.substring(1)}`:`${c}${t}`;for(let l=1;l<=a;l++)try{const d=await fetch(o,{signal:e.signal});if(d.status===429){const m=d.headers.get("Retry-After");let u=2e3*l;if(m){const h=parseInt(m,10);isNaN(h)||(u=h*1e3)}console.warn(`Rate limit hit. Waiting ${u}ms before retry ${l}/${a}...`),await Tt(u);continue}if(d.ok)return d;if(d.status===401){let m;try{m=await d.clone().json()}catch{}if(m?.subStatus===11002&&(r=new Error(m?.userMessage||"Authentication failed"),l<a)){await Tt(200*l);continue}}if(d.status>=500&&l<a){await Tt(200*l);continue}r=new Error(`Request failed with status ${d.status}`);break}catch(d){if(d.name==="AbortError")throw d;r=d,l<a&&await Tt(200*l)}}throw r||new Error(`All API instances failed for: ${t}`)}findSearchSection(t,e,s){if(!(!t||typeof t!="object")){if(Array.isArray(t)){for(const n of t){const a=this.findSearchSection(n,e,s);if(a)return a}return}if(!s.has(t)){if(s.add(t),"items"in t&&Array.isArray(t.items))return t;if(e in t){const n=this.findSearchSection(t[e],e,s);if(n)return n}for(const n of Object.values(t)){const a=this.findSearchSection(n,e,s);if(a)return a}}}}buildSearchResponse(t){const e=t?.items??[];return{items:e,limit:t?.limit??e.length,offset:t?.offset??0,totalNumberOfItems:t?.totalNumberOfItems??e.length}}normalizeSearchResponse(t,e){const s=this.findSearchSection(t,e,new Set);return this.buildSearchResponse(s)}prepareTrack(t){let e=t;!t.artist&&Array.isArray(t.artists)&&t.artists.length>0&&(e={...t,artist:t.artists[0]});const s=De(e);return s&&e.audioQuality!==s&&(e={...e,audioQuality:s}),e}prepareAlbum(t){return!t.artist&&Array.isArray(t.artists)&&t.artists.length>0?{...t,artist:t.artists[0]}:t}preparePlaylist(t){return t}prepareArtist(t){return!t.type&&Array.isArray(t.artistTypes)&&t.artistTypes.length>0?{...t,type:t.artistTypes[0]}:t}parseTrackLookup(t){const e=Array.isArray(t)?t:[t];let s,n,a;for(const r of e)if(!(!r||typeof r!="object")){if(!s&&"duration"in r){s=r;continue}if(!n&&"manifest"in r){n=r;continue}if(!a&&"OriginalTrackUrl"in r){const c=r.OriginalTrackUrl;typeof c=="string"&&(a=c)}}if(!s||!n)throw new Error("Malformed track response");return{track:s,info:n,originalTrackUrl:a}}extractStreamUrlFromManifest(t){try{const e=atob(t);try{const s=JSON.parse(e);if(s?.urls?.[0])return s.urls[0]}catch{const s=e.match(/https?:\/\/[\w\-.~:?#[@!$&'()*+,;=%/]+/);return s?s[0]:null}}catch(e){return console.error("Failed to decode manifest:",e),null}}deduplicateAlbums(t){const e=new Map;for(const s of t){const n=JSON.stringify([s.title,s.numberOfTracks||0]);if(e.has(n)){const a=e.get(n);if(s.explicit&&!a.explicit){e.set(n,s);continue}if(!s.explicit&&a.explicit)continue;const r=a.mediaMetadata?.tags?.length||0;(s.mediaMetadata?.tags?.length||0)>r&&e.set(n,s)}else e.set(n,s)}return Array.from(e.values())}async searchTracks(t,e={}){const s=await this.cache.get("search_tracks",t);if(s)return s;try{const a=await(await this.fetchWithRetry(`/search/?s=${encodeURIComponent(t)}`,e)).json(),r=this.normalizeSearchResponse(a,"tracks"),c={...r,items:r.items.map(o=>this.prepareTrack(o))};return await this.cache.set("search_tracks",t,c),c}catch(n){if(n.name==="AbortError")throw n;return console.error("Track search failed:",n),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchArtists(t,e={}){const s=await this.cache.get("search_artists",t);if(s)return s;try{const a=await(await this.fetchWithRetry(`/search/?a=${encodeURIComponent(t)}`,e)).json(),r=this.normalizeSearchResponse(a,"artists"),c={...r,items:r.items.map(o=>this.prepareArtist(o))};return await this.cache.set("search_artists",t,c),c}catch(n){if(n.name==="AbortError")throw n;return console.error("Artist search failed:",n),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchAlbums(t,e={}){const s=await this.cache.get("search_albums",t);if(s)return s;try{const a=await(await this.fetchWithRetry(`/search/?al=${encodeURIComponent(t)}`,e)).json(),r=this.normalizeSearchResponse(a,"albums"),c=r.items.map(l=>this.prepareAlbum(l)),o={...r,items:this.deduplicateAlbums(c)};return await this.cache.set("search_albums",t,o),o}catch(n){if(n.name==="AbortError")throw n;return console.error("Album search failed:",n),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async searchPlaylists(t,e={}){const s=await this.cache.get("search_playlists",t);if(s)return s;try{const a=await(await this.fetchWithRetry(`/search/?p=${encodeURIComponent(t)}`,e)).json(),r=this.normalizeSearchResponse(a,"playlists"),c={...r,items:r.items.map(o=>this.preparePlaylist(o))};return await this.cache.set("search_playlists",t,c),c}catch(n){if(n.name==="AbortError")throw n;return console.error("Playlist search failed:",n),{items:[],limit:0,offset:0,totalNumberOfItems:0}}}async getAlbum(t){const e=await this.cache.get("album",t);if(e)return e;const n=await(await this.fetchWithRetry(`/album/?id=${t}`)).json(),a=n.data||n;let r,c;if(a&&typeof a=="object"&&!Array.isArray(a)&&(("numberOfTracks"in a||"title"in a)&&(r=this.prepareAlbum(a)),"items"in a&&(c=a,!r&&a.items&&a.items.length>0))){const d=a.items[0],m=d.item||d;m&&m.album&&(r=this.prepareAlbum(m.album))}if(!r)throw new Error("Album not found");if(r&&!r.artist&&c?.items&&c.items.length>0){const d=c.items[0],m=d.item||d;m&&m.artist&&(r={...r,artist:m.artist})}if(r&&!r.releaseDate&&c?.items&&c.items.length>0){const d=c.items[0],m=d.item||d;m&&(m.album&&m.album.releaseDate?r={...r,releaseDate:m.album.releaseDate}:m.streamStartDate&&(r={...r,releaseDate:m.streamStartDate.split("T")[0]}))}const o=(c?.items||[]).map(d=>this.prepareTrack(d.item||d)),l={album:r,tracks:o};return await this.cache.set("album",t,l),l}async getPlaylist(t){const e=await this.cache.get("playlist",t);if(e)return e;const n=await(await this.fetchWithRetry(`/playlist/?id=${t}`)).json(),a=n.data||n;let r=null,c=null;if(a.playlist&&(r=a.playlist),a.items&&(c={items:a.items}),!r||!c){const d=Array.isArray(a)?a:[a];for(const m of d)!m||typeof m!="object"||(!r&&("uuid"in m||"numberOfTracks"in m||"title"in m&&"id"in m)&&(r=m),!c&&"items"in m&&(c=m))}if(!r&&Array.isArray(a)){for(const d of a)if(d&&typeof d=="object"&&("uuid"in d||"numberOfTracks"in d)){r=d;break}}if(!r)throw new Error("Playlist not found");let o=(c?.items||[]).map(d=>this.prepareTrack(d.item||d));if(r.numberOfTracks>o.length){let d=o.length;const m=1e4;for(;o.length<r.numberOfTracks&&o.length<m;)try{const h=await(await this.fetchWithRetry(`/playlist/?id=${t}&offset=${d}`)).json(),f=h.data||h;let p=[];if(f.items)p=f.items;else if(Array.isArray(f)){for(const w of f)if(w&&typeof w=="object"&&"items"in w&&Array.isArray(w.items)){p=w.items;break}}if(!p||p.length===0)break;const g=p.map(w=>this.prepareTrack(w.item||w));if(g.length===0||o.length>0&&g[0].id===o[0].id)break;o=o.concat(g),d+=g.length}catch(u){console.error(`Error fetching playlist tracks at offset ${d}:`,u);break}}const l={playlist:r,tracks:o};return await this.cache.set("playlist",t,l),l}async getMix(t){const e=await this.cache.get("mix",t);if(e)return e;const n=await(await this.fetchWithRetry(`/mix/?id=${t}`,{type:"api"})).json(),a=n.mix,r=n.items||[];if(!a)throw new Error("Mix metadata not found");const c=r.map(d=>this.prepareTrack(d.item||d)),l={mix:{id:a.id,title:a.title,subTitle:a.subTitle,description:a.description,mixType:a.mixType,cover:a.images?.LARGE?.url||a.images?.MEDIUM?.url||a.images?.SMALL?.url||null},tracks:c};return await this.cache.set("mix",t,l),l}async getArtist(t){const e=await this.cache.get("artist",t);if(e)return e;const[s,n]=await Promise.all([this.fetchWithRetry(`/artist/?id=${t}`),this.fetchWithRetry(`/artist/?f=${t}&skip_tracks=true`)]),a=await s.json();let r=a.data||a;const c=r.artist||(Array.isArray(r)?r[0]:r);if(!c)throw new Error("Primary artist details not found.");const o={...this.prepareArtist(c),picture:c.picture||r.cover||null,name:c.name||"Unknown Artist"},l=await n.json(),d=l.data||l,m=Array.isArray(d)?d:[d],u=new Map,h=new Map,f=T=>T?.id&&T.duration&&T.album,p=T=>T?.id&&"numberOfTracks"in T,g=(T,L=new Set)=>{if(!T||typeof T!="object"||L.has(T))return;if(L.add(T),Array.isArray(T)){T.forEach(_=>g(_,L));return}const x=T.item||T;p(x)&&u.set(x.id,this.prepareAlbum(x)),f(x)&&h.set(x.id,this.prepareTrack(x)),Object.values(T).forEach(_=>g(_,L))};m.forEach(T=>g(T));try{const T=await this.searchAlbums(o.name);if(T&&T.items){const L=Number(t);for(const x of T.items)(x.artist?.id===L||Array.isArray(x.artists)&&x.artists.some(C=>C.id===L))&&!u.has(x.id)&&u.set(x.id,x)}}catch(T){console.warn("Failed to fetch additional albums via search:",T)}const w=Array.from(u.values()),b=this.deduplicateAlbums(w).sort((T,L)=>new Date(L.releaseDate||0)-new Date(T.releaseDate||0)),y=b.filter(T=>T.type==="EP"||T.type==="SINGLE"),v=b.filter(T=>!y.includes(T)),S=Array.from(h.values()).sort((T,L)=>(L.popularity||0)-(T.popularity||0)).slice(0,15),E={...o,albums:v,eps:y,tracks:S};return await this.cache.set("artist",t,E),E}async getSimilarArtists(t){const e=await this.cache.get("similar_artists",t);if(e)return e;try{const n=await(await this.fetchWithRetry(`/artist/similar/?id=${t}`,{type:"api"})).json(),r=(n.artists||n.items||n.data||(Array.isArray(n)?n:[])).map(c=>this.prepareArtist(c));return await this.cache.set("similar_artists",t,r),r}catch(s){return console.warn("Failed to fetch similar artists:",s),[]}}async getSimilarAlbums(t){const e=await this.cache.get("similar_albums",t);if(e)return e;try{const n=await(await this.fetchWithRetry(`/album/similar/?id=${t}`,{type:"api"})).json(),r=(n.items||n.albums||n.data||(Array.isArray(n)?n:[])).map(c=>this.prepareAlbum(c));return await this.cache.set("similar_albums",t,r),r}catch(s){return console.warn("Failed to fetch similar albums:",s),[]}}normalizeTrackResponse(t){if(!t||typeof t!="object")return t;const e=t.data??t;return[{duration:e.duration??0,id:e.trackId??null},e]}async getTrack(t,e="LOSSLESS"){const s=`${t}_${e}`,n=await this.cache.get("track",s);if(n)return n;const r=await(await this.fetchWithRetry(`/track/?id=${t}&quality=${e}`,{type:"streaming"})).json(),c=this.parseTrackLookup(this.normalizeTrackResponse(r));return await this.cache.set("track",s,c),c}async getStreamUrl(t,e="LOSSLESS"){const s=`stream_${t}_${e}`;if(this.streamCache.has(s))return this.streamCache.get(s);const n=await this.getTrack(t,e);let a;if(n.originalTrackUrl)a=n.originalTrackUrl;else if(a=this.extractStreamUrlFromManifest(n.info.manifest),!a)throw new Error("Could not resolve stream URL");return this.streamCache.set(s,a),a}async downloadTrack(t,e="LOSSLESS",s,n={}){const{onProgress:a,track:r}=n;try{const c=await this.getTrack(t,e);let o;if(c.originalTrackUrl)o=c.originalTrackUrl;else if(o=this.extractStreamUrlFromManifest(c.info.manifest),!o)throw new Error("Could not resolve stream URL");const l=await fetch(o,{cache:"no-store",signal:n.signal});if(!l.ok)throw new Error(`Fetch failed: ${l.status}`);const d=l.headers.get("Content-Length"),m=d?parseInt(d,10):0;let u=0,h;if(l.body&&a){const f=l.body.getReader(),p=[];for(;;){const{done:g,value:w}=await f.read();if(g)break;w&&(p.push(w),u+=w.byteLength,a({stage:"downloading",receivedBytes:u,totalBytes:m||void 0}))}h=new Blob(p,{type:l.headers.get("Content-Type")||"audio/flac"})}else h=await l.blob(),a&&a({stage:"downloading",receivedBytes:h.size,totalBytes:h.size});r&&(a&&a({stage:"processing",message:"Adding metadata..."}),h=await le(h,r,this,e)),this.triggerDownload(h,s)}catch(c){throw c.name==="AbortError"||(console.error("Download failed:",c),c.message===ie)?c:new Error("Download failed. The stream may require a proxy.")}}triggerDownload(t,e){const s=URL.createObjectURL(t),n=document.createElement("a");n.href=s,n.download=e,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(s)}getCoverUrl(t,e="320"){return t?`https://resources.tidal.com/images/${t.replace(/-/g,"/")}/${e}x${e}.jpg`:`https://picsum.photos/seed/${Math.random()}/${e}`}getArtistPictureUrl(t,e="320"){return t?`https://resources.tidal.com/images/${t.replace(/-/g,"/")}/${e}x${e}.jpg`:`https://picsum.photos/seed/${Math.random()}/${e}`}async clearCache(){await this.cache.clear(),this.streamCache.clear()}getCacheStats(){return{...this.cache.getCacheStats(),streamUrls:this.streamCache.size}}}const as={STORAGE_KEY:"monochrome-api-instances-v2",INSTANCES_URL:"instances.json",SPEED_TEST_CACHE_KEY:"monochrome-instance-speeds",SPEED_TEST_CACHE_DURATION:1e3*60*60,defaultInstances:{api:[],streaming:[]},instancesLoaded:!1,async loadInstancesFromGitHub(){if(this.instancesLoaded)return this.defaultInstances;try{const i=await fetch(this.INSTANCES_URL);if(!i.ok)throw new Error("Failed to fetch instances");const t=await i.json();let e={api:[],streaming:[]};if(Array.isArray(t))e.api=[...t],e.streaming=[...t];else{if(t.api&&Array.isArray(t.api))if(t.api.length>0&&typeof t.api[0]=="string")e.api=[...t.api];else for(const[n,a]of Object.entries(t.api))a.cors===!1&&Array.isArray(a.urls)&&e.api.push(...a.urls);t.streaming&&Array.isArray(t.streaming)?e.streaming=[...t.streaming]:e.api.length>0&&(e.streaming=[...e.api])}return this.defaultInstances=e,this.instancesLoaded=!0,e}catch(i){return console.error("Failed to load instances from GitHub:",i),this.defaultInstances={api:["https://tidal-api.binimum.org","https://monochrome-api.samidy.com"],streaming:["https://triton.squid.wtf","https://wolf.qqdl.site","https://maus.qqdl.site","https://vogel.qqdl.site","https://katze.qqdl.site","https://hund.qqdl.site","https://tidal.kinoplus.online","https://tidal-api.binimum.org"]},this.instancesLoaded=!0,this.defaultInstances}},async speedTestInstance(i,t="api"){let e;t==="streaming"?e=i.endsWith("/")?`${i}track/?id=204567804&quality=HIGH`:`${i}/track/?id=204567804&quality=HIGH`:e=i.endsWith("/")?`${i}artist/?id=3532302`:`${i}/artist/?id=3532302`;const s=performance.now();try{const n=new AbortController,a=setTimeout(()=>n.abort(),5e3),r=await fetch(e,{signal:n.signal,cache:"no-store"});if(clearTimeout(a),!r.ok)return{url:i,type:t,speed:1/0,error:`HTTP ${r.status}`};const o=performance.now()-s;return{url:i,type:t,speed:o,error:null}}catch(n){return{url:i,type:t,speed:1/0,error:n.message}}},getCachedSpeedTests(){try{const i=localStorage.getItem(this.SPEED_TEST_CACHE_KEY);if(!i)return{speeds:{},timestamp:Date.now()};const t=JSON.parse(i);return Date.now()-t.timestamp>this.SPEED_TEST_CACHE_DURATION?{speeds:{},timestamp:Date.now()}:t}catch{return{speeds:{},timestamp:Date.now()}}},updateSpeedCache(i){const t=this.getCachedSpeedTests();i.forEach(e=>{const s=e.type==="streaming"?`${e.url}#streaming`:e.url;t.speeds[s]={speed:e.speed,error:e.error}}),t.timestamp=Date.now();try{localStorage.setItem(this.SPEED_TEST_CACHE_KEY,JSON.stringify(t))}catch{console.warn("[SpeedTest] Failed to cache results")}return t},async testSpecificUrls(i,t){if(!i||i.length===0)return[];console.log(`[SpeedTest] Testing ${i.length} instances for ${t}...`);const e=await Promise.all(i.map(n=>this.speedTestInstance(n,t))),s=e.filter(n=>n.speed!==1/0);return console.log(`[SpeedTest] ${t} Results:`,s.map(n=>`${n.url}: ${n.speed.toFixed(0)}ms`)),e},async getInstances(i="api"){let t;try{const o=localStorage.getItem(this.STORAGE_KEY);o&&(t=JSON.parse(o))}catch{}t||(t=await this.loadInstancesFromGitHub());const e=t[i]||t.api||[];if(e.length===0)return[];const s=this.getCachedSpeedTests(),n=o=>i==="streaming"?`${o}#streaming`:o,a=e.filter(o=>!s.speeds[n(o)]);if(a.length>0){const o=await this.testSpecificUrls(a,i);this.updateSpeedCache(o),Object.assign(s,this.getCachedSpeedTests())}const c=(o=>[...o].sort((l,d)=>{const m=s.speeds[n(l)]?.speed??1/0,u=s.speeds[n(d)]?.speed??1/0;return m-u}))(e);return t[i]=c,this.saveInstances(t),c},async refreshSpeedTests(){const i=await this.loadInstancesFromGitHub(),t=[];i.api&&i.api.length&&t.push(this.testSpecificUrls(i.api,"api")),i.streaming&&i.streaming.length&&t.push(this.testSpecificUrls(i.streaming,"streaming"));const s=(await Promise.all(t)).flat();return this.updateSpeedCache(s),this.getInstances("api")},saveInstances(i,t){if(t)try{const e=localStorage.getItem(this.STORAGE_KEY);let s=e?JSON.parse(e):{api:[],streaming:[]};s[t]=i,localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s))}catch(e){console.error("Failed to save instances:",e)}else localStorage.setItem(this.STORAGE_KEY,JSON.stringify(i))}},at={STORAGE_KEY:"monochrome-recent-activity",LIMIT:10,_get(){try{const i=localStorage.getItem(this.STORAGE_KEY),t=i?JSON.parse(i):{artists:[],albums:[],playlists:[],mixes:[]};return t.playlists||(t.playlists=[]),t.mixes||(t.mixes=[]),t}catch{return{artists:[],albums:[],playlists:[],mixes:[]}}},_save(i){localStorage.setItem(this.STORAGE_KEY,JSON.stringify(i))},getRecents(){return this._get()},_add(i,t){const e=this._get();e[i]=e[i].filter(s=>s.id!==t.id),e[i].unshift(t),e[i]=e[i].slice(0,this.LIMIT),this._save(e)},addArtist(i){this._add("artists",i)},addAlbum(i){this._add("albums",i)},addPlaylist(i){this._add("playlists",i)},addMix(i){this._add("mixes",i)}},nt={STORAGE_KEY:"monochrome-theme",CUSTOM_THEME_KEY:"monochrome-custom-theme",defaultThemes:{light:{},dark:{},monochrome:{},ocean:{},purple:{},forest:{},mocha:{},machiatto:{},frappe:{},latte:{}},getTheme(){try{return localStorage.getItem(this.STORAGE_KEY)||"system"}catch{return"system"}},setTheme(i){if(localStorage.setItem(this.STORAGE_KEY,i),i==="system"){const t=window.matchMedia("(prefers-color-scheme: dark)").matches;document.documentElement.setAttribute("data-theme",t?"dark":"light")}else document.documentElement.setAttribute("data-theme",i)},getCustomTheme(){try{const i=localStorage.getItem(this.CUSTOM_THEME_KEY);return i?JSON.parse(i):null}catch{return null}},setCustomTheme(i){localStorage.setItem(this.CUSTOM_THEME_KEY,JSON.stringify(i)),this.applyCustomTheme(i)},applyCustomTheme(i){const t=document.documentElement;for(const[e,s]of Object.entries(i))t.style.setProperty(`--${e}`,s)}},Z={STORAGE_KEY:"lastfm-enabled",LOVE_ON_LIKE_KEY:"lastfm-love-on-like",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)==="true"}catch{return!1}},setEnabled(i){localStorage.setItem(this.STORAGE_KEY,i?"true":"false")},shouldLoveOnLike(){try{return localStorage.getItem(this.LOVE_ON_LIKE_KEY)==="true"}catch{return!1}},setLoveOnLike(i){localStorage.setItem(this.LOVE_ON_LIKE_KEY,i?"true":"false")}},Ht={STORAGE_KEY:"now-playing-mode",getMode(){try{return localStorage.getItem(this.STORAGE_KEY)||"cover"}catch{return"cover"}},setMode(i){localStorage.setItem(this.STORAGE_KEY,i)}},ht={DOWNLOAD_WITH_TRACKS:"lyrics-download-with-tracks",shouldDownloadLyrics(){try{return localStorage.getItem(this.DOWNLOAD_WITH_TRACKS)==="true"}catch{return!1}},setDownloadLyrics(i){localStorage.setItem(this.DOWNLOAD_WITH_TRACKS,i?"true":"false")}},ot={STORAGE_KEY:"album-background-enabled",isEnabled(){try{return localStorage.getItem(this.STORAGE_KEY)!=="false"}catch{return!0}},setEnabled(i){localStorage.setItem(this.STORAGE_KEY,i?"true":"false")}},Rt={STORAGE_KEY:"track-list-actions-mode",getMode(){try{const i=localStorage.getItem(this.STORAGE_KEY)||"dropdown";return document.documentElement.setAttribute("data-track-actions-mode",i),i}catch{return"dropdown"}},setMode(i){localStorage.setItem(this.STORAGE_KEY,i),document.documentElement.setAttribute("data-track-actions-mode",i)}},J={COMPACT_ARTIST_KEY:"card-compact-artist",COMPACT_ALBUM_KEY:"card-compact-album",isCompactArtist(){try{const i=localStorage.getItem(this.COMPACT_ARTIST_KEY);return i===null?!0:i==="true"}catch{return!0}},setCompactArtist(i){localStorage.setItem(this.COMPACT_ARTIST_KEY,i?"true":"false")},isCompactAlbum(){try{return localStorage.getItem(this.COMPACT_ALBUM_KEY)==="true"}catch{return!1}},setCompactAlbum(i){localStorage.setItem(this.COMPACT_ALBUM_KEY,i?"true":"false")}},Yt={STORAGE_KEY:"monochrome-queue",getQueue(){try{const i=localStorage.getItem(this.STORAGE_KEY);return i?JSON.parse(i):null}catch{return null}},saveQueue(i){try{const t={queue:i.queue,shuffledQueue:i.shuffledQueue,originalQueueBeforeShuffle:i.originalQueueBeforeShuffle,currentQueueIndex:i.currentQueueIndex,shuffleActive:i.shuffleActive,repeatMode:i.repeatMode};localStorage.setItem(this.STORAGE_KEY,JSON.stringify(t))}catch(t){console.warn("Failed to save queue to localStorage:",t)}}};typeof window<"u"&&window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",i=>{nt.getTheme()==="system"&&document.documentElement.setAttribute("data-theme",i.matches?"dark":"light")});class rs{constructor(){this.panel=document.getElementById("side-panel"),this.titleElement=document.getElementById("side-panel-title"),this.controlsElement=document.getElementById("side-panel-controls"),this.contentElement=document.getElementById("side-panel-content"),this.currentView=null}open(t,e,s,n){if(this.currentView===t&&this.panel.classList.contains("active")){this.close();return}this.currentView=t,this.titleElement.textContent=e,this.controlsElement.innerHTML="",this.contentElement.innerHTML="",s&&s(this.controlsElement),n&&n(this.contentElement),this.panel.classList.add("active")}close(){this.panel.classList.remove("active"),this.currentView=null,setTimeout(()=>{this.panel.classList.contains("active")||(this.controlsElement.innerHTML="",this.contentElement.innerHTML="")},300)}isActive(t){return this.currentView===t&&this.panel.classList.contains("active")}refresh(t,e,s){this.isActive(t)&&(e&&(this.controlsElement.innerHTML="",e(this.controlsElement)),s&&(this.contentElement.innerHTML="",s(this.contentElement)))}updateContent(t,e){this.isActive(t)&&(this.contentElement.innerHTML="",e(this.contentElement))}}const j=new rs;class ue{constructor(t){this.api=t,this.currentLyrics=null,this.syncedLyrics=[],this.lyricsCache=new Map,this.componentLoaded=!1,this.amLyricsElement=null,this.animationFrameId=null,this.currentTrackId=null,this.mutationObserver=null,this.romajiObserver=null,this.isRomajiMode=!1,this.originalLyricsData=null,this.kuroshiroLoaded=!1,this.kuroshiroLoading=!1,this.romajiTextCache=new Map,this.convertedTracksCache=new Set,this.originalLinesCache=new Map,this.isConverting=!1}async loadKuroshiro(){if(this.kuroshiroLoaded)return!0;if(this.kuroshiroLoading)return new Promise(t=>{const e=setInterval(()=>{this.kuroshiroLoading||(clearInterval(e),t(this.kuroshiroLoaded))},100)});this.kuroshiroLoading=!0;try{window._originalXHROpen||(window._originalXHROpen=XMLHttpRequest.prototype.open,XMLHttpRequest.prototype.open=function(s,n,...a){const r=n.toString();if(r.includes("/dict/")&&r.includes(".dat.gz")){const o=`https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/${r.split("/").pop()}`;return window._originalXHROpen.call(this,s,o,...a)}return window._originalXHROpen.call(this,s,n,...a)}),window._originalFetch||(window._originalFetch=window.fetch,window.fetch=async(s,n)=>{const a=s.toString();if(a.includes("/dict/")&&a.includes(".dat.gz")){const r=a.split("/").pop(),c=`https://cdn.jsdelivr.net/npm/kuromoji@0.1.2/dict/${r}`;return console.log(`Redirecting dict fetch: ${r} -> CDN`),window._originalFetch(c,n)}return window._originalFetch(s,n)}),window.Kuroshiro||await this.loadScript("https://unpkg.com/kuroshiro@1.2.0/dist/kuroshiro.min.js"),window.KuromojiAnalyzer||await this.loadScript("https://unpkg.com/kuroshiro-analyzer-kuromoji@1.1.0/dist/kuroshiro-analyzer-kuromoji.min.js");const t=window.Kuroshiro.default||window.Kuroshiro,e=window.KuromojiAnalyzer.default||window.KuromojiAnalyzer;return this.kuroshiro=new t,await this.kuroshiro.init(new e({dictPath:"/dict/"})),this.kuroshiroLoaded=!0,this.kuroshiroLoading=!1,console.log("✓ Kuroshiro loaded and initialized successfully"),!0}catch(t){return console.error("✗ Failed to load Kuroshiro:",t),this.kuroshiroLoaded=!1,this.kuroshiroLoading=!1,!1}}loadScript(t){return new Promise((e,s)=>{if(document.querySelector(`script[src="${t}"]`)){e();return}const n=document.createElement("script");n.src=t,n.onload=e,n.onerror=()=>s(new Error(`Failed to load script: ${t}`)),document.head.appendChild(n)})}containsJapanese(t){return t?/[\u3040-\u30FF\u31F0-\u9FFF]/.test(t):!1}async convertToRomaji(t){if(!t)return t;if(this.romajiTextCache.has(t))return this.romajiTextCache.get(t);if(!this.kuroshiroLoaded&&!await this.loadKuroshiro()||!this.kuroshiro)return console.warn("Kuroshiro not available, skipping conversion"),t;try{const e=await this.kuroshiro.convert(t,{to:"romaji",mode:"spaced",romajiSystem:"hepburn"});return this.romajiTextCache.set(t,e),e}catch(e){return console.warn("Romaji conversion failed for text:",t.substring(0,30),e),t}}setRomajiMode(t){this.isRomajiMode=t;try{localStorage.setItem("lyricsRomajiMode",t?"true":"false")}catch(e){console.warn("Failed to save Romaji mode preference:",e)}}getRomajiMode(){try{return localStorage.getItem("lyricsRomajiMode")==="true"}catch{return!1}}async ensureComponentLoaded(){if(!this.componentLoaded){if(typeof customElements<"u"&&customElements.get("am-lyrics")){this.componentLoaded=!0;return}return new Promise((t,e)=>{const s=document.createElement("script");s.type="module",s.src="https://cdn.jsdelivr.net/gh/NexiaMoe/apple-music-web-components@dev-ani/dist/src/am-lyrics.js",s.onload=()=>{typeof customElements<"u"?customElements.whenDefined("am-lyrics").then(()=>{this.componentLoaded=!0,t()}).catch(e):t()},s.onerror=()=>e(new Error("Failed to load lyrics component")),document.head.appendChild(s)})}}async fetchLyrics(t,e=null){if(e){if(this.lyricsCache.has(t))return this.lyricsCache.get(t);try{const s=Array.isArray(e.artists)?e.artists.map(l=>l.name||l).join(", "):e.artist?.name||"",n=e.title||"",a=e.album?.title||"",r=e.duration?Math.round(e.duration):null;if(!n||!s)return console.warn("Missing required fields for LRCLIB"),null;const c=new URLSearchParams({track_name:n,artist_name:s});a&&c.append("album_name",a),r&&c.append("duration",r.toString());const o=await fetch(`https://lrclib.net/api/get?${c.toString()}`);if(o.ok){const l=await o.json();if(l.syncedLyrics){const d={subtitles:l.syncedLyrics,lyricsProvider:"LRCLIB"};return this.lyricsCache.set(t,d),d}}}catch(s){console.warn("LRCLIB fetch failed:",s)}}return null}parseSyncedLyrics(t){return t?t.split(`
`).filter(s=>s.trim()).map(s=>{const n=s.match(/\[(\d+):(\d+)\.(\d+)\]\s*(.+)/);if(n){const[,a,r,c,o]=n;return{time:parseInt(a)*60+parseInt(r)+parseInt(c)/100,text:o.trim()}}return null}).filter(Boolean):[]}generateLRCContent(t,e){if(!t||!t.subtitles)return null;const s=Y(e),n=G(e);let a=`[ti:${s}]
`;return a+=`[ar:${n}]
`,a+=`[al:${e.album?.title||"Unknown Album"}]
`,a+=`[by:${t.lyricsProvider||"Unknown"}]
`,a+=`
`,a+=t.subtitles,a}downloadLRC(t,e){const s=this.generateLRCContent(t,e);if(!s){alert("No synced lyrics available for this track");return}const n=new Blob([s],{type:"application/octet-stream"}),a=URL.createObjectURL(n),r=document.createElement("a");r.href=a,r.download=At(e,"LOSSLESS").replace(/\.flac$/,".lrc"),document.body.appendChild(r),r.click(),document.body.removeChild(r),URL.revokeObjectURL(a)}getCurrentLine(t){if(!this.syncedLyrics||this.syncedLyrics.length===0)return-1;let e=-1;for(let s=0;s<this.syncedLyrics.length&&t>=this.syncedLyrics[s].time;s++)e=s;return e}extractLineText(t){const e=t.querySelectorAll(".progress-text"),s=[];return e.forEach(n=>{const a=n.textContent.trim();a&&s.push(a)}),s.join("")}replaceLineWithRomaji(t,e,s){const n=e[0]?.parentElement;if(!n)return;this.originalLinesCache.has(t)||this.originalLinesCache.set(t,n.innerHTML),this.injectRomajiStyles(t);const a=document.createElement("span");a.className="progress-text romaji-converted",a.textContent=s,n.innerHTML="",n.appendChild(a)}injectRomajiStyles(t){const e=t.getRootNode();if(e._romajiStylesInjected)return;const s=document.createElement("style");s.textContent=`
      /* Romaji converted text - base style (not active) */
      .romaji-converted {
        transition: color 0.3s ease;
        color: rgba(255, 255, 255, 0.5);
      }
      
      /* Active line - full highlight */
      div.active-line {
        color: var(--highlight-color, #93c5fd);
      }
    `,e instanceof ShadowRoot?e.appendChild(s):e.head&&e.head.appendChild(s),e._romajiStylesInjected=!0,this.setupLineStyleObserver(e)}setupLineStyleObserver(t){if(t._lineStyleObserver)return;const e=new MutationObserver(s=>{s.forEach(n=>{const a=n.target;if(!a.classList||!a.classList.contains("lyrics-line"))return;const r=a.querySelector(".romaji-converted");r&&(a.classList.contains("active-line")?(r.style.color="var(--highlight-color, #93c5fd)",r.style.setProperty("--line-progress","100%")):(r.style.color="rgba(255, 255, 255, 0.5)",r.style.setProperty("--line-progress","0%")))})});e.observe(t,{attributes:!0,attributeFilter:["class"],subtree:!0}),t._lineStyleObserver=e}restoreLineFromCache(t){const e=t.querySelector("span");if(!e)return;const s=this.originalLinesCache.get(t);s&&(e.innerHTML=s)}restoreAllLines(t){if(!t)return;(t.shadowRoot||t).querySelectorAll(".lyrics-line").forEach(n=>{this.restoreLineFromCache(n)})}setupLyricsObserver(t){if(this.stopLyricsObserver(),!t)return;const e=t.shadowRoot||t;this.romajiObserver=new MutationObserver(s=>{s.some(a=>a.type==="childList"&&a.addedNodes.length>0?!0:a.type==="characterData"&&a.target.textContent?this.containsJapanese(a.target.textContent):!1)&&(this.observerTimeout&&clearTimeout(this.observerTimeout),this.observerTimeout=setTimeout(async()=>{await this.convertLyricsContent(t)},100))}),this.romajiObserver.observe(e,{childList:!0,subtree:!0,characterData:!0,attributes:!1}),this.isRomajiMode&&this.convertLyricsContent(t)}async convertLyricsContent(t){if(!(!t||!this.isRomajiMode)&&!this.isConverting){this.isConverting=!0;try{const e=t.shadowRoot||t;if(!this.kuroshiroLoaded&&!await this.loadKuroshiro()){console.warn("Cannot convert lyrics - Kuroshiro load failed");return}const s=e.querySelectorAll(".lyrics-line");if(s.length===0)return;const n=Array.from(s).filter(a=>!a.querySelector(".romaji-converted"));if(n.length===0)return;for(const a of n){const r=a.querySelectorAll(".progress-text");if(r.length===0)continue;const c=this.extractLineText(a);if(!c||!this.containsJapanese(c))continue;const o=r[0].textContent.trim();if(!this.containsJapanese(o))continue;const l=await this.convertToRomaji(c);!l||l===c||this.replaceLineWithRomaji(a,r,l)}this.currentTrackId&&this.convertedTracksCache.add(this.currentTrackId)}finally{this.isConverting=!1}}}stopLyricsObserver(){this.romajiObserver&&(this.romajiObserver.disconnect(),this.romajiObserver=null),this.observerTimeout&&(clearTimeout(this.observerTimeout),this.observerTimeout=null)}async toggleRomajiMode(t){return this.isRomajiMode=!this.isRomajiMode,this.setRomajiMode(this.isRomajiMode),t&&(this.isRomajiMode?(t.setAttribute("romaji",""),t.romaji=!0):(t.removeAttribute("romaji"),t.romaji=!1)),this.isRomajiMode}}async function Lt(i,t,e){const s=e||new ue;!s.kuroshiroLoaded&&!s.kuroshiroLoading&&(s.getRomajiMode()?await s.loadKuroshiro():s.loadKuroshiro().catch(r=>{console.warn("Failed to load Kuroshiro for Romaji conversion:",r)}));const n=r=>{const c=s.getRomajiMode();s.isRomajiMode=c,r.innerHTML=`
            <button id="close-side-panel-btn" class="btn-icon" title="Close">
                ${It}
            </button>
            <button id="romaji-toggle-btn" class="btn-icon" title="Toggle Romaji (Japanese to Latin)" data-enabled="${c}" style="color: ${c?"var(--primary)":""}">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path>
                </svg>
            </button>
        `,r.querySelector("#close-side-panel-btn").addEventListener("click",()=>{j.close(),ft(t,j.panel)});const o=r.querySelector("#romaji-toggle-btn");if(o){const l=()=>{const d=s.isRomajiMode;o.setAttribute("data-enabled",d),o.style.color=d?"var(--primary)":""};l(),o.addEventListener("click",async()=>{const d=j.panel.querySelector("am-lyrics");d&&(await s.toggleRomajiMode(d),l())})}},a=async r=>{ft(t,j.panel),await os(r,i,t,s)};j.open("lyrics","Lyrics",n,a)}async function os(i,t,e,s){i.innerHTML='<div class="lyrics-loading">Loading lyrics...</div>';try{await s.ensureComponentLoaded(),s.isRomajiMode=s.getRomajiMode(),s.currentTrackId=t.id;const n=t.title,a=G(t),r=t.album?.title,c=t.duration?Math.round(t.duration*1e3):void 0,o=t.isrc||"";i.innerHTML="";const l=document.createElement("am-lyrics");l.setAttribute("song-title",n),l.setAttribute("song-artist",a),r&&l.setAttribute("song-album",r),c&&l.setAttribute("song-duration",c),l.setAttribute("query",`${n} ${a}`.trim()),o&&l.setAttribute("isrc",o),l.setAttribute("highlight-color","#93c5fd"),l.setAttribute("hover-background-color","rgba(59, 130, 246, 0.14)"),l.setAttribute("autoscroll",""),l.setAttribute("interpolate",""),s.getRomajiMode()&&l.setAttribute("romaji",""),l.style.height="100%",l.style.width="100%",i.appendChild(l),s.setupLyricsObserver(l),s.isRomajiMode&&!s.kuroshiroLoaded&&await s.loadKuroshiro(),await new Promise(u=>{const h=()=>l.querySelector(".lyric-line, [class*='lyric']")||l.shadowRoot&&l.shadowRoot.querySelector("[class*='lyric']")||l.textContent&&l.textContent.length>50;if(h()){u();return}let f=0;const p=25,g=setInterval(()=>{f++,(h()||f>=p)&&(clearInterval(g),u())},200)}),s.isRomajiMode&&(await s.convertLyricsContent(l),setTimeout(()=>s.convertLyricsContent(l),500));const m=ls(t,e,l);return i.lyricsCleanup=m,i.lyricsManager=s,l}catch(n){return console.error("Failed to load lyrics:",n),i.innerHTML='<div class="lyrics-error">Failed to load lyrics</div>',null}}function ls(i,t,e){let s=0,n=performance.now(),a=null;const r=()=>{const m=t.currentTime*1e3;s=m,n=performance.now(),e.currentTime=m},c=()=>{if(!t.paused){const u=performance.now()-n,h=s+u;e.currentTime=h,a=requestAnimationFrame(c)}},o=()=>{s=t.currentTime*1e3,n=performance.now(),c()},l=()=>{a&&(cancelAnimationFrame(a),a=null)},d=m=>{m.detail&&m.detail.timestamp&&(t.currentTime=m.detail.timestamp/1e3,t.play())};return t.addEventListener("timeupdate",r),t.addEventListener("play",o),t.addEventListener("pause",l),t.addEventListener("seeked",r),e.addEventListener("line-click",d),t.paused||c(),()=>{a&&cancelAnimationFrame(a),t.removeEventListener("timeupdate",r),t.removeEventListener("play",o),t.removeEventListener("pause",l),t.removeEventListener("seeked",r),e.removeEventListener("line-click",d)}}function ft(i,t){t&&t.lyricsCleanup&&(t.lyricsCleanup(),t.lyricsCleanup=null),t&&t.lyricsManager&&t.lyricsManager.stopLyricsObserver()}class me{constructor(){this.dbName="MonochromeDB",this.version=5,this.db=null}async open(){return this.db?this.db:new Promise((t,e)=>{const s=indexedDB.open(this.dbName,this.version);s.onerror=n=>{console.error("Database error:",n.target.error),e(n.target.error)},s.onsuccess=n=>{this.db=n.target.result,t(this.db)},s.onupgradeneeded=n=>{const a=n.target.result;a.objectStoreNames.contains("favorites_tracks")||a.createObjectStore("favorites_tracks",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),a.objectStoreNames.contains("favorites_albums")||a.createObjectStore("favorites_albums",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),a.objectStoreNames.contains("favorites_artists")||a.createObjectStore("favorites_artists",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),a.objectStoreNames.contains("favorites_playlists")||a.createObjectStore("favorites_playlists",{keyPath:"uuid"}).createIndex("addedAt","addedAt",{unique:!1}),a.objectStoreNames.contains("favorites_mixes")||a.createObjectStore("favorites_mixes",{keyPath:"id"}).createIndex("addedAt","addedAt",{unique:!1}),a.objectStoreNames.contains("history_tracks")||a.createObjectStore("history_tracks",{keyPath:"timestamp"}).createIndex("timestamp","timestamp",{unique:!0}),a.objectStoreNames.contains("user_playlists")||a.createObjectStore("user_playlists",{keyPath:"id"}).createIndex("createdAt","createdAt",{unique:!1})}})}async performTransaction(t,e,s){const n=await this.open();return new Promise((a,r)=>{const c=n.transaction(t,e),o=c.objectStore(t),l=s(o);c.oncomplete=()=>{a(l?.result)},c.onerror=d=>{r(d.target.error)}})}async addToHistory(t){const e="history_tracks",n={...this._minifyItem("track",t),timestamp:Date.now()};return(await this.open()).transaction(e,"readwrite").objectStore(e).put(n),n}async getHistory(){const t="history_tracks",e=await this.open();return new Promise((s,n)=>{const o=e.transaction(t,"readonly").objectStore(t).index("timestamp").getAll();o.onsuccess=()=>{s(o.result.reverse())},o.onerror=()=>n(o.error)})}async toggleFavorite(t,e){const n=`favorites_${t==="mix"?"mixes":`${t}s`}`,a=t==="playlist"?e.uuid:e.id;if(await this.isFavorite(t,a))return await this.performTransaction(n,"readwrite",c=>c.delete(a)),!1;{const o={...this._minifyItem(t,e),addedAt:Date.now()};return await this.performTransaction(n,"readwrite",l=>l.put(o)),!0}}async isFavorite(t,e){const n=`favorites_${t==="mix"?"mixes":`${t}s`}`;try{return!!await this.performTransaction(n,"readonly",r=>r.get(e))}catch{return!1}}async getFavorites(t){const s=`favorites_${t==="mix"?"mixes":`${t}s`}`,n=await this.open();return new Promise((a,r)=>{const d=n.transaction(s,"readonly").objectStore(s).index("addedAt").getAll();d.onsuccess=()=>{a(d.result.reverse())},d.onerror=()=>r(d.error)})}_minifyItem(t,e){if(!e)return e;const s={id:e.id,addedAt:e.addedAt||null};return t==="track"?{...s,title:e.title,duration:e.duration,explicit:e.explicit,artists:e.artists?.map(n=>({id:n.id,name:n.name}))||[],album:e.album?{id:e.album.id,cover:e.album.cover,releaseDate:e.album.releaseDate||null,vibrantColor:e.album.vibrantColor||null}:null,streamStartDate:e.streamStartDate||null,version:e.version||null}:t==="album"?{...s,title:e.title,cover:e.cover,releaseDate:e.releaseDate||null,explicit:e.explicit,artist:e.artist?{name:e.artist.name,id:e.artist.id}:e.artists?.[0]?{name:e.artists[0].name,id:e.artists[0].id}:null,type:e.type||null,numberOfTracks:e.numberOfTracks}:t==="artist"?{...s,name:e.name,picture:e.picture||e.image||null}:t==="playlist"?{uuid:e.uuid||e.id,addedAt:e.addedAt||e.createdAt||null,title:e.title||e.name,image:e.image||e.squareImage||e.cover||null,numberOfTracks:e.numberOfTracks||(e.tracks?e.tracks.length:0),user:e.user?{name:e.user.name}:null}:t==="mix"?{id:e.id,addedAt:e.addedAt,title:e.title,subTitle:e.subTitle,description:e.description,mixType:e.mixType,cover:e.cover}:e}async exportData(){const t=await this.getFavorites("track"),e=await this.getFavorites("album"),s=await this.getFavorites("artist"),n=await this.getFavorites("playlist"),a=await this.getFavorites("mix"),r=await this.getHistory(),c=await this.getPlaylists();return{favorites_tracks:t.map(l=>this._minifyItem("track",l)),favorites_albums:e.map(l=>this._minifyItem("album",l)),favorites_artists:s.map(l=>this._minifyItem("artist",l)),favorites_playlists:n.map(l=>this._minifyItem("playlist",l)),favorites_mixes:a.map(l=>this._minifyItem("mix",l)),history_tracks:r.map(l=>this._minifyItem("track",l)),user_playlists:c}}async importData(t,e=!1){const s=await this.open(),n=async(a,r)=>{if(r===void 0)return;const o=s.transaction(a,"readwrite").objectStore(a);e&&o.clear();for(const l of r)o.put(l)};await n("favorites_tracks",t.favorites_tracks),await n("favorites_albums",t.favorites_albums),await n("favorites_artists",t.favorites_artists),await n("favorites_playlists",t.favorites_playlists),await n("favorites_mixes",t.favorites_mixes),await n("history_tracks",t.history_tracks),t.user_playlists&&await n("user_playlists",t.user_playlists)}async createPlaylist(t,e=[],s=""){const a={id:crypto.randomUUID(),name:t,tracks:e.map(r=>this._minifyItem("track",r)),cover:s,createdAt:Date.now()};return await this.performTransaction("user_playlists","readwrite",r=>r.put(a)),a}async addTrackToPlaylist(t,e){const s=await this.performTransaction("user_playlists","readonly",a=>a.get(t));if(!s)throw new Error("Playlist not found");s.tracks=s.tracks||[];const n=this._minifyItem("track",e);if(!s.tracks.some(a=>a.id===e.id))return s.tracks.push(n),await this.performTransaction("user_playlists","readwrite",a=>a.put(s)),s}async removeTrackFromPlaylist(t,e){const s=await this.performTransaction("user_playlists","readonly",n=>n.get(t));if(!s)throw new Error("Playlist not found");return s.tracks=s.tracks||[],s.tracks=s.tracks.filter(n=>n.id!==e),await this.performTransaction("user_playlists","readwrite",n=>n.put(s)),s}async deletePlaylist(t){await this.performTransaction("user_playlists","readwrite",e=>e.delete(t))}async getPlaylist(t){return await this.performTransaction("user_playlists","readonly",e=>e.get(t))}async getPlaylists(){const t=await this.open();return new Promise((e,s)=>{const c=t.transaction("user_playlists","readonly").objectStore("user_playlists").index("createdAt").getAll();c.onsuccess=()=>{e(c.result.reverse())},c.onerror=()=>s(c.error)})}async updatePlaylistName(t,e){const s=await this.performTransaction("user_playlists","readonly",n=>n.get(t));if(!s)throw new Error("Playlist not found");return s.name=e,await this.performTransaction("user_playlists","readwrite",n=>n.put(s)),s}}const A=new me,cs=Object.freeze(Object.defineProperty({__proto__:null,MusicDatabase:me,db:A},Symbol.toStringTag,{value:"Module"}));function Gt(i,t,e){i/=255,t/=255,e/=255;const s=Math.max(i,t,e),n=Math.min(i,t,e);let a,r,c=(s+n)/2;if(s===n)a=r=0;else{const o=s-n;switch(r=c>.5?o/(2-s-n):o/(s+n),s){case i:a=(t-e)/o+(t<e?6:0);break;case t:a=(e-i)/o+2;break;case e:a=(i-t)/o+4;break}a/=6}return[a,r,c]}function ds(i,t,e){let s,n,a;if(t===0)s=n=a=e;else{const c=(d,m,u)=>(u<0&&(u+=1),u>1&&(u-=1),u<.16666666666666666?d+(m-d)*6*u:u<.5?m:u<.6666666666666666?d+(m-d)*(.6666666666666666-u)*6:d),o=e<.5?e*(1+t):e+t-e*t,l=2*e-o;s=c(l,o,i+1/3),n=c(l,o,i),a=c(l,o,i-1/3)}const r=c=>{const o=Math.round(c*255).toString(16);return o.length===1?"0"+o:o};return`#${r(s)}${r(n)}${r(a)}`}function us(i){const t=document.createElement("canvas"),e=t.getContext("2d");if(!e)return null;t.width=i.naturalWidth||i.width,t.height=i.naturalHeight||i.height;try{e.drawImage(i,0,0);const n=64;if(t.width>n||t.height>n){const o=Math.min(n/t.width,n/t.height),l=Math.floor(t.width*o),d=Math.floor(t.height*o),m=document.createElement("canvas");m.width=l,m.height=d,m.getContext("2d").drawImage(i,0,0,l,d),e.drawImage(m,0,0,t.width,t.height);var s=m.getContext("2d").getImageData(0,0,l,d)}else var s=e.getImageData(0,0,t.width,t.height);const a=s.data,r=[];for(let o=0;o<a.length;o+=4){const l=a[o],d=a[o+1],m=a[o+2];if(a[o+3]<125)continue;const[h,f,p]=Gt(l,d,m);f>=.3&&p>=.3&&p<=.8&&r.push({r:l,g:d,b:m,h,s:f,l:p})}if(r.length===0)for(let o=0;o<a.length;o+=4){const l=a[o],d=a[o+1],m=a[o+2];if(a[o+3]<125)continue;const[h,f,p]=Gt(l,d,m);p>.1&&p<.95&&r.push({r:l,g:d,b:m,h,s:f,l:p})}if(r.length===0)return null;r.sort((o,l)=>l.s-o.s||.5-Math.abs(o.l-.5)-(.5-Math.abs(l.l-.5)));const c=r[0];return ds(c.h,c.s,c.l)}catch(n){throw n}}let Ft=null,K=null,tt=null,he=null;const pt="monochrome-firebase-config",ms={apiKey:"AIzaSyDPU-unAjuLtQJt4IkGS5faG50UCF7lYyA",authDomain:"monochrome-database.firebaseapp.com",projectId:"monochrome-database",storageBucket:"monochrome-database.firebasestorage.app",messagingSenderId:"895657412760",appId:"1:895657412760:web:e81c5044c7f4e9b799e8ed"};function hs(){try{const i=localStorage.getItem(pt);return i?JSON.parse(i):null}catch(i){return console.warn("Failed to parse Firebase config from storage",i),null}}const fe=hs(),Vt=fe||ms;if(Vt)try{Ft=ve(Vt),K=ke(Ft),tt=Ae(Ft),he=new Te,console.log("Firebase initialized from "+(fe?"saved":"default")+" config")}catch(i){console.error("Error initializing Firebase:",i)}else console.log("No Firebase config found.");function pe(i){i&&localStorage.setItem(pt,JSON.stringify(i))}function fs(){localStorage.removeItem(pt)}function ps(i){if(!i)return null;try{const t=JSON.stringify(i),e=btoa(t),s=new URL(window.location.href);return s.hash=`#setup_firebase=${e}`,s.toString()}catch(t){return console.error("Failed to generate share link:",t),null}}function gs(){const i=window.location.hash;if(!i.startsWith("#setup_firebase="))return!1;const t=i.split("#setup_firebase=")[1];if(!t)return!1;try{const e=atob(t),s=JSON.parse(e);if(!s.apiKey||!s.authDomain)return alert("The shared configuration link appears to be invalid."),!1;if(confirm("A Firebase configuration was detected in the link. Do you want to import it and enable Sync?"))return pe(s),window.history.replaceState(null,null,window.location.pathname),alert("Configuration imported successfully! The app will now reload."),window.location.reload(),!0;window.history.replaceState(null,null,window.location.pathname+"#settings")}catch(e){console.error("Failed to parse shared config:",e),alert("Failed to read configuration from link. The link might be corrupted.")}return!1}function ys(){gs();const i=document.getElementById("firebase-config-input"),t=document.getElementById("save-firebase-config-btn"),e=document.getElementById("clear-firebase-config-btn"),s=document.getElementById("share-firebase-config-btn"),n=document.getElementById("toggle-firebase-config-btn"),a=document.getElementById("custom-firebase-config-container");if(n&&a&&n.addEventListener("click",()=>{a.classList.contains("visible")?(a.classList.remove("visible"),n.textContent="Custom Configuration"):(a.classList.add("visible"),n.textContent="Hide Custom Configuration")}),i){const r=localStorage.getItem(pt);if(r)try{i.value=JSON.stringify(JSON.parse(r),null,2),a&&n&&(a.classList.add("visible"),n.textContent="Hide Custom Configuration")}catch{i.value=r}}s&&s.addEventListener("click",()=>{const r=localStorage.getItem(pt);if(!r){alert("No configuration saved to share.");return}try{const c=JSON.parse(r),o=ps(c);o&&navigator.clipboard.writeText(o).then(()=>{alert("Magic Link copied to clipboard! Send it to your other device.")}).catch(l=>{console.error("Clipboard error:",l),prompt("Copy this link:",o)})}catch{alert("Invalid configuration found.")}}),t&&t.addEventListener("click",()=>{const r=i.value.trim();if(!r){alert("Please enter a valid configuration.");return}try{let c=r;c.includes("=")&&(c=c.substring(c.indexOf("=")+1)),c=c.trim(),c.endsWith(";")&&(c=c.slice(0,-1));const o=c.replace(/([{,]\s*)([a-zA-Z0-9_]+)\s*:/g,'$1"$2":').replace(/:\s*'([^']*)'/g,': "$1"').replace(/,\s*([}\]])/g,"$1"),l=JSON.parse(o);pe(l),alert("Configuration saved. Reloading..."),window.location.reload()}catch(c){console.error("Invalid Config:",c),alert("Could not parse configuration. Please ensure it looks like a valid JSON or JS object.")}}),e&&e.addEventListener("click",()=>{confirm("Are you sure you want to remove the custom configuration? The app will revert to the shared default database.")&&(fs(),window.location.reload())})}class bs{constructor(){this.user=null,this.userRef=null,this.unsubscribeFunctions=[],this.isSyncing=!1}initialize(t){!tt||!t||(this.user=t,this.userRef=wt(tt,`users/${t.uid}`),console.log("Initializing SyncManager for user:",t.uid),this.performInitialSync())}disconnect(){this.userRef&&(this.unsubscribeFunctions.forEach(t=>t()),this.unsubscribeFunctions=[]),this.user=null,this.userRef=null,console.log("SyncManager disconnected")}async performInitialSync(){if(!this.isSyncing){this.isSyncing=!0;try{console.log("Starting initial sync...");const e=(await qt(this.userRef)).val()||{},s=await A.exportData(),n=this.mergeData(s,e);await Ce(this.userRef,n);const a={favorites_tracks:n.library?.tracks?Object.values(n.library.tracks):[],favorites_albums:n.library?.albums?Object.values(n.library.albums):[],favorites_artists:n.library?.artists?Object.values(n.library.artists):[],favorites_playlists:n.library?.playlists?Object.values(n.library.playlists):[],history_tracks:n.history?.recentTracks?Object.values(n.history.recentTracks):[],user_playlists:n.user_playlists?Object.values(n.user_playlists):[]};await A.importData(a,!0),console.log("Initial sync complete."),this.setupListeners()}catch(t){console.error("Initial sync failed:",t)}finally{this.isSyncing=!1}}}mergeData(t,e){const s=(a,r,c="id")=>{const o=new Map;return Array.isArray(a)?a.forEach(l=>o.set(l[c],l)):a&&typeof a=="object"&&Object.values(a).forEach(l=>o.set(l[c],l)),r&&(Array.isArray(r)?r.forEach(l=>o.set(l[c],l)):Object.keys(r).forEach(l=>{const d=r[l];typeof d=="object"&&o.set(d[c]||l,d)})),Array.from(o.values())};return{library:{tracks:this.arrayToObject(s(t.favorites_tracks,e.library?.tracks),"id"),albums:this.arrayToObject(s(t.favorites_albums,e.library?.albums),"id"),artists:this.arrayToObject(s(t.favorites_artists,e.library?.artists),"id"),playlists:this.arrayToObject(s(t.favorites_playlists,e.library?.playlists,"uuid"),"uuid")},history:{recentTracks:this.arrayToObject(s(t.history_tracks,e.history?.recentTracks,"timestamp"),"timestamp")},user_playlists:this.arrayToObject(s(t.user_playlists,e.user_playlists),"id"),lastUpdated:Date.now()}}arrayToObject(t,e){const s={};return t.forEach(n=>{n&&n[e]&&(s[n[e]]=n)}),s}setupListeners(){const t=it(this.userRef,"library"),e=Bt(t,c=>{if(this.isSyncing)return;const o=c.val();if(o){const l={favorites_tracks:o.tracks?Object.values(o.tracks):[],favorites_albums:o.albums?Object.values(o.albums):[],favorites_artists:o.artists?Object.values(o.artists):[],favorites_playlists:o.playlists?Object.values(o.playlists):[]};A.importData(l,!0).then(()=>{window.dispatchEvent(new Event("library-changed"))})}});this.unsubscribeFunctions.push(()=>$t(t,"value",e));const s=it(this.userRef,"history/recentTracks"),n=Bt(s,c=>{if(this.isSyncing)return;const o=c.val();if(o){const l={history_tracks:Object.values(o)};A.importData(l,!0).then(()=>{window.dispatchEvent(new Event("history-changed"))})}});this.unsubscribeFunctions.push(()=>$t(s,"value",n));const a=it(this.userRef,"user_playlists"),r=Bt(a,c=>{if(this.isSyncing)return;const o=c.val();if(o){const l={user_playlists:Object.values(o)};A.importData(l,!0).then(()=>{window.dispatchEvent(new Event("library-changed"))})}});this.unsubscribeFunctions.push(()=>$t(a,"value",r))}async syncLibraryItem(t,e,s){if(!this.user||!this.userRef)return;const a={track:"tracks",album:"albums",artist:"artists",playlist:"playlists"}[t];if(!a)return;const r=t==="playlist"?e.uuid:e.id,c=`library/${a}/${r}`,o=it(this.userRef,c);if(s){const l=A._minifyItem(t,e),d={...l,addedAt:e.addedAt||l.addedAt||Date.now()};await vt(o,d)}else await kt(o)}async syncHistoryItem(t){if(!this.user||!this.userRef||!t.timestamp)return;const e=it(this.userRef,`history/recentTracks/${t.timestamp}`);try{await vt(e,t)}catch(s){console.error("Failed to sync history item:",s)}}async syncUserPlaylist(t,e){if(!this.user||!this.userRef)return;const n=`user_playlists/${t.id}`,a=it(this.userRef,n);e==="create"||e==="update"?await vt(a,t):e==="delete"&&await kt(a)}async clearCloudData(){if(!this.user||!this.userRef)throw new Error("Not authenticated");await kt(this.userRef)}async publishPlaylist(t){if(!this.user)throw new Error("Not authenticated");const e=A._minifyItem("playlist",t),s=t.id||t.uuid;if(!s)throw new Error("Invalid playlist ID");const n={...e,uid:this.user.uid,originalId:s,publishedAt:Date.now(),tracks:t.tracks?t.tracks.map(r=>A._minifyItem("track",r)):[]},a=wt(tt,`public_playlists/${s}`);await vt(a,n)}async unpublishPlaylist(t){if(!this.user)throw new Error("Not authenticated");const e=wt(tt,`public_playlists/${t}`);await kt(e)}async getPublicPlaylist(t){if(!tt)return console.warn("[Sync] Database not initialized, cannot fetch public playlist"),null;try{const e=wt(tt,`public_playlists/${t}`),s=await qt(e);if(!s.exists())return console.warn(`[Sync] Public playlist ${t} not found in database.`),null;const n=s.val();return console.log(`[Sync] Public playlist fetch for ${t}: Found`),n}catch(e){return console.error("[Sync] Failed to fetch public playlist:",e),null}}}const q=new bs;class ws{constructor(t,e){this.api=t,this.player=e,this.currentTrack=null,this.searchAbortController=null,this.vibrantColorCache=new Map}createHeartIcon(t=!1){return t?Qt.replace('class="heart-icon"','class="heart-icon filled"'):Qt}async extractAndApplyColor(t){if(!ot.isEnabled()||!t){this.resetVibrantColor();return}if(this.vibrantColorCache.has(t)){const n=this.vibrantColorCache.get(t);if(n){this.setVibrantColor(n);return}}const e=new Image;e.crossOrigin="Anonymous";const s=t.includes("?")?"&":"?";e.src=`${t}${s}not-from-cache-please`,e.onload=()=>{try{const n=us(e);n?(this.vibrantColorCache.set(t,n),this.setVibrantColor(n)):(this.vibrantColorCache.set(t,null),this.resetVibrantColor())}catch{this.vibrantColorCache.set(t,null),this.resetVibrantColor()}},e.onerror=()=>{this.vibrantColorCache.set(t,null),this.resetVibrantColor()}}async updateLikeState(t,e,s){const n=await A.isFavorite(e,s),a=t.querySelector(".like-btn");a&&(a.innerHTML=this.createHeartIcon(n),a.classList.toggle("active",n),a.title=n?"Remove from Liked":"Add to Liked")}setCurrentTrack(t){this.currentTrack=t,this.updateGlobalTheme();const e=document.getElementById("now-playing-like-btn"),s=document.getElementById("now-playing-add-playlist-btn"),n=document.getElementById("mobile-add-playlist-btn"),a=document.getElementById("toggle-lyrics-btn");t?(e&&(e.style.display="flex",this.updateLikeState(e.parentElement,"track",t.id)),s&&s.style.removeProperty("display"),n&&n.style.removeProperty("display"),a&&a.style.removeProperty("display")):(e&&(e.style.display="none"),s&&s.style.setProperty("display","none","important"),n&&n.style.setProperty("display","none","important"),a&&(a.style.display="none"))}updateGlobalTheme(){document.getElementById("page-album").classList.contains("active")||(ot.isEnabled()&&this.currentTrack?.album?.cover?this.extractAndApplyColor(this.api.getCoverUrl(this.currentTrack.album.cover,"80")):this.resetVibrantColor())}createExplicitBadge(){return'<span class="explicit-badge" title="Explicit">E</span>'}adjustTitleFontSize(t,e){t.classList.remove("long-title","very-long-title"),e.length>40?t.classList.add("very-long-title"):e.length>25&&t.classList.add("long-title")}createTrackItemHTML(t,e,s=!1,n=!1){const a=s?`<img src="${this.api.getCoverUrl(t.album?.cover)}" alt="Track Cover" class="track-item-cover" loading="lazy">`:"";let r;n&&!s?r=`${t.volumeNumber??t.discNumber??1}-${t.trackNumber}`:r=e+1;const c=`<div class="track-number">${s?a:r}</div>`,o=Pt(t)?this.createExplicitBadge():"",l=G(t),d=Y(t),m=this.player?.currentTrack?.id===t.id;let u="";const h=t.album?.releaseDate||t.streamStartDate;if(h){const p=new Date(h);isNaN(p.getTime())||(u=` • ${p.getFullYear()}`)}const f=`
            <div class="track-actions-inline">
                <button class="track-action-btn like-btn" data-action="toggle-like" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
                <button class="track-action-btn" data-action="play-next" title="Play Next">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 6h6" />
                        <path d="M5 3v6" />
                        <path d="M11 6h10" />
                        <path d="M3 12h18" />
                        <path d="M3 18h18" />
                    </svg>
                </button>
                <button class="track-action-btn" data-action="add-to-queue" title="Add to Queue">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18" />
                        <path d="M3 12h18" />
                        <path d="M3 18h10" />
                        <path d="M16 18h6" />
                        <path d="M19 15v6" />
                    </svg>
                </button>
                <button class="track-action-btn" data-action="download" title="Download">
                    ${ct}
                </button>
            </div>
            <button class="track-menu-btn" type="button" title="More options">
                ${He}
            </button>
        `;return`
            <div class="track-item ${m?"playing":""}" data-track-id="${t.id}">
                ${c}
                <div class="track-item-info">
                    <div class="track-item-details">
                        <div class="title">
                            ${V(d)}
                            ${o}
                        </div>
                        <div class="artist">${V(l)}${u}</div>
                    </div>
                </div>
                <div class="track-item-duration">${mt(t.duration)}</div>
                <div class="track-item-actions">
                    ${f}
                </div>
            </div>
        `}createBaseCardHTML({type:t,id:e,href:s,title:n,subtitle:a,imageHTML:r,actionButtonsHTML:c,isCompact:o,extraClasses:l=""}){const d=t!=="artist"?`
            <button class="play-btn card-play-btn" data-action="play-card" data-type="${t}" data-id="${e}" title="Play">
                ${st}
            </button>
        `:"",m=t==="artist"?`<h4 class="card-title">${n}</h4>`:`<div class="card-info">
                    <h4 class="card-title">${n}</h4>
                    <p class="card-subtitle">${a}</p>
               </div>`;return`
            <div class="card ${l} ${o?"compact":""}" data-${t}-id="${e}" data-href="${s}" style="cursor: pointer;">
                <div class="card-image-wrapper">
                    ${r}
                    ${c}
                    ${o?"":d}
                </div>
                ${m}
                ${o?d:""}
            </div>
        `}createPlaylistCardHTML(t){const e=t.squareImage||t.image||t.uuid,s=J.isCompactAlbum();return this.createBaseCardHTML({type:"playlist",id:t.uuid,href:`#playlist/${t.uuid}`,title:t.title,subtitle:`${t.numberOfTracks||0} tracks`,imageHTML:`<img src="${this.api.getCoverUrl(e)}" alt="${t.title}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="playlist" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:s})}createMixCardHTML(t){const e=t.cover||"assets/appicon.png",s=t.subTitle||t.description||"",n=J.isCompactAlbum();return this.createBaseCardHTML({type:"mix",id:t.id,href:`#mix/${t.id}`,title:t.title,subtitle:s,imageHTML:`<img src="${e}" alt="${t.title}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="mix" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:n})}createUserPlaylistCardHTML(t){let e="";if(t.cover)e=`<img src="${t.cover}" alt="${t.name}" class="card-image" loading="lazy">`;else{const n=t.tracks||[];let a=t.images||[];const r=new Set(a);if(a.length===0)for(const c of n){const o=c.album?.cover;if(o&&!r.has(o)&&(r.add(o),a.push(o),a.length>=4))break}if(a.length>=2){const c=Math.min(a.length,4),o=c<4?`items-${c}`:"",l=a.slice(0,4);e=`
                    <div class="card-image card-collage ${o}">
                        ${l.map(d=>`<img src="${this.api.getCoverUrl(d)}" alt="" loading="lazy">`).join("")}
                    </div>
                `}else a.length>0?e=`<img src="${this.api.getCoverUrl(a[0])}" alt="${t.name}" class="card-image" loading="lazy">`:e=`<img src="assets/appicon.png" alt="${t.name}" class="card-image" loading="lazy">`}const s=J.isCompactAlbum();return this.createBaseCardHTML({type:"user-playlist",id:t.id,href:`#userplaylist/${t.id}`,title:V(t.name),subtitle:`${t.tracks?t.tracks.length:t.numberOfTracks||0} tracks`,imageHTML:e,actionButtonsHTML:`
                <button class="edit-playlist-btn" data-action="edit-playlist" title="Edit Playlist">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                    </svg>
                </button>
                <button class="delete-playlist-btn" data-action="delete-playlist" title="Delete Playlist">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 6h18"/>
                        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/>
                        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/>
                        <line x1="10" y1="11" x2="10" y2="17"/>
                        <line x1="14" y1="11" x2="14" y2="17"/>
                    </svg>
                </button>
            `,isCompact:s,extraClasses:"user-playlist"})}createAlbumCardHTML(t){const e=Pt(t)?this.createExplicitBadge():"";let s="";if(t.releaseDate){const r=new Date(t.releaseDate);isNaN(r.getTime())||(s=`${r.getFullYear()}`)}let n="";t.type==="EP"?n=" • EP":t.type==="SINGLE"&&(n=" • Single");const a=J.isCompactAlbum();return this.createBaseCardHTML({type:"album",id:t.id,href:`#album/${t.id}`,title:`${V(t.title)} ${e}`,subtitle:`${V(t.artist?.name??"")} • ${s}${n}`,imageHTML:`<img src="${this.api.getCoverUrl(t.cover)}" alt="${V(t.title)}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="album" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:a})}createArtistCardHTML(t){const e=J.isCompactArtist();return this.createBaseCardHTML({type:"artist",id:t.id,href:`#artist/${t.id}`,title:V(t.name),subtitle:"",imageHTML:`<img src="${this.api.getArtistPictureUrl(t.picture)}" alt="${V(t.name)}" class="card-image" loading="lazy">`,actionButtonsHTML:`
                <button class="like-btn card-like-btn" data-action="toggle-like" data-type="artist" title="Add to Liked">
                    ${this.createHeartIcon(!1)}
                </button>
            `,isCompact:e,extraClasses:"artist"})}createSkeletonTrack(t=!1){return`
            <div class="skeleton-track">
                ${t?'<div class="skeleton skeleton-track-cover"></div>':'<div class="skeleton skeleton-track-number"></div>'}
                <div class="skeleton-track-info">
                    <div class="skeleton-track-details">
                        <div class="skeleton skeleton-track-title"></div>
                        <div class="skeleton skeleton-track-artist"></div>
                    </div>
                </div>
                <div class="skeleton skeleton-track-duration"></div>
            </div>
        `}createSkeletonCard(t=!1){return`
            <div class="skeleton-card ${t?"artist":""}">
                <div class="skeleton skeleton-card-image"></div>
                <div class="skeleton skeleton-card-title"></div>
                ${t?"":'<div class="skeleton skeleton-card-subtitle"></div>'}
            </div>
        `}createSkeletonTracks(t=5,e=!1){return`<div class="skeleton-container">${Array(t).fill(0).map(()=>this.createSkeletonTrack(e)).join("")}</div>`}createSkeletonCards(t=6,e=!1){return`<div class="card-grid">${Array(t).fill(0).map(()=>this.createSkeletonCard(e)).join("")}</div>`}renderListWithTracks(t,e,s){const n=document.createDocumentFragment(),a=document.createElement("div"),r=e.some(c=>(c.volumeNumber||c.discNumber||1)>1);for(a.innerHTML=e.map((c,o)=>this.createTrackItemHTML(c,o,s,r)).join("");a.firstChild;)n.appendChild(a.firstChild);t.innerHTML="",t.appendChild(n),e.forEach(c=>{const o=t.querySelector(`[data-track-id="${c.id}"]`);o&&(R.set(o,c),this.updateLikeState(o,"track",c.id))})}setPageBackground(t){const e=document.getElementById("page-background");ot.isEnabled()&&t?(e.style.backgroundImage=`url('${t}')`,e.classList.add("active"),document.body.classList.add("has-page-background")):(e.classList.remove("active"),document.body.classList.remove("has-page-background"),setTimeout(()=>{e.classList.contains("active")||(e.style.backgroundImage="")},500))}setVibrantColor(t){if(!t)return;const e=document.documentElement,n=e.getAttribute("data-theme")==="light";let a=t.replace("#","");a.length===3&&(a=a.split("").map(h=>h+h).join(""));let r=parseInt(a.substr(0,2),16),c=parseInt(a.substr(2,2),16),o=parseInt(a.substr(4,2),16),l=(r*299+c*587+o*114)/1e3;if(n)for(;l>150;)r=Math.floor(r*.9),c=Math.floor(c*.9),o=Math.floor(o*.9),l=(r*299+c*587+o*114)/1e3;else for(;l<80&&(r=Math.min(255,Math.max(r+1,Math.floor(r*1.15))),c=Math.min(255,Math.max(c+1,Math.floor(c*1.15))),o=Math.min(255,Math.max(o+1,Math.floor(o*1.15))),l=(r*299+c*587+o*114)/1e3,!(r>=255&&c>=255&&o>=255)););const d=`#${r.toString(16).padStart(2,"0")}${c.toString(16).padStart(2,"0")}${o.toString(16).padStart(2,"0")}`,m=l>128?"#000000":"#ffffff";e.style.setProperty("--primary",d),e.style.setProperty("--primary-foreground",m),e.style.setProperty("--highlight",d),e.style.setProperty("--highlight-rgb",`${r}, ${c}, ${o}`),e.style.setProperty("--active-highlight",d),e.style.setProperty("--ring",d);let u;if(l>200){const h=Math.floor(r*.85),f=Math.floor(c*.85),p=Math.floor(o*.85);u=`rgba(${h}, ${f}, ${p}, 0.25)`}else u=`rgba(${r}, ${c}, ${o}, 0.15)`;e.style.setProperty("--track-hover-bg",u)}resetVibrantColor(){const t=document.documentElement;t.style.removeProperty("--primary"),t.style.removeProperty("--primary-foreground"),t.style.removeProperty("--highlight"),t.style.removeProperty("--highlight-rgb"),t.style.removeProperty("--active-highlight"),t.style.removeProperty("--ring"),t.style.removeProperty("--track-hover-bg")}async showFullscreenCover(t,e,s,n){if(!t)return;const a=document.getElementById("fullscreen-cover-overlay"),r=document.getElementById("fullscreen-cover-image"),c=document.getElementById("fullscreen-track-title"),o=document.getElementById("fullscreen-track-artist"),l=document.getElementById("fullscreen-next-track");document.getElementById("fullscreen-lyrics-container");const d=document.getElementById("toggle-fullscreen-lyrics-btn"),m=this.api.getCoverUrl(t.album?.cover,"1280");if(r.src=m,c.textContent=t.title,o.textContent=G(t),e?(l.style.display="flex",l.querySelector(".value").textContent=`${e.title} • ${G(e)}`,l.classList.remove("animate-in"),l.offsetWidth,l.classList.add("animate-in")):(l.style.display="none",l.classList.remove("animate-in")),a.style.setProperty("--bg-image",`url('${m}')`),s&&n){d.style.display="flex",d.classList.remove("active");const u=()=>{Lt(t,n,s),d.classList.toggle("active")},h=d.cloneNode(!0);d.parentNode.replaceChild(h,d),h.addEventListener("click",u)}else d.style.display="none";a.style.display="flex"}closeFullscreenCover(){const t=document.getElementById("fullscreen-cover-overlay");t.style.display="none"}showPage(t){document.querySelectorAll(".page").forEach(e=>{e.classList.toggle("active",e.id===`page-${t}`)}),document.querySelectorAll(".sidebar-nav a").forEach(e=>{e.classList.toggle("active",e.hash===`#${t}`)}),document.querySelector(".main-content").scrollTop=0,["album","artist","playlist","mix"].includes(t)||(this.setPageBackground(null),this.updateGlobalTheme()),t==="settings"&&this.renderApiSettings()}async renderLibraryPage(){this.showPage("library");const t=document.getElementById("library-tracks-container"),e=document.getElementById("library-albums-container"),s=document.getElementById("library-artists-container"),n=document.getElementById("library-playlists-container"),a=await A.getFavorites("track");a.length?this.renderListWithTracks(t,a,!0):t.innerHTML=O("No liked tracks yet.");const r=await A.getFavorites("album");r.length?(e.innerHTML=r.map(h=>this.createAlbumCardHTML(h)).join(""),r.forEach(h=>{const f=e.querySelector(`[data-album-id="${h.id}"]`);f&&(R.set(f,h),this.updateLikeState(f,"album",h.id))})):e.innerHTML=O("No liked albums yet.");const c=await A.getFavorites("artist");c.length?(s.innerHTML=c.map(h=>this.createArtistCardHTML(h)).join(""),c.forEach(h=>{const f=s.querySelector(`[data-artist-id="${h.id}"]`);f&&(R.set(f,h),this.updateLikeState(f,"artist",h.id))})):s.innerHTML=O("No liked artists yet.");const o=await A.getFavorites("playlist"),l=await A.getFavorites("mix");let d=[];o.length&&d.push(...o.map(h=>({...h,_type:"playlist"}))),l.length&&d.push(...l.map(h=>({...h,_type:"mix"}))),d.sort((h,f)=>f.addedAt-h.addedAt),d.length?(n.innerHTML=d.map(h=>h._type==="playlist"?this.createPlaylistCardHTML(h):this.createMixCardHTML(h)).join(""),o.forEach(h=>{const f=n.querySelector(`[data-playlist-id="${h.uuid}"]`);f&&(R.set(f,h),this.updateLikeState(f,"playlist",h.uuid))}),l.forEach(h=>{const f=n.querySelector(`[data-mix-id="${h.id}"]`);f&&(R.set(f,h),this.updateLikeState(f,"mix",h.id))})):n.innerHTML=O("No liked playlists or mixes yet.");const m=document.getElementById("my-playlists-container"),u=await A.getPlaylists();u.length?(m.innerHTML=u.map(h=>this.createUserPlaylistCardHTML(h)).join(""),u.forEach(h=>{const f=m.querySelector(`[data-user-playlist-id="${h.id}"]`);f&&R.set(f,h)})):m.innerHTML=O("No playlists yet. Create your first playlist!")}async renderHomePage(){this.showPage("home");const t=at.getRecents(),e=document.getElementById("home-recent-albums"),s=document.getElementById("home-recent-artists"),n=document.getElementById("home-recent-playlists");if(t.albums.length?(e.innerHTML=t.albums.map(a=>this.createAlbumCardHTML(a)).join(""),t.albums.forEach(a=>{const r=e.querySelector(`[data-album-id="${a.id}"]`);r&&(R.set(r,a),this.updateLikeState(r,"album",a.id))})):e.innerHTML=O("You haven't viewed any albums yet."),t.artists.length?(s.innerHTML=t.artists.map(a=>this.createArtistCardHTML(a)).join(""),t.artists.forEach(a=>{const r=s.querySelector(`[data-artist-id="${a.id}"]`);r&&(R.set(r,a),this.updateLikeState(r,"artist",a.id))})):s.innerHTML=O("You haven't viewed any artists yet."),n){const a=t.playlists||[],r=t.mixes||[],c=[...a,...r];c.length?(n.innerHTML=c.map(o=>o.isUserPlaylist?this.createUserPlaylistCardHTML(o):o.mixType?this.createMixCardHTML(o):this.createPlaylistCardHTML(o)).join(""),c.forEach(o=>{if(o.isUserPlaylist){const l=n.querySelector(`[data-user-playlist-id="${o.id}"]`);l&&R.set(l,o)}else if(o.mixType){const l=n.querySelector(`[data-mix-id="${o.id}"]`);l&&(R.set(l,o),this.updateLikeState(l,"mix",o.id))}else{const l=n.querySelector(`[data-playlist-id="${o.uuid}"]`);l&&(R.set(l,o),this.updateLikeState(l,"playlist",o.uuid))}})):n.innerHTML=O("You haven't viewed any playlists or mixes yet.")}}async renderSearchPage(t){this.showPage("search"),document.getElementById("search-results-title").textContent=`Search Results for "${t}"`;const e=document.getElementById("search-tracks-container"),s=document.getElementById("search-artists-container"),n=document.getElementById("search-albums-container"),a=document.getElementById("search-playlists-container");e.innerHTML=this.createSkeletonTracks(8,!0),s.innerHTML=this.createSkeletonCards(6,!0),n.innerHTML=this.createSkeletonCards(6,!1),a.innerHTML=this.createSkeletonCards(6,!1),this.searchAbortController&&this.searchAbortController.abort(),this.searchAbortController=new AbortController;const r=this.searchAbortController.signal;try{const[c,o,l,d]=await Promise.all([this.api.searchTracks(t,{signal:r}),this.api.searchArtists(t,{signal:r}),this.api.searchAlbums(t,{signal:r}),this.api.searchPlaylists(t,{signal:r})]);let m=c.items,u=o.items,h=l.items,f=d.items;if(u.length===0&&m.length>0){const p=new Map;m.forEach(g=>{g.artist&&!p.has(g.artist.id)&&p.set(g.artist.id,g.artist),g.artists&&g.artists.forEach(w=>{p.has(w.id)||p.set(w.id,w)})}),u=Array.from(p.values())}if(h.length===0&&m.length>0){const p=new Map;m.forEach(g=>{g.album&&!p.has(g.album.id)&&p.set(g.album.id,g.album)}),h=Array.from(p.values())}m.length?this.renderListWithTracks(e,m,!0):e.innerHTML=O("No tracks found."),s.innerHTML=u.length?u.map(p=>this.createArtistCardHTML(p)).join(""):O("No artists found."),u.forEach(p=>{const g=s.querySelector(`[data-artist-id="${p.id}"]`);g&&(R.set(g,p),this.updateLikeState(g,"artist",p.id))}),n.innerHTML=h.length?h.map(p=>this.createAlbumCardHTML(p)).join(""):O("No albums found."),h.forEach(p=>{const g=n.querySelector(`[data-album-id="${p.id}"]`);g&&(R.set(g,p),this.updateLikeState(g,"album",p.id))}),a.innerHTML=f.length?f.map(p=>this.createPlaylistCardHTML(p)).join(""):O("No playlists found."),f.forEach(p=>{const g=a.querySelector(`[data-playlist-id="${p.uuid}"]`);g&&(R.set(g,p),this.updateLikeState(g,"playlist",p.uuid))})}catch(c){if(c.name==="AbortError")return;console.error("Search failed:",c);const o=O(`Error during search. ${c.message}`);e.innerHTML=o,s.innerHTML=o,n.innerHTML=o,a.innerHTML=o}}async renderAlbumPage(t){this.showPage("album");const e=document.getElementById("album-detail-image"),s=document.getElementById("album-detail-title"),n=document.getElementById("album-detail-meta"),a=document.getElementById("album-detail-producer"),r=document.getElementById("album-detail-tracklist"),c=document.getElementById("play-album-btn");c&&(c.innerHTML=`${st}<span>Play Album</span>`);const o=document.getElementById("download-album-btn");o&&(o.innerHTML=`${ct}<span>Download Album</span>`);const l=document.getElementById("album-mix-btn");l&&(l.style.display="none"),e.src="",e.style.backgroundColor="var(--muted)",s.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',n.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',r.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!1)}
        `;try{const{album:d,tracks:m}=await this.api.getAlbum(t),u=this.api.getCoverUrl(d.cover);e.src=u,e.style.backgroundColor="",this.setPageBackground(u),ot.isEnabled()&&d.cover&&this.extractAndApplyColor(this.api.getCoverUrl(d.cover,"80"));const h=Pt(d)?this.createExplicitBadge():"";s.innerHTML=`${V(d.title)} ${h}`,this.adjustTitleFontSize(s,d.title);const f=St(m);let p="";if(d.releaseDate){const C=new Date(d.releaseDate);if(!isNaN(C.getTime())){const B=C.getFullYear();p=window.innerWidth>768?C.toLocaleDateString("en-US",{year:"numeric",month:"long",day:"numeric"}):B}}const g=m.find(C=>C.copyright)?.copyright;n.innerHTML=(p?`${p} • `:"")+`${m.length} tracks • ${Et(f)}`,a.innerHTML=`By <a href="#artist/${d.artist.id}">${d.artist.name}</a>`+(g?` • ${g}`:""),r.innerHTML=`
                <div class="track-list-header">
                    <span style="width: 40px; text-align: center;">#</span>
                    <span>Title</span>
                    <span class="duration-header">Duration</span>
                </div>
            `,m.sort((C,B)=>{const N=C.volumeNumber??C.discNumber??1,$=B.volumeNumber??B.discNumber??1;return N!==$?N-$:C.trackNumber-B.trackNumber}),this.renderListWithTracks(r,m,!1),at.addAlbum(d);const w=document.getElementById("like-album-btn");if(w){const C=await A.isFavorite("album",d.id);w.innerHTML=this.createHeartIcon(C),w.classList.toggle("active",C)}document.title=`${d.title} - ${d.artist.name}`;const b=document.getElementById("album-section-more-albums"),y=document.getElementById("album-detail-more-albums"),v=document.getElementById("album-title-more-albums"),S=document.getElementById("album-section-eps"),E=document.getElementById("album-detail-eps"),T=document.getElementById("album-title-eps"),L=document.getElementById("album-section-similar-artists"),x=document.getElementById("album-detail-similar-artists"),_=document.getElementById("album-section-similar-albums"),U=document.getElementById("album-detail-similar-albums");[b,S,L,_].forEach(C=>{C&&(C.style.display="none")});try{const C=await this.api.getArtist(d.artist.id),B=document.getElementById("album-mix-btn");B&&C.mixes&&C.mixes.ARTIST_MIX&&(B.style.display="flex",B.onclick=()=>window.location.hash=`#mix/${C.mixes.ARTIST_MIX}`);const N=($,F,k,I,M)=>{if(!F||!k)return;const P=($||[]).filter(H=>H.id!=d.id).filter((H,D,lt)=>D===lt.findIndex(we=>we.title===H.title)).slice(0,12);P.length!==0&&(F.innerHTML=P.map(H=>this.createAlbumCardHTML(H)).join(""),I&&M&&(I.textContent=M),k.style.display="block",P.forEach(H=>{const D=F.querySelector(`[data-album-id="${H.id}"]`);D&&(R.set(D,H),this.updateLikeState(D,"album",H.id))}))};N(C.albums,y,b,v,`More albums from ${d.artist.name}`),N(C.eps,E,S,T,`EPs and Singles from ${d.artist.name}`),this.api.getSimilarArtists(d.artist.id).then($=>{$&&$.length>0&&x&&L&&(x.innerHTML=$.map(F=>this.createArtistCardHTML(F)).join(""),L.style.display="block")}).catch($=>console.warn("Failed to load similar artists:",$)),this.api.getSimilarAlbums(t).then($=>{$&&$.length>0&&U&&_&&(U.innerHTML=$.map(F=>this.createAlbumCardHTML(F)).join(""),_.style.display="block",$.forEach(F=>{const k=U.querySelector(`[data-album-id="${F.id}"]`);k&&(R.set(k,F),this.updateLikeState(k,"album",F.id))}))}).catch($=>console.warn("Failed to load similar albums:",$))}catch(C){console.warn('Failed to load "More from artist":',C)}}catch(d){console.error("Failed to load album:",d),r.innerHTML=O(`Could not load album details. ${d.message}`)}}async renderPlaylistPage(t,e=null){this.showPage("playlist");const s=document.getElementById("playlist-detail-image"),n=document.getElementById("playlist-detail-title"),a=document.getElementById("playlist-detail-meta"),r=document.getElementById("playlist-detail-description"),c=document.getElementById("playlist-detail-tracklist"),o=document.getElementById("play-playlist-btn");o&&(o.innerHTML=`${st}<span>Play</span>`);const l=document.getElementById("download-playlist-btn");l&&(l.innerHTML=`${ct}<span>Download</span>`),s.src="",s.style.backgroundColor="var(--muted)",n.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',r.innerHTML='<div class="skeleton" style="height: 16px; width: 100%;"></div>',c.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!0)}
        `;try{const d=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(t);let m=null,u=null;if((e==="user"||!e&&d)&&(u=await A.getPlaylist(t),m=u,!m))try{m=await q.getPublicPlaylist(t)}catch(h){console.warn("Failed to check public Firebase playlists:",h)}if(m){s.src=m.cover||"assets/appicon.png",s.style.backgroundColor="",n.textContent=m.name||m.title,this.adjustTitleFontSize(n,n.textContent);const h=m.tracks||[],f=St(h);a.textContent=`${h.length} tracks • ${Et(f)}`,r.textContent=m.description||"",c.innerHTML=`
                    <div class="track-list-header">
                        <span style="width: 40px; text-align: center;">#</span>
                        <span>Title</span>
                        <span class="duration-header">Duration</span>
                    </div>
                `,this.renderListWithTracks(c,h,!0),u&&c.querySelectorAll(".track-item").forEach((v,S)=>{const E=v.querySelector(".track-item-actions"),T=document.createElement("button");T.className="track-action-btn remove-from-playlist-btn",T.title="Remove from playlist",T.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>',T.dataset.trackIndex=S;const L=E.querySelector(".track-menu-btn");E.insertBefore(T,L)});const p=document.getElementById("like-playlist-btn");p&&(p.style.display="none"),this.updatePlaylistHeaderActions(m,!!u,h);const g=[],w=new Set,b=m.tracks||[];for(const y of b){const v=y.album?.cover;if(v&&!w.has(v)&&(w.add(v),g.push(v),g.length>=4))break}at.addPlaylist({id:m.id||m.uuid,name:m.name||m.title,title:m.title||m.name,uuid:m.uuid||m.id,cover:m.cover,images:g,numberOfTracks:m.tracks?m.tracks.length:0,isUserPlaylist:!0}),document.title=`${m.name||m.title} - Monochrome`}else{if(e==="user")throw new Error("Playlist not found. If this is a custom playlist, make sure it is set to Public.");let h;try{h=await this.api.getPlaylist(t)}catch(v){throw v}const{playlist:f,tracks:p}=h,g=f.squareImage||f.image;g?(s.src=this.api.getCoverUrl(g,"1080"),this.setPageBackground(s.src),this.extractAndApplyColor(this.api.getCoverUrl(g,"160"))):(s.src="assets/appicon.png",this.setPageBackground(null),this.resetVibrantColor()),n.textContent=f.title,this.adjustTitleFontSize(n,f.title);const w=St(p);a.textContent=`${f.numberOfTracks} tracks • ${Et(w)}`,r.textContent=f.description||"",c.innerHTML=`
                    <div class="track-list-header">
                        <span style="width: 40px; text-align: center;">#</span>
                        <span>Title</span>
                        <span class="duration-header">Duration</span>
                    </div>
                `,this.renderListWithTracks(c,p,!0);const b=document.getElementById("like-playlist-btn");if(b){const v=await A.isFavorite("playlist",f.uuid);b.innerHTML=this.createHeartIcon(v),b.classList.toggle("active",v),b.style.display="flex"}const y=document.getElementById("delete-playlist-btn");y&&(y.style.display="none"),this.updatePlaylistHeaderActions(f,!1,p,!1),at.addPlaylist(f),document.title=f.title||"Artist Mix"}}catch(d){console.error("Failed to load playlist:",d),c.innerHTML=O(`Could not load playlist details. ${d.message}`)}}async renderMixPage(t){this.showPage("mix");const e=document.getElementById("mix-detail-image"),s=document.getElementById("mix-detail-title"),n=document.getElementById("mix-detail-meta"),a=document.getElementById("mix-detail-description"),r=document.getElementById("mix-detail-tracklist"),c=document.getElementById("play-mix-btn");c&&(c.innerHTML=`${st}<span>Play</span>`);const o=document.getElementById("download-mix-btn");o&&(o.innerHTML=`${ct}<span>Download</span>`),e.src="",e.style.backgroundColor="var(--muted)",s.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',n.innerHTML='<div class="skeleton" style="height: 16px; width: 200px; max-width: 80%;"></div>',a.innerHTML='<div class="skeleton" style="height: 16px; width: 100%;"></div>',r.innerHTML=`
            <div class="track-list-header">
                <span style="width: 40px; text-align: center;">#</span>
                <span>Title</span>
                <span class="duration-header">Duration</span>
            </div>
            ${this.createSkeletonTracks(10,!0)}
        `;try{const{mix:l,tracks:d}=await this.api.getMix(t);l.cover?(e.src=l.cover,this.setPageBackground(l.cover),this.extractAndApplyColor(l.cover)):d.length>0&&d[0].album?.cover?(e.src=this.api.getCoverUrl(d[0].album.cover),this.setPageBackground(e.src),this.extractAndApplyColor(this.api.getCoverUrl(d[0].album.cover,"160"))):(e.src="assets/appicon.png",this.setPageBackground(null),this.resetVibrantColor()),e.style.backgroundColor="";const m=l.title||"Mix";s.textContent=m,this.adjustTitleFontSize(s,m);const u=St(d);n.textContent=`${d.length} tracks • ${Et(u)}`,a.innerHTML=`${l.subTitle}`,r.innerHTML=`
                <div class="track-list-header">
                    <span style="width: 40px; text-align: center;">#</span>
                    <span>Title</span>
                    <span class="duration-header">Duration</span>
                </div>
            `,this.renderListWithTracks(r,d,!0),c.onclick=()=>{this.player.setQueue(d,0),this.player.playTrackFromQueue()},at.addMix(l);const h=document.getElementById("like-mix-btn");if(h){h.style.display="flex";const f=await A.isFavorite("mix",l.id);h.innerHTML=this.createHeartIcon(f),h.classList.toggle("active",f)}document.title=m}catch(l){console.error("Failed to load mix:",l),r.innerHTML=O(`Could not load mix details. ${l.message}`)}}async renderArtistPage(t){this.showPage("artist");const e=document.getElementById("artist-detail-image"),s=document.getElementById("artist-detail-name"),n=document.getElementById("artist-detail-meta"),a=document.getElementById("artist-detail-tracks"),r=document.getElementById("artist-detail-albums"),c=document.getElementById("artist-detail-eps"),o=document.getElementById("artist-section-eps"),l=document.getElementById("artist-detail-similar"),d=document.getElementById("artist-section-similar"),m=document.getElementById("download-discography-btn");m&&(m.innerHTML=`${ct}<span>Download Discography</span>`),e.src="",e.style.backgroundColor="var(--muted)",s.innerHTML='<div class="skeleton" style="height: 48px; width: 300px; max-width: 90%;"></div>',n.innerHTML='<div class="skeleton" style="height: 16px; width: 150px;"></div>',a.innerHTML=this.createSkeletonTracks(5,!0),r.innerHTML=this.createSkeletonCards(6,!1),c&&(c.innerHTML=this.createSkeletonCards(6,!1)),o&&(o.style.display="none"),l&&(l.innerHTML=this.createSkeletonCards(6,!0)),d&&(d.style.display="block");try{const u=await this.api.getArtist(t),h=document.getElementById("artist-mix-btn");h&&(u.mixes&&u.mixes.ARTIST_MIX?(h.style.display="flex",h.onclick=()=>window.location.hash=`#mix/${u.mixes.ARTIST_MIX}`):h.style.display="none"),l&&d&&this.api.getSimilarArtists(t).then(g=>{g&&g.length>0?(l.innerHTML=g.map(w=>this.createArtistCardHTML(w)).join(""),d.style.display="block"):d.style.display="none"}).catch(()=>{d.style.display="none"}),e.src=this.api.getArtistPictureUrl(u.picture),e.style.backgroundColor="",s.textContent=u.name,this.setPageBackground(e.src);const f=this.api.getArtistPictureUrl(u.picture,"160");this.extractAndApplyColor(f),this.adjustTitleFontSize(s,u.name),n.innerHTML=`
                <span>${u.popularity}% popularity</span>
                <div class="artist-tags">
                    ${(u.artistRoles||[]).filter(g=>g.category).map(g=>`<span class="artist-tag">${g.category}</span>`).join("")}
                </div>
            `,this.renderListWithTracks(a,u.tracks,!0);const p=document.getElementById("like-artist-btn");if(p){const g=await A.isFavorite("artist",u.id);p.innerHTML=this.createHeartIcon(g),p.classList.toggle("active",g)}r.innerHTML=u.albums.map(g=>this.createAlbumCardHTML(g)).join(""),r.innerHTML=u.albums.length?u.albums.map(g=>this.createAlbumCardHTML(g)).join(""):O("No albums found."),c&&o&&(u.eps&&u.eps.length>0?(c.innerHTML=u.eps.map(g=>this.createAlbumCardHTML(g)).join(""),o.style.display="block"):o.style.display="none"),u.albums.forEach(g=>{const w=r.querySelector(`[data-album-id="${g.id}"]`);w&&(R.set(w,g),this.updateLikeState(w,"album",g.id))}),at.addArtist(u),document.title=u.name}catch(u){console.error("Failed to load artist:",u),a.innerHTML=r.innerHTML=O(`Could not load artist details. ${u.message}`)}}async renderRecentPage(){this.showPage("recent");const t=document.getElementById("recent-tracks-container");t.innerHTML=this.createSkeletonTracks(10,!0);try{const e=await A.getHistory();if(e.length===0){t.innerHTML=O("You haven't played any tracks yet.");return}const s={},n=new Date().setHours(0,0,0,0),a=new Date(n-864e5).setHours(0,0,0,0);e.forEach(r=>{const c=new Date(r.timestamp),o=new Date(c).setHours(0,0,0,0);let l;o===n?l="Today":o===a?l="Yesterday":l=c.toLocaleDateString(void 0,{weekday:"long",year:"numeric",month:"long",day:"numeric"}),s[l]||(s[l]=[]),s[l].push(r)}),t.innerHTML="";for(const[r,c]of Object.entries(s)){const o=document.createElement("h3");o.className="track-list-header-group",o.textContent=r,o.style.margin="1.5rem 0 0.5rem 0",o.style.fontSize="1.1rem",o.style.fontWeight="600",o.style.color="var(--foreground)",o.style.paddingLeft="0.5rem",t.appendChild(o);const l=document.createElement("div");for(this.renderListWithTracks(l,c,!0);l.firstChild;)t.appendChild(l.firstChild)}}catch(e){console.error("Failed to load history:",e),t.innerHTML=O("Failed to load history.")}}updatePlaylistHeaderActions(t,e,s,n=!1){const a=document.getElementById("page-playlist").querySelector(".detail-header-actions");["shuffle-playlist-btn","edit-playlist-btn","delete-playlist-btn","share-playlist-btn"].forEach(l=>{const d=a.querySelector(`#${l}`);d&&d.remove()});const r=document.createDocumentFragment(),c=document.createElement("button");if(c.id="shuffle-playlist-btn",c.className="btn-primary",c.innerHTML='<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m18 14 4 4-4 4"/><path d="m18 2 4 4-4 4"/><path d="M2 18h1.973a4 4 0 0 0 3.3-1.7l5.454-8.6a4 4 0 0 1 3.3-1.7H22"/><path d="M2 6h1.972a4 4 0 0 1 3.6 2.2"/><path d="M22 18h-6.041a4 4 0 0 1-3.3-1.8l-.359-.45"/></svg><span>Shuffle</span>',c.onclick=()=>{const l=[...s].sort(()=>Math.random()-.5);this.player.setQueue(l,0),this.player.playTrackFromQueue()},r.appendChild(c),e){const l=document.createElement("button");l.id="edit-playlist-btn",l.className="btn-secondary",l.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg><span>Edit</span>',r.appendChild(l);const d=document.createElement("button");d.id="delete-playlist-btn",d.className="btn-secondary danger",d.innerHTML='<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg><span>Delete</span>',r.appendChild(d)}if(n||e&&t.isPublic){const l=document.createElement("button");l.id="share-playlist-btn",l.className="btn-secondary",l.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><polyline points="16 6 12 2 8 6"/><line x1="12" y1="2" x2="12" y2="15"/></svg><span>Share</span>',l.onclick=()=>{const d=`${window.location.origin}${window.location.pathname}#userplaylist/${t.id||t.uuid}`;navigator.clipboard.writeText(d).then(()=>alert("Link copied to clipboard!"))},r.appendChild(l)}const o=a.querySelector("#download-playlist-btn");if(o)for(a.insertBefore(c,o);r.firstChild;)a.appendChild(r.firstChild);else a.appendChild(r)}renderApiSettings(){const t=document.getElementById("api-instance-list");Promise.all([this.api.settings.getInstances("api"),this.api.settings.getInstances("streaming")]).then(([e,s])=>{const a=this.api.settings.getCachedSpeedTests()?.speeds||{},r=(l,d)=>{if(!l||l.length===0)return"";const m=l.map((u,h)=>{const f=d==="streaming"?`${u}#streaming`:u,p=a[f],g=p?p.speed===1/0||typeof p.speed!="number"?'<span style="color: var(--muted-foreground); font-size: 0.8rem;">Failed</span>':`<span style="color: var(--muted-foreground); font-size: 0.8rem;">${p.speed.toFixed(0)}ms</span>`:"";return`
                        <li data-index="${h}" data-type="${d}">
                            <div style="flex: 1; min-width: 0;">
                                <div class="instance-url">${u}</div>
                                ${g}
                            </div>
                            <div class="controls">
                                <button class="move-up" title="Move Up" ${h===0?"disabled":""}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 19V5M5 12l7-7 7 7"/>
                                    </svg>
                                </button>
                                <button class="move-down" title="Move Down" ${h===l.length-1?"disabled":""}>
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 5v14M19 12l-7 7-7-7"/>
                                    </svg>
                                </button>
                            </div>
                        </li>
                    `}).join("");return`
                    <li class="group-header" style="font-weight: bold; padding: 1rem 0 0.5rem; background: transparent; border: none; pointer-events: none;">
                        ${d==="api"?"API Instances":"Streaming Instances"}
                    </li>
                    ${m}
                `};t.innerHTML=r(e,"api")+r(s,"streaming");const c=this.api.getCacheStats(),o=document.getElementById("cache-info");o&&(o.textContent=`Cache: ${c.memoryEntries}/${c.maxSize} entries`)})}}class vs{constructor(t,e,s="LOSSLESS"){this.audio=t,this.api=e,this.quality=s,this.queue=[],this.shuffledQueue=[],this.originalQueueBeforeShuffle=[],this.currentQueueIndex=-1,this.shuffleActive=!1,this.repeatMode=Q.OFF,this.preloadCache=new Map,this.preloadAbortController=null,this.currentTrack=null,this.sleepTimer=null,this.sleepTimerEndTime=null,this.sleepTimerInterval=null,this.loadQueueState(),this.setupMediaSession(),window.addEventListener("beforeunload",()=>{this.saveQueueState()})}loadQueueState(){const t=Yt.getQueue();if(t){this.queue=t.queue||[],this.shuffledQueue=t.shuffledQueue||[],this.originalQueueBeforeShuffle=t.originalQueueBeforeShuffle||[],this.currentQueueIndex=t.currentQueueIndex??-1,this.shuffleActive=t.shuffleActive||!1,this.repeatMode=t.repeatMode||Q.OFF;const e=this.shuffleActive?this.shuffledQueue:this.queue;if(this.currentQueueIndex>=0&&this.currentQueueIndex<e.length){this.currentTrack=e[this.currentQueueIndex];const s=this.currentTrack,n=Y(s),a=Kt(s);let r="";const c=s.album?.releaseDate||s.streamStartDate;if(c){const h=new Date(c);isNaN(h.getTime())||(r=` • ${h.getFullYear()}`)}const o=document.querySelector(".now-playing-bar .cover"),l=document.querySelector(".now-playing-bar .title"),d=document.querySelector(".now-playing-bar .artist");o&&(o.src=this.api.getCoverUrl(s.album?.cover)),l&&(l.textContent=n),d&&(d.innerHTML=a+r);const m=document.getElementById("now-playing-mix-btn");m&&(m.style.display=s.mixes&&s.mixes.TRACK_MIX?"flex":"none");const u=document.getElementById("total-duration");u&&(u.textContent=mt(s.duration)),document.title=`${n} • ${G(s)}`,this.updatePlayingTrackIndicator(),this.updateMediaSession(s)}}}saveQueueState(){Yt.saveQueue({queue:this.queue,shuffledQueue:this.shuffledQueue,originalQueueBeforeShuffle:this.originalQueueBeforeShuffle,currentQueueIndex:this.currentQueueIndex,shuffleActive:this.shuffleActive,repeatMode:this.repeatMode})}setupMediaSession(){"mediaSession"in navigator&&(navigator.mediaSession.setActionHandler("play",()=>{this.audio.play().catch(console.error)}),navigator.mediaSession.setActionHandler("pause",()=>{this.audio.pause()}),navigator.mediaSession.setActionHandler("previoustrack",()=>{this.playPrev()}),navigator.mediaSession.setActionHandler("nexttrack",()=>{this.playNext()}),navigator.mediaSession.setActionHandler("seekbackward",t=>{const e=t.seekOffset||10;this.seekBackward(e)}),navigator.mediaSession.setActionHandler("seekforward",t=>{const e=t.seekOffset||10;this.seekForward(e)}),navigator.mediaSession.setActionHandler("seekto",t=>{t.seekTime!==void 0&&(this.audio.currentTime=Math.max(0,t.seekTime),this.updateMediaSessionPositionState())}),navigator.mediaSession.setActionHandler("stop",()=>{this.audio.pause(),this.audio.currentTime=0,this.updateMediaSessionPlaybackState()}))}setQuality(t){this.quality=t}async preloadNextTracks(){this.preloadAbortController&&this.preloadAbortController.abort(),this.preloadAbortController=new AbortController;const t=this.shuffleActive?this.shuffledQueue:this.queue,e=[];for(let s=1;s<=2;s++){const n=this.currentQueueIndex+s;n<t.length&&e.push({track:t[n],index:n})}for(const{track:s}of e){if(this.preloadCache.has(s.id))continue;const n=Y(s);try{const a=await this.api.getStreamUrl(s.id,this.quality);if(this.preloadAbortController.signal.aborted)break;this.preloadCache.set(s.id,a),fetch(a,{method:"HEAD",signal:this.preloadAbortController.signal}).catch(()=>{})}catch(a){a.name!=="AbortError"&&console.debug("Failed to get stream URL for preload:",n)}}}async playTrackFromQueue(t=0){const e=this.shuffleActive?this.shuffledQueue:this.queue;if(this.currentQueueIndex<0||this.currentQueueIndex>=e.length)return;this.saveQueueState();const s=e[this.currentQueueIndex];this.currentTrack=s;const n=Y(s),a=Kt(s);let r="";const c=s.album?.releaseDate||s.streamStartDate;if(c){const l=new Date(c);isNaN(l.getTime())||(r=` • ${l.getFullYear()}`)}document.querySelector(".now-playing-bar .cover").src=this.api.getCoverUrl(s.album?.cover),document.querySelector(".now-playing-bar .title").textContent=n,document.querySelector(".now-playing-bar .artist").innerHTML=a+r;const o=document.getElementById("now-playing-mix-btn");o&&(o.style.display=s.mixes&&s.mixes.TRACK_MIX?"flex":"none"),document.title=`${n} • ${G(s)}`,this.updatePlayingTrackIndicator();try{let l;if(this.preloadCache.has(s.id))l=this.preloadCache.get(s.id);else{const d=await this.api.getTrack(s.id,this.quality);d.originalTrackUrl?l=d.originalTrackUrl:l=this.api.extractStreamUrlFromManifest(d.info.manifest)}this.audio.src=l,t>0&&(this.audio.currentTime=t),await this.audio.play(),this.updateMediaSession(s),this.updateMediaSessionPlaybackState(),this.preloadNextTracks()}catch(l){console.error(`Could not play track: ${n}`,l),document.querySelector(".now-playing-bar .title").textContent=`Error: ${n}`,document.querySelector(".now-playing-bar .artist").textContent=l.message||"Could not load track"}}playAtIndex(t){const e=this.shuffleActive?this.shuffledQueue:this.queue;t>=0&&t<e.length&&(this.currentQueueIndex=t,this.playTrackFromQueue())}playNext(){const t=this.shuffleActive?this.shuffledQueue:this.queue,e=this.currentQueueIndex>=t.length-1;if(this.repeatMode===Q.ONE){this.audio.currentTime=0,this.audio.play();return}if(!e)this.currentQueueIndex++;else if(this.repeatMode===Q.ALL)this.currentQueueIndex=0;else return;this.playTrackFromQueue()}playPrev(){this.audio.currentTime>3?(this.audio.currentTime=0,this.updateMediaSessionPositionState()):this.currentQueueIndex>0&&(this.currentQueueIndex--,this.playTrackFromQueue())}handlePlayPause(){if(!this.audio.src||this.audio.error){this.currentTrack&&this.playTrackFromQueue();return}this.audio.paused?this.audio.play().catch(t=>{t.name==="NotAllowedError"||t.name==="AbortError"||(console.error("Play failed, reloading track:",t),this.currentTrack&&this.playTrackFromQueue())}):(this.audio.pause(),this.saveQueueState())}seekBackward(t=10){const e=Math.max(0,this.audio.currentTime-t);this.audio.currentTime=e,this.updateMediaSessionPositionState()}seekForward(t=10){const e=this.audio.duration||0,s=Math.min(e,this.audio.currentTime+t);this.audio.currentTime=s,this.updateMediaSessionPositionState()}toggleShuffle(){if(this.shuffleActive=!this.shuffleActive,this.shuffleActive){this.originalQueueBeforeShuffle=[...this.queue];const t=this.queue[this.currentQueueIndex];this.shuffledQueue=[...this.queue].sort(()=>Math.random()-.5),this.currentQueueIndex=this.shuffledQueue.findIndex(e=>e.id===t?.id),this.currentQueueIndex===-1&&t&&(this.shuffledQueue.unshift(t),this.currentQueueIndex=0)}else{const t=this.shuffledQueue[this.currentQueueIndex];this.queue=[...this.originalQueueBeforeShuffle],this.currentQueueIndex=this.queue.findIndex(e=>e.id===t?.id)}this.preloadCache.clear(),this.preloadNextTracks(),this.saveQueueState()}toggleRepeat(){return this.repeatMode=(this.repeatMode+1)%3,this.saveQueueState(),this.repeatMode}setQueue(t,e=0){this.queue=t,this.currentQueueIndex=e,this.shuffleActive=!1,this.preloadCache.clear(),this.saveQueueState()}addToQueue(t){this.queue.push(t),(!this.currentTrack||this.currentQueueIndex===-1)&&(this.currentQueueIndex=this.queue.length-1,this.playTrackFromQueue()),this.saveQueueState()}addNextToQueue(t){const e=this.shuffleActive?this.shuffledQueue:this.queue,s=this.currentQueueIndex+1;e.splice(s,0,t),this.shuffleActive&&this.originalQueueBeforeShuffle.push(t),this.saveQueueState(),this.preloadNextTracks()}removeFromQueue(t){const e=this.shuffleActive?this.shuffledQueue:this.queue;this.currentQueueIndex,t<this.currentQueueIndex&&this.currentQueueIndex--;const s=e.splice(t,1)[0];if(this.shuffleActive){const n=this.originalQueueBeforeShuffle.findIndex(a=>a.id===s.id);n!==-1&&this.originalQueueBeforeShuffle.splice(n,1)}this.saveQueueState(),this.preloadNextTracks()}clearQueue(){this.queue=[],this.shuffledQueue=[],this.originalQueueBeforeShuffle=[],this.currentQueueIndex=-1,this.saveQueueState()}moveInQueue(t,e){const s=this.shuffleActive?this.shuffledQueue:this.queue;if(t<0||t>=s.length||e<0||e>=s.length)return;const[n]=s.splice(t,1);s.splice(e,0,n),this.currentQueueIndex===t?this.currentQueueIndex=e:t<this.currentQueueIndex&&e>=this.currentQueueIndex?this.currentQueueIndex--:t>this.currentQueueIndex&&e<=this.currentQueueIndex&&this.currentQueueIndex++,this.saveQueueState()}getCurrentQueue(){return this.shuffleActive?this.shuffledQueue:this.queue}getNextTrack(){const t=this.getCurrentQueue();if(this.currentQueueIndex===-1||t.length===0)return null;const e=this.currentQueueIndex+1;return e<t.length?t[e]:this.repeatMode===Q.ALL?t[0]:null}updatePlayingTrackIndicator(){const t=this.getCurrentQueue()[this.currentQueueIndex];document.querySelectorAll(".track-item").forEach(e=>{e.classList.toggle("playing",t&&e.dataset.trackId==t.id)}),document.querySelectorAll(".queue-track-item").forEach(e=>{const s=parseInt(e.dataset.queueIndex);e.classList.toggle("playing",s===this.currentQueueIndex)})}updateMediaSession(t){if(!("mediaSession"in navigator))return;navigator.mediaSession.metadata=null;const e=[],s=["320"],n=t.album?.cover,a=Y(t);n&&s.forEach(r=>{e.push({src:this.api.getCoverUrl(n,r),sizes:`${r}x${r}`,type:"image/jpeg"})}),navigator.mediaSession.metadata=new MediaMetadata({title:a||"Unknown Title",artist:G(t)||"Unknown Artist",album:t.album?.title||"Unknown Album",artwork:e.length>0?e:void 0}),this.updateMediaSessionPlaybackState(),this.updateMediaSessionPositionState()}updateMediaSessionPlaybackState(){"mediaSession"in navigator&&(navigator.mediaSession.playbackState=this.audio.paused?"paused":"playing")}updateMediaSessionPositionState(){if(!("mediaSession"in navigator)||!("setPositionState"in navigator.mediaSession))return;const t=this.audio.duration;if(!(!t||isNaN(t)||!isFinite(t)))try{navigator.mediaSession.setPositionState({duration:t,playbackRate:this.audio.playbackRate||1,position:Math.min(this.audio.currentTime,t)})}catch(e){console.debug("Failed to update Media Session position:",e)}}setSleepTimer(t){this.clearSleepTimer(),this.sleepTimerEndTime=Date.now()+t*60*1e3,this.sleepTimer=setTimeout(()=>{this.audio.pause(),this.clearSleepTimer(),this.updateSleepTimerUI()},t*60*1e3),this.sleepTimerInterval=setInterval(()=>{this.updateSleepTimerUI()},1e3),this.updateSleepTimerUI()}clearSleepTimer(){this.sleepTimer&&(clearTimeout(this.sleepTimer),this.sleepTimer=null),this.sleepTimerInterval&&(clearInterval(this.sleepTimerInterval),this.sleepTimerInterval=null),this.sleepTimerEndTime=null,this.updateSleepTimerUI()}getSleepTimerRemaining(){if(!this.sleepTimerEndTime)return null;const t=Math.max(0,this.sleepTimerEndTime-Date.now());return Math.ceil(t/1e3)}isSleepTimerActive(){return this.sleepTimer!==null}updateSleepTimerUI(){const t=document.getElementById("sleep-timer-btn"),e=document.getElementById("sleep-timer-btn-desktop"),s=n=>{if(n)if(this.isSleepTimerActive()){const a=this.getSleepTimerRemaining();if(a>0){const r=Math.floor(a/60),c=a%60;n.innerHTML=`<span style="font-size: 12px; font-weight: bold;">${r}:${c.toString().padStart(2,"0")}</span>`,n.title=`Sleep Timer: ${r}:${c.toString().padStart(2,"0")} remaining`,n.classList.add("active"),n.style.color="var(--primary)"}else n.innerHTML=`
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="12" cy="12" r="10"/>
                            <polyline points="12,6 12,12 16,14"/>
                        </svg>
                    `,n.title="Sleep Timer",n.classList.remove("active"),n.style.color=""}else n.innerHTML=`
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="10"/>
                        <polyline points="12,6 12,12 16,14"/>
                    </svg>
                `,n.title="Sleep Timer",n.classList.remove("active"),n.style.color=""};s(t),s(e)}}const ks="modulepreload",Ts=function(i,t){return new URL(i,t).href},Jt={},Mt=function(t,e,s){let n=Promise.resolve();if(e&&e.length>0){let l=function(d){return Promise.all(d.map(m=>Promise.resolve(m).then(u=>({status:"fulfilled",value:u}),u=>({status:"rejected",reason:u}))))};const r=document.getElementsByTagName("link"),c=document.querySelector("meta[property=csp-nonce]"),o=c?.nonce||c?.getAttribute("nonce");n=l(e.map(d=>{if(d=Ts(d,s),d in Jt)return;Jt[d]=!0;const m=d.endsWith(".css"),u=m?'[rel="stylesheet"]':"";if(s)for(let f=r.length-1;f>=0;f--){const p=r[f];if(p.href===d&&(!m||p.rel==="stylesheet"))return}else if(document.querySelector(`link[href="${d}"]${u}`))return;const h=document.createElement("link");if(h.rel=m?"stylesheet":ks,m||(h.as="script"),h.crossOrigin="",h.href=d,o&&h.setAttribute("nonce",o),document.head.appendChild(h),m)return new Promise((f,p)=>{h.addEventListener("load",f),h.addEventListener("error",()=>p(new Error(`Unable to preload CSS for ${d}`)))})}))}function a(r){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=r,window.dispatchEvent(c),!c.defaultPrevented)throw r}return n.then(r=>{for(const c of r||[])c.status==="rejected"&&a(c.reason);return t().catch(a)})};class Ss{constructor(){this.API_KEY="0ecf01914957b40c17030db822845a76",this.API_SECRET="bd37e61e0b16b8c7bf8de2862de5493c",this.API_URL="https://ws.audioscrobbler.com/2.0/",this.sessionKey=null,this.username=null,this.currentTrack=null,this.scrobbleTimer=null,this.scrobbleThreshold=0,this.hasScrobbled=!1,this.loadSession()}loadSession(){try{const t=localStorage.getItem("lastfm-session");if(t){const e=JSON.parse(t);this.sessionKey=e.key,this.username=e.name}}catch(t){console.error("Failed to load Last.fm session:",t)}}saveSession(t,e){this.sessionKey=t,this.username=e,localStorage.setItem("lastfm-session",JSON.stringify({key:t,name:e}))}clearSession(){this.sessionKey=null,this.username=null,localStorage.removeItem("lastfm-session")}isAuthenticated(){return!!this.sessionKey}async generateSignature(t){const e={...t};delete e.format,delete e.callback;const n=Object.keys(e).sort().map(a=>`${a}${e[a]}`).join("")+this.API_SECRET;console.log("Signature string:",n);try{const{default:a}=await Mt(async()=>{const{default:r}=await import("https://cdn.jsdelivr.net/npm/md5@2.3.0/+esm");return{default:r}},[],import.meta.url);return a(n)}catch{throw console.error("MD5 library not available"),new Error("MD5 library required for Last.fm")}}async makeRequest(t,e={},s=!1){const n={method:t,api_key:this.API_KEY,...e};s&&this.sessionKey&&(n.sk=this.sessionKey);const a=await this.generateSignature(n),r=new URLSearchParams({...n,api_sig:a,format:"json"});try{const o=await(await fetch(this.API_URL,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:r})).json();if(o.error)throw new Error(o.message||"Last.fm API error");return o}catch(c){throw console.error("Last.fm API request failed:",c),c}}async getAuthUrl(){try{const e=(await this.makeRequest("auth.getToken")).token;return{token:e,url:`https://www.last.fm/api/auth/?api_key=${this.API_KEY}&token=${e}`}}catch(t){throw console.error("Failed to get auth URL:",t),t}}async completeAuthentication(t){try{const e=await this.makeRequest("auth.getSession",{token:t});if(e.session)return this.saveSession(e.session.key,e.session.name),{success:!0,username:e.session.name};throw new Error("No session returned")}catch(e){throw console.error("Authentication failed:",e),e}}async updateNowPlaying(t){if(this.isAuthenticated()){this.currentTrack=t,this.hasScrobbled=!1,this.clearScrobbleTimer();try{const e={artist:t.artist?.name||t.artists?.[0]?.name||"Unknown Artist",track:t.title};t.album?.title&&(e.album=t.album.title),t.duration&&(e.duration=Math.floor(t.duration)),t.trackNumber&&(e.trackNumber=t.trackNumber),await this.makeRequest("track.updateNowPlaying",e,!0),console.log("Now playing updated:",t.title),this.scrobbleThreshold=Math.min(t.duration/2,240),this.scheduleScrobble(this.scrobbleThreshold*1e3)}catch(e){console.error("Failed to update now playing:",e)}}}scheduleScrobble(t){this.clearScrobbleTimer(),this.scrobbleTimer=setTimeout(()=>{this.scrobbleCurrentTrack()},t)}clearScrobbleTimer(){this.scrobbleTimer&&(clearTimeout(this.scrobbleTimer),this.scrobbleTimer=null)}async scrobbleCurrentTrack(){if(!(!this.isAuthenticated()||!this.currentTrack||this.hasScrobbled))try{const t=Math.floor(Date.now()/1e3),e={artist:this.currentTrack.artist?.name||this.currentTrack.artists?.[0]?.name||"Unknown Artist",track:this.currentTrack.title,timestamp:t};this.currentTrack.album?.title&&(e.album=this.currentTrack.album.title),this.currentTrack.duration&&(e.duration=Math.floor(this.currentTrack.duration)),this.currentTrack.trackNumber&&(e.trackNumber=this.currentTrack.trackNumber),await this.makeRequest("track.scrobble",e,!0),this.hasScrobbled=!0,console.log("Scrobbled:",this.currentTrack.title)}catch(t){console.error("Failed to scrobble:",t)}}async loveTrack(t){if(this.isAuthenticated())try{const e={artist:t.artist?.name||t.artists?.[0]?.name||"Unknown Artist",track:t.title};await this.makeRequest("track.love",e,!0),console.log("Loved track on Last.fm:",t.title)}catch(e){console.error("Failed to love track on Last.fm:",e)}}onTrackChange(t){this.isAuthenticated()&&this.updateNowPlaying(t)}onPlaybackStop(){this.clearScrobbleTimer()}disconnect(){this.clearSession(),this.clearScrobbleTimer(),this.currentTrack=null}}function Es(i){return()=>{const e=window.location.hash.substring(1)||"home",[s,n]=e.split("/");switch(s){case"search":i.renderSearchPage(decodeURIComponent(n));break;case"album":i.renderAlbumPage(n);break;case"artist":i.renderArtistPage(n);break;case"playlist":i.renderPlaylistPage(n,"api");break;case"userplaylist":i.renderPlaylistPage(n,"user");break;case"mix":i.renderMixPage(n);break;case"library":i.renderLibraryPage();break;case"recent":i.renderRecentPage();break;case"home":i.renderHomePage();break;default:i.showPage(s);break}}}function ge(i){if(i.currentTrack){const t=i.currentTrack;document.title=`${t.title} • ${G(t)}`}else{const t=window.location.hash;if(t.includes("#album/")||t.includes("#playlist/"))return;document.title="Monochrome Music"}}class Ls{constructor(){this.user=null,this.unsubscribe=null,this.init()}init(){K&&(this.unsubscribe=Se(K,t=>{this.user=t,this.updateUI(t),t?(console.log("User logged in:",t.uid),q.initialize(t)):(console.log("User logged out"),q.disconnect())}))}async signInWithGoogle(){if(!K){alert("Firebase is not configured. Please check console.");return}try{return(await Ee(K,he)).user}catch(t){throw console.error("Login failed:",t),alert(`Login failed: ${t.message}`),t}}async signInWithEmail(t,e){if(!K){alert("Firebase is not configured.");return}try{return(await Le(K,t,e)).user}catch(s){throw console.error("Email Login failed:",s),alert(`Login failed: ${s.message}`),s}}async signUpWithEmail(t,e){if(!K){alert("Firebase is not configured.");return}try{return(await xe(K,t,e)).user}catch(s){throw console.error("Sign Up failed:",s),alert(`Sign Up failed: ${s.message}`),s}}async signOut(){if(K)try{await Ie(K)}catch(t){throw console.error("Logout failed:",t),t}}updateUI(t){const e=document.getElementById("firebase-connect-btn"),s=document.getElementById("firebase-clear-cloud-btn"),n=document.getElementById("firebase-status"),a=document.getElementById("email-auth-container"),r=document.getElementById("toggle-email-auth-btn");e&&(t?(e.textContent="Sign Out",e.classList.add("danger"),e.onclick=()=>this.signOut(),s&&(s.style.display="block"),a&&(a.style.display="none"),r&&(r.style.display="none"),n&&(n.textContent=`Signed in as ${t.email}`)):(e.textContent="Connect with Google",e.classList.remove("danger"),e.onclick=()=>this.signInWithGoogle(),s&&(s.style.display="none"),r&&(r.style.display="inline-block"),n&&(n.textContent="Sync your library across devices")))}}const ut=new Ls;function xs(i,t,e,s){ut.updateUI(ut.user),ys();const n=document.getElementById("toggle-email-auth-btn"),a=document.getElementById("cancel-email-auth-btn"),r=document.getElementById("email-auth-container"),c=document.getElementById("auth-buttons-container"),o=document.getElementById("auth-email"),l=document.getElementById("auth-password"),d=document.getElementById("email-signin-btn"),m=document.getElementById("email-signup-btn");n&&r&&c&&n.addEventListener("click",()=>{r.style.display="flex",c.style.display="none"}),a&&r&&c&&a.addEventListener("click",()=>{r.style.display="none",c.style.display="flex"}),d&&d.addEventListener("click",async()=>{const k=o.value,I=l.value;if(!k||!I){alert("Please enter both email and password.");return}try{await ut.signInWithEmail(k,I),r.style.display="none",c.style.display="flex",o.value="",l.value=""}catch{}}),m&&m.addEventListener("click",async()=>{const k=o.value,I=l.value;if(!k||!I){alert("Please enter both email and password.");return}try{await ut.signUpWithEmail(k,I),r.style.display="none",c.style.display="flex",o.value="",l.value=""}catch{}});const u=document.getElementById("lastfm-connect-btn"),h=document.getElementById("lastfm-status"),f=document.getElementById("lastfm-toggle"),p=document.getElementById("lastfm-toggle-setting"),g=document.getElementById("lastfm-love-toggle"),w=document.getElementById("lastfm-love-setting");function b(){i.isAuthenticated()?(h.textContent=`Connected as ${i.username}`,u.textContent="Disconnect",u.classList.add("danger"),p.style.display="flex",w.style.display="flex",f.checked=Z.isEnabled(),g.checked=Z.shouldLoveOnLike()):(h.textContent="Connect your Last.fm account to scrobble tracks",u.textContent="Connect Last.fm",u.classList.remove("danger"),p.style.display="none",w.style.display="none")}b(),u?.addEventListener("click",async()=>{if(i.isAuthenticated()){confirm("Disconnect from Last.fm?")&&(i.disconnect(),b());return}const k=window.open("","_blank");u.disabled=!0,u.textContent="Opening Last.fm...";try{const{token:I,url:M}=await i.getAuthUrl();if(k)k.location.href=M;else{alert("Popup blocked! Please allow popups."),u.textContent="Connect Last.fm",u.disabled=!1;return}u.textContent="Waiting for authorization...";let P=0;const H=30,D=setInterval(async()=>{if(P++,P>H){clearInterval(D),u.textContent="Connect Last.fm",u.disabled=!1,k&&!k.closed&&k.close(),alert("Authorization timed out. Please try again.");return}try{const lt=await i.completeAuthentication(I);lt.success&&(clearInterval(D),k&&!k.closed&&k.close(),b(),u.disabled=!1,Z.setEnabled(!0),f.checked=!0,alert(`Successfully connected to Last.fm as ${lt.username}!`))}catch{}},2e3)}catch(I){console.error("Last.fm connection failed:",I),alert("Failed to connect to Last.fm: "+I.message),u.textContent="Connect Last.fm",u.disabled=!1,k&&!k.closed&&k.close()}}),f?.addEventListener("change",k=>{Z.setEnabled(k.target.checked)}),g?.addEventListener("change",k=>{Z.setLoveOnLike(k.target.checked)});const y=document.getElementById("theme-picker"),v=nt.getTheme();y.querySelectorAll(".theme-option").forEach(k=>{k.dataset.theme===v&&k.classList.add("active"),k.addEventListener("click",()=>{const I=k.dataset.theme;y.querySelectorAll(".theme-option").forEach(M=>M.classList.remove("active")),k.classList.add("active"),I==="custom"?(document.getElementById("custom-theme-editor").classList.add("show"),S()):(document.getElementById("custom-theme-editor").classList.remove("show"),nt.setTheme(I))})});function S(){const k=document.getElementById("theme-color-grid"),I=nt.getCustomTheme()||{background:"#000000",foreground:"#fafafa",primary:"#ffffff",secondary:"#27272a",muted:"#27272a",border:"#27272a",highlight:"#ffffff"};k.innerHTML=Object.entries(I).map(([M,P])=>`
            <div class="theme-color-input">
                <label>${M}</label>
                <input type="color" data-color="${M}" value="${P}">
            </div>
        `).join("")}document.getElementById("apply-custom-theme")?.addEventListener("click",()=>{const k={};document.querySelectorAll('#theme-color-grid input[type="color"]').forEach(I=>{k[I.dataset.color]=I.value}),nt.setCustomTheme(k)}),document.getElementById("reset-custom-theme")?.addEventListener("click",()=>{S()});const E=document.getElementById("quality-setting");if(E){const k=localStorage.getItem("playback-quality")||"LOSSLESS";E.value=k,t.setQuality(k),E.addEventListener("change",I=>{const M=I.target.value;t.setQuality(M),localStorage.setItem("playback-quality",M)})}const T=document.getElementById("now-playing-mode");T&&(T.value=Ht.getMode(),T.addEventListener("change",k=>{Ht.setMode(k.target.value)}));const L=document.getElementById("track-list-actions-mode");L&&(L.value=Rt.getMode(),L.addEventListener("change",k=>{Rt.setMode(k.target.value)}));const x=document.getElementById("compact-artist-toggle");x&&(x.checked=J.isCompactArtist(),x.addEventListener("change",k=>{J.setCompactArtist(k.target.checked)}));const _=document.getElementById("compact-album-toggle");_&&(_.checked=J.isCompactAlbum(),_.addEventListener("change",k=>{J.setCompactAlbum(k.target.checked)}));const U=document.getElementById("download-lyrics-toggle");U&&(U.checked=ht.shouldDownloadLyrics(),U.addEventListener("change",k=>{ht.setDownloadLyrics(k.target.checked)}));const C=document.getElementById("romaji-lyrics-toggle");C&&(C.checked=localStorage.getItem("lyricsRomajiMode")==="true",C.addEventListener("change",k=>{localStorage.setItem("lyricsRomajiMode",k.target.checked?"true":"false")}));const B=document.getElementById("album-background-toggle");B&&(B.checked=ot.isEnabled(),B.addEventListener("change",k=>{ot.setEnabled(k.target.checked)}));const N=document.getElementById("filename-template");N&&(N.value=localStorage.getItem("filename-template")||"{trackNumber} - {artist} - {title}",N.addEventListener("change",k=>{localStorage.setItem("filename-template",k.target.value)}));const $=document.getElementById("zip-folder-template");$&&($.value=localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",$.addEventListener("change",k=>{localStorage.setItem("zip-folder-template",k.target.value)})),document.getElementById("refresh-speed-test-btn")?.addEventListener("click",async()=>{const k=document.getElementById("refresh-speed-test-btn"),I=k.textContent;k.textContent="Testing...",k.disabled=!0;try{await e.settings.refreshSpeedTests(),s.renderApiSettings(),k.textContent="Done!",setTimeout(()=>{k.textContent=I,k.disabled=!1},1500)}catch(M){console.error("Failed to refresh speed tests:",M),k.textContent="Error",setTimeout(()=>{k.textContent=I,k.disabled=!1},1500)}}),document.getElementById("api-instance-list")?.addEventListener("click",async k=>{const I=k.target.closest("button");if(!I)return;const M=I.closest("li"),P=parseInt(M.dataset.index,10),H=M.dataset.type||"api",D=await e.settings.getInstances(H);I.classList.contains("move-up")&&P>0?[D[P],D[P-1]]=[D[P-1],D[P]]:I.classList.contains("move-down")&&P<D.length-1&&([D[P],D[P+1]]=[D[P+1],D[P]]),e.settings.saveInstances(D,H),s.renderApiSettings()}),document.getElementById("clear-cache-btn")?.addEventListener("click",async()=>{const k=document.getElementById("clear-cache-btn"),I=k.textContent;k.textContent="Clearing...",k.disabled=!0;try{await e.clearCache(),k.textContent="Cleared!",setTimeout(()=>{k.textContent=I,k.disabled=!1,window.location.hash.includes("settings")&&s.renderApiSettings()},1500)}catch(M){console.error("Failed to clear cache:",M),k.textContent="Error",setTimeout(()=>{k.textContent=I,k.disabled=!1},1500)}}),document.getElementById("firebase-clear-cloud-btn")?.addEventListener("click",async()=>{if(confirm("Are you sure you want to delete ALL your data from the cloud? This cannot be undone."))try{await q.clearCloudData(),alert("Cloud data cleared successfully."),ut.signOut()}catch(k){console.error("Failed to clear cloud data:",k),alert("Failed to clear cloud data: "+k.message)}}),document.getElementById("export-library-btn")?.addEventListener("click",async()=>{const k=await A.exportData(),I=new Blob([JSON.stringify(k,null,2)],{type:"application/json"}),M=URL.createObjectURL(I),P=document.createElement("a");P.href=M,P.download=`monochrome-library-${new Date().toISOString().split("T")[0]}.json`,P.click(),URL.revokeObjectURL(M)});const F=document.getElementById("import-library-input");document.getElementById("import-library-btn")?.addEventListener("click",()=>{F.click()}),F?.addEventListener("change",async k=>{const I=k.target.files[0];if(!I)return;const M=new FileReader;M.onload=async P=>{try{const H=JSON.parse(P.target.result);await A.importData(H),alert("Library imported successfully!"),window.location.reload()}catch(H){console.error("Import failed:",H),alert("Failed to import library. Please check the file format.")}},M.readAsText(I)})}const gt=new Map;let X=null;function _t(i,t,e){if(!e)return;const s=t?`${t}/cover.jpg`:"cover.jpg";i.file(s)||i.file(s,e)}async function Is(){try{return(await Mt(()=>import("https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm"),[],import.meta.url)).default}catch(i){throw console.error("Failed to load JSZip:",i),new Error("Failed to load ZIP library")}}function Dt(){return X||(X=document.createElement("div"),X.id="download-notifications",document.body.appendChild(X)),X}function z(i){const t=Dt(),e=document.createElement("div");e.className="download-task",e.innerHTML=`
        <div style="display: flex; align-items: start;">
            ${i}
        </div>
    `,t.appendChild(e),setTimeout(()=>{e.style.animation="slideOut 0.3s ease",setTimeout(()=>e.remove(),300)},1500)}function As(i,t,e,s){const n=Dt(),a=document.createElement("div");a.className="download-task",a.dataset.trackId=i;const r=Y(t);a.innerHTML=`
        <div style="display: flex; align-items: start; gap: 0.75rem;">
            <img src="${s.getCoverUrl(t.album?.cover)}"
                 style="width: 40px; height: 40px; border-radius: 4px; flex-shrink: 0;">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 500; font-size: 0.9rem; margin-bottom: 0.25rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${r}</div>
                <div style="font-size: 0.8rem; color: var(--muted-foreground); margin-bottom: 0.5rem;">${t.artist?.name||"Unknown"}</div>
                <div class="download-progress-bar" style="height: 4px; background: var(--secondary); border-radius: 2px; overflow: hidden;">
                    <div class="download-progress-fill" style="width: 0%; height: 100%; background: var(--highlight); transition: width 0.2s;"></div>
                </div>
                <div class="download-status" style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Starting...</div>
            </div>
            <button class="download-cancel" style="background: transparent; border: none; color: var(--muted-foreground); cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s;">
                ${It}
            </button>
        </div>
    `,n.appendChild(a);const c=new AbortController;return gt.set(i,{taskEl:a,abortController:c}),a.querySelector(".download-cancel").addEventListener("click",()=>{c.abort(),xt(i)}),{taskEl:a,abortController:c}}function Cs(i,t){const e=gt.get(i);if(!e)return;const{taskEl:s}=e,n=s.querySelector(".download-progress-fill"),a=s.querySelector(".download-status");if(t.stage==="downloading"){const r=t.totalBytes?Math.round(t.receivedBytes/t.totalBytes*100):0;n.style.width=`${r}%`;const c=(t.receivedBytes/(1024*1024)).toFixed(1),o=t.totalBytes?(t.totalBytes/(1024*1024)).toFixed(1):"?";a.textContent=`Downloading: ${c}MB / ${o}MB (${r}%)`}}function Xt(i,t=!0,e=null){const s=gt.get(i);if(!s)return;const{taskEl:n}=s,a=n.querySelector(".download-progress-fill"),r=n.querySelector(".download-status"),c=n.querySelector(".download-cancel");t?(a.style.width="100%",a.style.background="#10b981",r.textContent="✓ Downloaded",r.style.color="#10b981",c.remove(),setTimeout(()=>xt(i),3e3)):(a.style.background="#ef4444",r.textContent=e||"✗ Download failed",r.style.color="#ef4444",c.innerHTML=`
            ${It}
        `,c.onclick=()=>xt(i),setTimeout(()=>xt(i),5e3))}function xt(i){const t=gt.get(i);if(!t)return;const{taskEl:e}=t;e.style.animation="slideOut 0.3s ease",setTimeout(()=>{e.remove(),gt.delete(i),X&&X.children.length===0&&(X.remove(),X=null)},300)}async function ye(i,t,e,s=null){const n=await e.getTrack(i.id,t);let a;if(n.originalTrackUrl)a=n.originalTrackUrl;else if(a=e.extractStreamUrlFromManifest(n.info.manifest),!a)throw new Error("Could not resolve stream URL");const r=await fetch(a);if(!r.ok)throw new Error(`Failed to fetch track: ${r.status}`);let c=await r.blob();return c=await le(c,i,e,t),c}async function Ot(i,t,e,s,n=null){Nt(e,s,s,"Creating ZIP...");try{if(n){const a=await n.createWritable();await new Promise((r,c)=>{i.generateInternalStream({type:"uint8array",compression:"STORE",streamFiles:!0}).on("data",(o,l)=>{a.write(o)}).on("error",o=>{a.close(),c(o)}).on("end",()=>{a.close(),r()}).resume()})}else{const a=await i.generateAsync({type:"blob",compression:"STORE",streamFiles:!0}),r=URL.createObjectURL(a),c=document.createElement("a");c.href=r,c.download=`${t}.zip`,document.body.appendChild(c),c.click(),document.body.removeChild(c),URL.revokeObjectURL(r)}yt(e,!0)}catch(a){console.error("ZIP generation failed:",a),yt(e,!1,"ZIP creation failed")}}async function Ut(i,t=!1){const e=await Is(),s=new e;let n=null;if(t&&window.showSaveFilePicker)try{n=await window.showSaveFilePicker({suggestedName:`${i}.zip`,types:[{description:"ZIP Archive",accept:{"application/zip":[".zip"]}}]})}catch(a){if(a.name==="AbortError")return null;throw a}return{zip:s,fileHandle:n}}async function be(i,t,e,s,n,a,r,c=0,o=t.length){for(let l=0;l<t.length;l++){const d=t[l],m=c+l,u=At(d,n),h=Y(d);Nt(r,m,o,h);try{const f=await ye(d,n,s);if(i.file(`${e}/${u}`,f),a&&ht.shouldDownloadLyrics())try{const p=await a.fetchLyrics(d.id,d);if(p){const g=a.generateLRCContent(p,d);if(g){const w=u.replace(/\.[^.]+$/,".lrc");i.file(`${e}/${w}`,g)}}}catch{console.log("Could not add lyrics for:",h)}}catch(f){console.error(`Failed to download track ${h}:`,f)}}}async function Ms(i,t,e,s,n=null){const a=i.releaseDate||(t[0]?.streamStartDate?t[0].streamStartDate.split("T")[0]:""),r=a?new Date(a):null,c=r&&!isNaN(r.getTime())?r.getFullYear():"",o=Ct(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:i.title,albumArtist:i.artist?.name,year:c}),l=await Ut(o,t.length>=20);if(!l)return;const{zip:d,fileHandle:m}=l,u=await bt(e,i.cover||i.album?.cover||i.coverId),h=jt("album",i.title,t.length);try{_t(d,o,u),await be(d,t,o,e,s,n,h),await Ot(d,o,h,t.length,m)}catch(f){throw yt(h,!1,f.message),f}}async function Zt(i,t,e,s,n=null){const a=Ct(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:i.title,albumArtist:"Playlist",year:new Date().getFullYear()}),r=await Ut(a,t.length>=20);if(!r)return;const{zip:c,fileHandle:o}=r,l=jt("playlist",i.title,t.length);try{const d=t.find(u=>u.album?.cover),m=await bt(e,d?.album?.cover);_t(c,a,m),await be(c,t,a,e,s,n,l),await Ot(c,a,l,t.length,o)}catch(d){throw yt(l,!1,d.message),d}}async function Bs(i,t,e,s=null){const n=`${rt(i.name)} discography`,a=await Ut(n,!0);if(!a)return;const{zip:r,fileHandle:c}=a,o=[...i.albums||[],...i.eps||[]],l=jt("discography",i.name);try{for(let d=0;d<o.length;d++){const m=o[d];Nt(l,d,o.length,m.title);try{const{album:u,tracks:h}=await t.getAlbum(m.id),f=await bt(t,u.cover||m.cover),p=u.releaseDate||(h[0]?.streamStartDate?h[0].streamStartDate.split("T")[0]:""),g=p?new Date(p):null,w=g&&!isNaN(g.getTime())?g.getFullYear():"",b=Ct(localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",{albumTitle:u.title,albumArtist:u.artist?.name,year:w}),y=`${n}/${b}`;_t(r,y,f);for(const v of h){const S=At(v,e);try{const E=await ye(v,e,t);if(r.file(`${y}/${S}`,E),s&&ht.shouldDownloadLyrics())try{const T=await s.fetchLyrics(v.id,v);if(T){const L=s.generateLRCContent(T,v);if(L){const x=S.replace(/\.[^.]+$/,".lrc");r.file(`${y}/${x}`,L)}}}catch{}}catch(E){console.error(`Failed to download track ${v.title}:`,E)}}}catch(u){console.error(`Failed to download album ${m.title}:`,u)}}await Ot(r,n,l,o.length,c)}catch(d){throw yt(l,!1,d.message),d}}function jt(i,t,e){const s=Dt(),n=document.createElement("div");n.className="download-task bulk-download";const a=i==="album"?"Album":i==="playlist"?"Playlist":"Discography";return n.innerHTML=`
        <div style="display: flex; align-items: start; gap: 0.75rem;">
            <div style="flex: 1; min-width: 0;">
                <div style="font-weight: 600; font-size: 0.95rem; margin-bottom: 0.25rem;">
                    Downloading ${a}
                </div>
                <div style="font-size: 0.85rem; color: var(--muted-foreground); margin-bottom: 0.5rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${t}</div>
                <div class="download-progress-bar" style="height: 4px; background: var(--secondary); border-radius: 2px; overflow: hidden;">
                    <div class="download-progress-fill" style="width: 0%; height: 100%; background: var(--highlight); transition: width 0.2s;"></div>
                </div>
                <div class="download-status" style="font-size: 0.75rem; color: var(--muted-foreground); margin-top: 0.25rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">Starting...</div>
            </div>
        </div>
    `,s.appendChild(n),n}function Nt(i,t,e,s){const n=i.querySelector(".download-progress-fill"),a=i.querySelector(".download-status"),r=e>0?Math.round(t/e*100):0;n.style.width=`${r}%`,a.textContent=`${t}/${e} - ${s}`}function yt(i,t=!0,e=null){const s=i.querySelector(".download-progress-fill"),n=i.querySelector(".download-status");t?(s.style.width="100%",s.style.background="#10b981",n.textContent="✓ Download complete",n.style.color="#10b981",setTimeout(()=>{i.style.animation="slideOut 0.3s ease",setTimeout(()=>i.remove(),300)},3e3)):(s.style.background="#ef4444",n.textContent=e||"✗ Download failed",n.style.color="#ef4444",setTimeout(()=>{i.style.animation="slideOut 0.3s ease",setTimeout(()=>i.remove(),300)},5e3))}async function $s(i,t,e,s=null,n=null){if(!i){alert("No track is currently playing");return}const a=At(i,t),r=n||new AbortController;try{const{taskEl:c,taskAbortController:o}=As(i.id,i,a,e);if(await e.downloadTrack(i.id,t,a,{signal:r.signal,track:i,onProgress:l=>{Cs(i.id,l)}}),Xt(i.id,!0),s&&ht.shouldDownloadLyrics())try{const l=await s.fetchLyrics(i.id,i);l&&s.downloadLRC(l,i)}catch{console.log("Could not download lyrics for track")}}catch(c){if(c.name!=="AbortError"){const o=c.message===ie?c.message:"Download failed. Please try again.";Xt(i.id,!1,o)}}}function Ps(i,t,e,s){const n=document.querySelector(".play-pause-btn"),a=document.getElementById("next-btn"),r=document.getElementById("prev-btn"),c=document.getElementById("shuffle-btn"),o=document.getElementById("repeat-btn"),l=document.getElementById("sleep-timer-btn-desktop"),d=document.getElementById("sleep-timer-btn");let m=null;i.shuffleActive&&c.classList.add("active"),i.repeatMode!==Q.OFF?(o.classList.add("active"),i.repeatMode===Q.ONE&&o.classList.add("repeat-one"),o.title=i.repeatMode===Q.ALL?"Repeat Queue":"Repeat One"):o.title="Repeat",t.addEventListener("play",()=>{i.currentTrack&&e.isAuthenticated()&&Z.isEnabled()&&e.updateNowPlaying(i.currentTrack),n.innerHTML=$e,i.updateMediaSessionPlaybackState(),i.updateMediaSessionPositionState(),ge(i)}),t.addEventListener("playing",()=>{i.updateMediaSessionPlaybackState(),i.updateMediaSessionPositionState()}),t.addEventListener("pause",()=>{n.innerHTML=st,i.updateMediaSessionPlaybackState(),i.updateMediaSessionPositionState()}),t.addEventListener("ended",()=>{i.playNext()}),t.addEventListener("timeupdate",async()=>{const{currentTime:b,duration:y}=t;if(y){const v=document.getElementById("progress-fill"),S=document.getElementById("current-time");if(v.style.width=`${b/y*100}%`,S.textContent=mt(b),b>=10&&i.currentTrack&&i.currentTrack.id!==m){m=i.currentTrack.id;const E=await A.addToHistory(i.currentTrack);q.syncHistoryItem(E),window.location.hash==="#recent"&&s.renderRecentPage()}}}),t.addEventListener("loadedmetadata",()=>{const b=document.getElementById("total-duration");b.textContent=mt(t.duration),i.updateMediaSessionPositionState()}),t.addEventListener("error",b=>{console.error("Audio playback error:",b),document.querySelector(".now-playing-bar .artist").textContent="Playback error. Try another track.",n.innerHTML=st}),n.addEventListener("click",()=>i.handlePlayPause()),a.addEventListener("click",()=>i.playNext()),r.addEventListener("click",()=>i.playPrev()),c.addEventListener("click",()=>{i.toggleShuffle(),c.classList.toggle("active",i.shuffleActive),window.renderQueueFunction&&window.renderQueueFunction()}),o.addEventListener("click",()=>{const b=i.toggleRepeat();o.classList.toggle("active",b!==Q.OFF),o.classList.toggle("repeat-one",b===Q.ONE),o.title=b===Q.OFF?"Repeat":b===Q.ALL?"Repeat Queue":"Repeat One"}),l&&l.addEventListener("click",()=>{i.isSleepTimerActive()?(i.clearSleepTimer(),z("Sleep timer cancelled")):ee(i)}),d&&d.addEventListener("click",()=>{i.isSleepTimerActive()?(i.clearSleepTimer(),z("Sleep timer cancelled")):ee(i)});const u=document.getElementById("volume-bar"),h=document.getElementById("volume-fill"),f=document.getElementById("volume-btn"),p=()=>{const{volume:b,muted:y}=t;f.innerHTML=y||b===0?Fe:Pe;const v=y?0:b*100;h.style.setProperty("--volume-level",`${v}%`),h.style.width=`${v}%`};f.addEventListener("click",()=>{t.muted=!t.muted,localStorage.setItem("muted",t.muted)}),t.addEventListener("volumechange",p);const g=parseFloat(localStorage.getItem("volume")||"0.7"),w=localStorage.getItem("muted")==="true";t.volume=g,t.muted=w,h.style.width=`${g*100}%`,u.style.setProperty("--volume-level",`${g*100}%`),p(),Fs(t,i)}function Fs(i,t){const e=document.getElementById("progress-bar"),s=document.getElementById("progress-fill"),n=document.getElementById("volume-bar"),a=document.getElementById("volume-fill"),r=document.getElementById("volume-btn");let c=!1,o=!1,l=!1;const d=(m,u,h)=>{const f=m.getBoundingClientRect(),p=Math.max(0,Math.min(1,(u.clientX-f.left)/f.width));h(p)};e.addEventListener("mousedown",m=>{c=!0,o=!i.paused,o&&i.pause(),d(e,m,u=>{isNaN(i.duration)||(i.currentTime=u*i.duration,s.style.width=`${u*100}%`)})}),e.addEventListener("touchstart",m=>{m.preventDefault(),c=!0,o=!i.paused,o&&i.pause();const u=m.touches[0],h=e.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-h.left)/h.width));isNaN(i.duration)||(i.currentTime=f*i.duration,s.style.width=`${f*100}%`)}),document.addEventListener("mousemove",m=>{c&&d(e,m,u=>{isNaN(i.duration)||(i.currentTime=u*i.duration,s.style.width=`${u*100}%`)}),l&&d(n,m,u=>{i.volume=u,a.style.width=`${u*100}%`,n.style.setProperty("--volume-level",`${u*100}%`),localStorage.setItem("volume",u)})}),document.addEventListener("touchmove",m=>{if(c){const u=m.touches[0],h=e.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-h.left)/h.width));isNaN(i.duration)||(i.currentTime=f*i.duration,s.style.width=`${f*100}%`)}if(l){const u=m.touches[0],h=n.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-h.left)/h.width));i.volume=f,a.style.width=`${f*100}%`,n.style.setProperty("--volume-level",`${f*100}%`),localStorage.setItem("volume",f)}}),document.addEventListener("mouseup",m=>{c&&(d(e,m,u=>{isNaN(i.duration)||(i.currentTime=u*i.duration,t.updateMediaSessionPositionState(),o&&i.play())}),c=!1),l&&(l=!1)}),document.addEventListener("touchend",m=>{c&&(isNaN(i.duration)||(t.updateMediaSessionPositionState(),o&&i.play()),c=!1),l&&(l=!1)}),e.addEventListener("click",m=>{c||d(e,m,u=>{if(!isNaN(i.duration)&&i.duration>0&&i.duration!==1/0)i.currentTime=u*i.duration,t.updateMediaSessionPositionState();else if(t.currentTrack&&t.currentTrack.duration){const h=u*t.currentTrack.duration,f=document.querySelector(".progress-fill");f&&(f.style.width=`${u*100}%`),t.playTrackFromQueue(h)}})}),n.addEventListener("mousedown",m=>{l=!0,d(n,m,u=>{i.volume=u,a.style.width=`${u*100}%`,n.style.setProperty("--volume-level",`${u*100}%`),localStorage.setItem("volume",u)})}),n.addEventListener("touchstart",m=>{m.preventDefault(),l=!0;const u=m.touches[0],h=n.getBoundingClientRect(),f=Math.max(0,Math.min(1,(u.clientX-h.left)/h.width));i.volume=f,a.style.width=`${f*100}%`,n.style.setProperty("--volume-level",`${f*100}%`),localStorage.setItem("volume",f)}),n.addEventListener("click",m=>{l||d(n,m,u=>{i.volume=u,a.style.width=`${u*100}%`,n.style.setProperty("--volume-level",`${u*100}%`),localStorage.setItem("volume",u)})}),n.addEventListener("wheel",m=>{m.preventDefault();const u=m.deltaY>0?-.05:.05,h=Math.max(0,Math.min(1,i.volume+u));u>0&&i.muted&&(i.muted=!1,localStorage.setItem("muted",!1)),i.volume=h,a.style.width=`${h*100}%`,n.style.setProperty("--volume-level",`${h*100}%`),localStorage.setItem("volume",h)},{passive:!1}),r?.addEventListener("wheel",m=>{m.preventDefault();const u=m.deltaY>0?-.05:.05,h=Math.max(0,Math.min(1,i.volume+u));u>0&&i.muted&&(i.muted=!1,localStorage.setItem("muted",!1)),i.volume=h,a.style.width=`${h*100}%`,n.style.setProperty("--volume-level",`${h*100}%`),localStorage.setItem("volume",h)},{passive:!1})}async function et(i,t,e,s,n,a="track",r=null,c=null){if(t){if(i==="add-to-queue")e.addToQueue(t),window.renderQueueFunction&&window.renderQueueFunction(),z(`Added to queue: ${t.title}`);else if(i==="play-next")e.addNextToQueue(t),window.renderQueueFunction&&window.renderQueueFunction(),z(`Playing next: ${t.title}`);else if(i==="track-mix")t.mixes&&t.mixes.TRACK_MIX&&(window.location.hash=`#mix/${t.mixes.TRACK_MIX}`);else if(i==="play-card")try{let o=[];if(a==="album")o=(await s.getAlbum(t.id)).tracks;else if(a==="playlist")o=(await s.getPlaylist(t.uuid)).tracks;else if(a==="user-playlist"){let l=await A.getPlaylist(t.id);if(!l)try{l=await q.getPublicPlaylist(t.id)}catch{}o=l?l.tracks:t.tracks||[]}if(o.length>0){e.setQueue(o,0);const l=document.getElementById("shuffle-btn");l&&l.classList.remove("active"),e.playAtIndex(0);const d=a==="user-playlist"?t.name:t.title;z(`Playing ${a.replace("user-","")}: ${d}`)}else z(`No tracks found in this ${a}`)}catch(o){console.error("Failed to play card:",o),z(`Failed to play ${a}`)}else if(i==="download")await $s(t,e.quality,s,n);else if(i==="toggle-like"){const o=await A.toggleFavorite(a,t);q.syncLibraryItem(a,t,o),o&&a==="track"&&c&&Z.isEnabled()&&Z.shouldLoveOnLike()&&c.loveTrack(t);const l=a==="playlist"?t.uuid:t.id,d=a==="track"?`[data-track-id="${l}"] .like-btn`:`.card[data-${a}-id="${l}"] .like-btn, .card[data-playlist-id="${l}"] .like-btn`,m=document.getElementById(`like-${a}-btn`),u=[...document.querySelectorAll(d)];m&&u.push(m);const h=document.getElementById("now-playing-like-btn");if(h&&a==="track"&&e?.currentTrack?.id===t.id&&u.push(h),u.forEach(f=>{const p=f.querySelector("svg");p&&(p.classList.toggle("filled",o),p.hasAttribute("fill")&&p.setAttribute("fill",o?"currentColor":"none")),f.classList.toggle("active",o),f.title=o?"Remove from Favorites":"Add to Favorites"}),window.location.hash==="#library"){const f=a==="track"?`.track-item[data-track-id="${l}"]`:`.card[data-${a}-id="${l}"], .card[data-playlist-id="${l}"]`,p=document.querySelector(f);if(!o&&p){const g=p.parentElement;if(p.remove(),g&&g.children.length===0){const w=a==="track"?"No liked tracks yet.":`No liked ${a}s yet.`;g.innerHTML=`<div class="placeholder-text">${w}</div>`}}else if(o&&!p&&r&&a==="track"){const g=document.getElementById("library-tracks-container");if(g){const w=g.querySelector(".placeholder-text");w&&w.remove();const b=g.children.length,y=r.createTrackItemHTML(t,b,!0,!1),v=document.createElement("div");v.innerHTML=y;const S=v.firstElementChild;S&&(g.appendChild(S),R.set(S,t),r.updateLikeState(S,"track",t.id))}}}}else if(i==="add-to-playlist"){const o=await A.getPlaylists();if(o.length===0){z("No playlists yet. Create one first.");return}const l=document.createElement("div");l.className="playlist-select-modal",l.innerHTML=`
            <div class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
                <div class="modal-content" style="background: var(--card); padding: 2rem; border-radius: var(--radius); max-width: 400px; width: 90%;">
                    <h3>Add to Playlist</h3>
                    <div id="playlist-list" style="margin: 1rem 0; max-height: 200px; overflow-y: auto;">
                        ${o.map(d=>`<div class="playlist-option" data-id="${d.id}" style="padding: 0.5rem; cursor: pointer; border-bottom: 1px solid var(--border);">${d.name}</div>`).join("")}
                    </div>
                    <div class="modal-actions" style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                        <button id="cancel-add-playlist" class="btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        `,document.body.appendChild(l),l.addEventListener("click",async d=>{if(d.target.id==="cancel-add-playlist"){l.remove();return}const m=d.target.closest(".playlist-option");if(m){const u=m.dataset.id;await A.addTrackToPlaylist(u,t);const h=await A.getPlaylist(u);q.syncUserPlaylist(h,"update"),z(`Added to playlist: ${m.textContent}`),l.remove()}})}}}async function te(i,t){if(!i||!t)return;const e=i.querySelector('li[data-action="toggle-like"]');if(e){const{db:n}=await Mt(async()=>{const{db:r}=await Promise.resolve().then(()=>cs);return{db:r}},void 0,import.meta.url),a=await n.isFavorite("track",t.id);e.textContent=a?"Unlike":"Like"}const s=i.querySelector('li[data-action="track-mix"]');if(s){const n=t.mixes&&t.mixes.TRACK_MIX;s.style.display=n?"block":"none"}}function Hs(i,t,e,s,n,a,r){let c=null;e.addEventListener("click",async u=>{const h=u.target.closest(".track-action-btn, .like-btn, .play-btn");if(h&&h.dataset.action){u.preventDefault(),u.stopPropagation();const w=h.closest(".track-item, .card"),b=h.dataset.action,y=h.dataset.type||"track";let v=w?R.get(w):null;if(!v&&b==="toggle-like"){const S=window.location.hash.split("/")[1];if(S)try{y==="album"?v=(await t.getAlbum(S)).album:y==="artist"?v=await t.getArtist(S):y==="playlist"?v=(await t.getPlaylist(S)).playlist:y==="mix"&&(v=(await t.getMix(S)).mix)}catch(E){console.error(E)}}v&&await et(b,v,i,t,n,y,a,r);return}const f=u.target.closest(".track-menu-btn");if(f){u.stopPropagation();const w=f.closest(".track-item");if(w&&!w.dataset.queueIndex){const b=R.get(w);if(s.style.display==="block"&&c&&b&&c.id===b.id){s.style.display="none";return}if(c=b,c){await te(s,c);const y=f.getBoundingClientRect();se(s,y.left,y.bottom+5,y)}}return}const p=u.target.closest(".track-item");if(p&&!p.dataset.queueIndex&&!u.target.closest(".remove-from-playlist-btn")){const w=p.closest(".track-list"),y=Array.from(w.querySelectorAll(".track-item")).map(v=>R.get(v)).filter(Boolean);if(y.length>0){const v=p.dataset.trackId,S=y.findIndex(E=>E.id==v);i.setQueue(y,S),document.getElementById("shuffle-btn").classList.remove("active"),i.playTrackFromQueue()}}const g=u.target.closest(".card");if(g){if(u.target.closest(".edit-playlist-btn")||u.target.closest(".delete-playlist-btn"))return;const w=g.dataset.href;if(w){if(u.target.closest("a"))return;u.preventDefault(),window.location.hash=w}}}),e.addEventListener("contextmenu",async u=>{const h=u.target.closest(".track-item");h&&!h.dataset.queueIndex&&(u.preventDefault(),c=R.get(h),c&&(await te(s,c),se(s,u.pageX,u.pageY)))}),document.addEventListener("click",()=>{s.style.display="none"}),s.addEventListener("click",async u=>{u.stopPropagation();const h=u.target.dataset.action;h&&c&&await et(h,c,i,t,n,"track",a,r),s.style.display="none"}),document.querySelector(".now-playing-bar .title").addEventListener("click",()=>{const u=i.currentTrack;u?.album?.id&&(window.location.hash=`#album/${u.album.id}`)}),document.querySelector(".now-playing-bar .artist").addEventListener("click",u=>{const h=u.target.closest(".artist-link");if(h){u.stopPropagation();const p=h.dataset.artistId;p&&(window.location.hash=`#artist/${p}`);return}const f=i.currentTrack;f?.artist?.id&&(window.location.hash=`#artist/${f.artist.id}`)});const o=document.getElementById("now-playing-like-btn");o&&o.addEventListener("click",async u=>{u.stopPropagation(),i.currentTrack&&await et("toggle-like",i.currentTrack,i,t,n,"track",a,r)});const l=document.getElementById("now-playing-mix-btn");l&&l.addEventListener("click",async u=>{u.stopPropagation(),i.currentTrack&&await et("track-mix",i.currentTrack,i,t,n,"track",a,r)});const d=document.getElementById("now-playing-add-playlist-btn");d&&d.addEventListener("click",async u=>{u.stopPropagation(),i.currentTrack&&await et("add-to-playlist",i.currentTrack,i,t,n,"track",a,r)});const m=document.getElementById("mobile-add-playlist-btn");m&&m.addEventListener("click",async u=>{u.stopPropagation(),i.currentTrack&&await et("add-to-playlist",i.currentTrack,i,t,n,"track",a,r)})}function ee(i){const t=document.createElement("div");t.className="sleep-timer-modal",t.innerHTML=`
        <div class="modal-overlay" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: flex; align-items: center; justify-content: center;">
            <div class="modal-content" style="background: var(--card); padding: 2rem; border-radius: var(--radius); max-width: 300px; width: 90%;">
                <h3 style="text-align: center; margin-bottom: 1.5rem;">Sleep Timer</h3>
                <div class="timer-options" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button class="timer-option btn-secondary" data-minutes="5">5 minutes</button>
                    <button class="timer-option btn-secondary" data-minutes="15">15 minutes</button>
                    <button class="timer-option btn-secondary" data-minutes="30">30 minutes</button>
                    <button class="timer-option btn-secondary" data-minutes="60">1 hour</button>
                    <button class="timer-option btn-secondary" data-minutes="120">2 hours</button>
                    <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                        <input type="number" id="custom-minutes" placeholder="Custom" min="1" max="480" style="flex: 1; padding: 0.5rem; border: 1px solid var(--border); border-radius: var(--radius); background: var(--background); color: var(--foreground);">
                        <button class="timer-option btn-primary" id="custom-timer-btn" style="padding: 0.5rem 1rem;">Set</button>
                    </div>
                </div>
                <div class="modal-actions" style="display: flex; gap: 0.5rem; justify-content: center; margin-top: 1.5rem;">
                    <button id="cancel-sleep-timer" class="btn-secondary">Cancel</button>
                </div>
            </div>
        </div>
    `,document.body.appendChild(t),t.addEventListener("click",e=>{if(e.target.id==="cancel-sleep-timer"||e.target.classList.contains("modal-overlay")){t.remove();return}const s=e.target.closest(".timer-option");if(s){const n=parseInt(s.dataset.minutes);n&&(i.setSleepTimer(n),z(`Sleep timer set for ${n} minute${n===1?"":"s"}`),t.remove())}if(e.target.id==="custom-timer-btn"){const n=document.getElementById("custom-minutes"),a=parseInt(n.value);a&&a>0&&a<=480?(i.setSleepTimer(a),z(`Sleep timer set for ${a} minute${a===1?"":"s"}`),t.remove()):z("Please enter a valid number of minutes (1-480)")}})}function se(i,t,e,s=null){i.style.visibility="hidden",i.style.display="block";const n=i.offsetWidth,a=i.offsetHeight,r=window.innerWidth,c=window.innerHeight;let o=t,l=e;s?(o+n>r-10&&(o=s.right-n,o<10&&(o=10)),l+a>c-10&&(l=s.top-a-5)):(o+n>r-10&&(o=r-n-10),l+a>c-10&&(l=e-a)),i.style.top=`${l}px`,i.style.left=`${o}px`,i.style.visibility="visible"}function Rs(i,t){const e=document.querySelector(".sidebar"),s=document.getElementById("sidebar-overlay"),n=document.getElementById("hamburger-btn"),a=document.getElementById("queue-btn");let r=null;n.addEventListener("click",()=>{e.classList.add("is-open"),s.classList.add("is-visible")});const c=()=>{e.classList.remove("is-open"),s.classList.remove("is-visible")};s.addEventListener("click",c),e.addEventListener("click",u=>{u.target.closest("a")&&c()});const o=u=>{const f=i.getCurrentQueue().length>0;u.innerHTML=`
            <button id="clear-queue-btn" class="btn-icon" title="Clear Queue" style="display: ${f?"flex":"none"}">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></svg>
            </button>
            <button id="close-side-panel-btn" class="btn-icon" title="Close">
                ${It}
            </button>
        `,u.querySelector("#close-side-panel-btn").addEventListener("click",()=>{j.close()});const p=u.querySelector("#clear-queue-btn");p&&p.addEventListener("click",()=>{i.clearQueue(),d()})},l=u=>{const h=i.getCurrentQueue();if(h.length===0){u.innerHTML='<div class="placeholder-text">Queue is empty.</div>';return}const f=h.map((p,g)=>{const w=g===i.currentQueueIndex,b=Y(p),y=G(p,{fallback:"Unknown"});return`
                <div class="queue-track-item ${w?"playing":""}" data-queue-index="${g}" data-track-id="${p.id}" draggable="true">
                    <div class="drag-handle">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="5" y1="8" x2="19" y2="8"></line>
                            <line x1="5" y1="16" x2="19" y2="16"></line>
                        </svg>
                    </div>
                    <div class="track-item-info">
                        <img src="${t.getCoverUrl(p.album?.cover)}"
                             class="track-item-cover" loading="lazy">
                        <div class="track-item-details">
                            <div class="title">${b}</div>
                            <div class="artist">${y}</div>
                        </div>
                    </div>
                    <div class="track-item-duration">${mt(p.duration)}</div>
                    <button class="queue-remove-btn" data-track-index="${g}" title="Remove from queue">
                        ${Re}
                    </button>
                </div>
            `}).join("");u.innerHTML=f,u.querySelectorAll(".queue-track-item").forEach(p=>{const g=parseInt(p.dataset.queueIndex);p.addEventListener("click",w=>{if(w.target.closest(".queue-remove-btn")){w.stopPropagation(),i.removeFromQueue(g),d();return}i.playAtIndex(g),d()}),p.addEventListener("dragstart",w=>{r=g,p.style.opacity="0.5"}),p.addEventListener("dragend",()=>{p.style.opacity="1"}),p.addEventListener("dragover",w=>{w.preventDefault()}),p.addEventListener("drop",w=>{w.preventDefault(),r!==null&&r!==g&&(i.moveInQueue(r,g),d())})})},d=()=>{j.refresh("queue",o,l)},m=()=>{j.open("queue","Queue",o,l)};a.addEventListener("click",m),window.renderQueueFunction=()=>{j.isActive("queue")&&d()},document.querySelectorAll(".search-tab").forEach(u=>{u.addEventListener("click",()=>{const h=u.closest(".page");if(!h)return;h.querySelectorAll(".search-tab").forEach(g=>g.classList.remove("active")),h.querySelectorAll(".search-tab-content").forEach(g=>g.classList.remove("active")),u.classList.add("active");const p=`${h.id==="page-library"?"library-tab-":"search-tab-"}${u.dataset.tab}`;document.getElementById(p)?.classList.add("active")})})}function _s(i={}){const{immediate:t=!1,onNeedRefresh:e,onOfflineReady:s,onRegistered:n,onRegisteredSW:a,onRegisterError:r}=i;let c,o,l;const d=async(u=!0)=>{await o,l?.()};async function m(){if("serviceWorker"in navigator){if(c=await Mt(async()=>{const{Workbox:u}=await import("./workbox-window.prod.es5-BIl4cyR9.js");return{Workbox:u}},[],import.meta.url).then(({Workbox:u})=>new u("./sw.js",{scope:"./",type:"classic"})).catch(u=>{r?.(u)}),!c)return;l=()=>{c?.messageSkipWaiting()};{let u=!1;const h=()=>{u=!0,c?.addEventListener("controlling",f=>{f.isUpdate&&window.location.reload()}),e?.()};c.addEventListener("installed",f=>{typeof f.isUpdate>"u"?typeof f.isExternal<"u"&&f.isExternal?h():!u&&s?.():f.isUpdate||s?.()}),c.addEventListener("waiting",h)}c.register({immediate:t}).then(u=>{a?a("./sw.js",u):n?.(u)}).catch(u=>{r?.(u)})}}return o=m(),d}function Ds(i,t){document.addEventListener("keydown",e=>{if(!e.target.matches("input, textarea"))switch(e.key.toLowerCase()){case" ":e.preventDefault(),i.handlePlayPause();break;case"arrowright":e.shiftKey?i.playNext():t.currentTime=Math.min(t.duration,t.currentTime+10);break;case"arrowleft":e.shiftKey?i.playPrev():t.currentTime=Math.max(0,t.currentTime-10);break;case"arrowup":e.preventDefault(),t.volume=Math.min(1,t.volume+.1);break;case"arrowdown":e.preventDefault(),t.volume=Math.max(0,t.volume-.1);break;case"m":t.muted=!t.muted;break;case"s":document.getElementById("shuffle-btn")?.click();break;case"r":document.getElementById("repeat-btn")?.click();break;case"q":document.getElementById("queue-btn")?.click();break;case"/":e.preventDefault(),document.getElementById("search-input")?.focus();break;case"escape":document.getElementById("search-input")?.blur(),j.close(),ft(t,j.panel);break;case"l":document.querySelector(".now-playing-bar .cover")?.click();break}})}function Os(){const i=document.createElement("div");i.className="offline-notification",i.innerHTML=`
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
            <line x1="12" y1="9" x2="12" y2="13"/>
            <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
        <span>You are offline. Some features may not work.</span>
    `,document.body.appendChild(i),setTimeout(()=>{i.style.animation="slideOut 0.3s ease forwards",setTimeout(()=>i.remove(),300)},5e3)}function Us(){const i=document.querySelector(".offline-notification");i&&(i.style.animation="slideOut 0.3s ease forwards",setTimeout(()=>i.remove(),300))}document.addEventListener("DOMContentLoaded",async()=>{const i=new is(as),t=document.getElementById("audio-player"),e=localStorage.getItem("playback-quality")||"LOSSLESS",s=new vs(t,i,e),n=new ws(i,s),a=new Ss,r=new ue(i);r.loadKuroshiro().catch(b=>{console.warn("Failed to pre-load Kuroshiro:",b)});const c=nt.getTheme();nt.setTheme(c),Rt.getMode(),xs(a,s,i,n),Ps(s,t,a,n),Hs(s,i,document.querySelector(".main-content"),document.getElementById("context-menu"),r,n,a),Rs(s,i),Ds(s,t),s.currentTrack&&n.setCurrentTrack(s.currentTrack),document.querySelector(".now-playing-bar .cover").addEventListener("click",async()=>{if(!s.currentTrack){alert("No track is currently playing");return}const b=Ht.getMode();if(b==="lyrics")j.isActive("lyrics")?(j.close(),ft(t,j.panel)):Lt(s.currentTrack,t,r);else if(b==="cover"){const y=document.getElementById("fullscreen-cover-overlay");if(y&&y.style.display==="flex")n.closeFullscreenCover();else{const v=s.getNextTrack();n.showFullscreenCover(s.currentTrack,v,r,t)}}else s.currentTrack.album?.id&&(window.location.hash=`#album/${s.currentTrack.album.id}`)}),document.getElementById("playlist-public-toggle")?.addEventListener("change",b=>{const y=document.getElementById("playlist-share-btn");y&&(y.style.display=b.target.checked?"flex":"none")}),document.getElementById("close-fullscreen-cover-btn")?.addEventListener("click",()=>{n.closeFullscreenCover()}),document.getElementById("fullscreen-cover-image")?.addEventListener("click",()=>{n.closeFullscreenCover()}),document.getElementById("nav-back")?.addEventListener("click",()=>{window.history.back()}),document.getElementById("nav-forward")?.addEventListener("click",()=>{window.history.forward()}),document.getElementById("toggle-lyrics-btn")?.addEventListener("click",async b=>{if(b.stopPropagation(),!s.currentTrack){alert("No track is currently playing");return}j.isActive("lyrics")?(j.close(),ft(t,j.panel)):Lt(s.currentTrack,t,r)}),document.getElementById("download-current-btn")?.addEventListener("click",()=>{s.currentTrack&&et("download",s.currentTrack,s,i,r,"track",n)});let o=null;t.addEventListener("play",async()=>{if(!s.currentTrack)return;n.setCurrentTrack(s.currentTrack);const b=s.currentTrack.id;if(b===o)return;o=b,j.isActive("lyrics")&&Lt(s.currentTrack,t,r);const y=document.getElementById("fullscreen-cover-overlay");if(y&&getComputedStyle(y).display!=="none"){const v=s.getNextTrack();n.showFullscreenCover(s.currentTrack,v,r,t)}}),document.addEventListener("click",async b=>{if(b.target.closest("#play-album-btn")){if(b.target.closest("#play-album-btn").disabled)return;const v=window.location.hash.split("/")[1];if(!v)return;try{const{tracks:S}=await i.getAlbum(v);S.length>0&&(s.setQueue(S,0),document.getElementById("shuffle-btn").classList.remove("active"),s.playTrackFromQueue())}catch(S){console.error("Failed to play album:",S),alert("Failed to play album: "+S.message)}}if(b.target.closest("#download-mix-btn")){const y=b.target.closest("#download-mix-btn");if(y.disabled)return;const v=window.location.hash.split("#mix/")[1];if(!v)return;y.disabled=!0;const S=y.innerHTML;y.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{const{mix:E,tracks:T}=await i.getMix(v);await Zt(E,T,i,s.quality,r)}catch(E){console.error("Mix download failed:",E),alert("Failed to download mix: "+E.message)}finally{y.disabled=!1,y.innerHTML=S}}if(b.target.closest("#download-playlist-btn")){const y=b.target.closest("#download-playlist-btn");if(y.disabled)return;const v=window.location.hash.split("/")[1];if(!v)return;y.disabled=!0;const S=y.innerHTML;y.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{let E,T,L=await A.getPlaylist(v);if(!L)try{L=await q.getPublicPlaylist(v)}catch{}if(L)E={...L,title:L.name||L.title},T=L.tracks||[];else{const x=await i.getPlaylist(v);E=x.playlist,T=x.tracks}await Zt(E,T,i,s.quality,r)}catch(E){console.error("Playlist download failed:",E),alert("Failed to download playlist: "+E.message)}finally{y.disabled=!1,y.innerHTML=S}}if(b.target.closest("#create-playlist-btn")){const y=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Create Playlist",document.getElementById("playlist-name-input").value="",y.dataset.editingId="",document.getElementById("csv-import-section").style.display="block",document.getElementById("csv-file-input").value="";const v=document.getElementById("playlist-public-toggle"),S=document.getElementById("playlist-share-btn");v&&(v.checked=!1),S&&(S.style.display="none"),y.style.display="flex",document.getElementById("playlist-name-input").focus()}if(b.target.closest("#playlist-modal-save")){const y=document.getElementById("playlist-name-input").value.trim(),v=document.getElementById("playlist-public-toggle")?.checked;if(y){const S=document.getElementById("playlist-modal"),E=S.dataset.editingId,T=async L=>{if(L.isPublic=v,v)try{await q.publishPlaylist(L)}catch(x){console.error("Failed to publish playlist:",x),alert("Failed to publish playlist. Please ensure you are logged in.")}else try{await q.unpublishPlaylist(L.id)}catch{}return L};if(E)A.getPlaylist(E).then(async L=>{L&&(L.name=y,await T(L),await A.performTransaction("user_playlists","readwrite",x=>x.put(L)),q.syncUserPlaylist(L,"update"),n.renderLibraryPage(),window.location.hash===`#userplaylist/${E}`&&n.renderPlaylistPage(E,"user"),S.style.display="none",delete S.dataset.editingId)});else{const L=document.getElementById("csv-file-input");let x=[];if(L.files.length>0){const _=L.files[0],U=document.getElementById("csv-import-progress"),C=document.getElementById("csv-progress-fill"),B=document.getElementById("csv-progress-current"),N=document.getElementById("csv-progress-total"),$=U.querySelector(".current-track");try{U.style.display="block",C.style.width="0%",B.textContent="0",$.textContent="Reading CSV file...";const F=await _.text(),k=F.trim().split(`
`),I=Math.max(0,k.length-1);N.textContent=I.toString();const M=await Qs(F,i,H=>{const D=I>0?H.current/I*100:0;C.style.width=`${Math.min(D,100)}%`,B.textContent=H.current.toString(),$.textContent=H.currentTrack});x=M.tracks;const P=M.missingTracks;if(x.length===0){alert("No valid tracks found in the CSV file! Please check the format."),U.style.display="none";return}console.log(`Imported ${x.length} tracks from CSV`),P.length>0&&setTimeout(()=>{qs(P)},500)}catch(F){console.error("Failed to parse CSV!",F),alert("Failed to parse CSV file! "+F.message),U.style.display="none";return}finally{setTimeout(()=>{U.style.display="none"},1e3)}}A.createPlaylist(y,x,"").then(async _=>{await T(_),await A.performTransaction("user_playlists","readwrite",U=>U.put(_)),q.syncUserPlaylist(_,"create"),n.renderLibraryPage(),S.style.display="none"})}}}if(b.target.closest("#playlist-modal-cancel")&&(document.getElementById("playlist-modal").style.display="none"),b.target.closest(".edit-playlist-btn")){const v=b.target.closest(".user-playlist").dataset.userPlaylistId;A.getPlaylist(v).then(async S=>{if(S){const E=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Edit Playlist",document.getElementById("playlist-name-input").value=S.name;const T=document.getElementById("playlist-public-toggle"),L=document.getElementById("playlist-share-btn");T&&(T.checked=!!S.isPublic),L&&(L.style.display=S.isPublic?"flex":"none",L.onclick=()=>{const x=`${window.location.origin}${window.location.pathname}#userplaylist/${S.id}`;navigator.clipboard.writeText(x).then(()=>alert("Link copied to clipboard!"))}),E.dataset.editingId=v,document.getElementById("csv-import-section").style.display="none",E.style.display="flex",document.getElementById("playlist-name-input").focus()}})}if(b.target.closest(".delete-playlist-btn")){const v=b.target.closest(".user-playlist").dataset.userPlaylistId;confirm("Are you sure you want to delete this playlist?")&&A.deletePlaylist(v).then(()=>{q.syncUserPlaylist({id:v},"delete"),n.renderLibraryPage()})}if(b.target.closest("#edit-playlist-btn")){const y=window.location.hash.split("/")[1];A.getPlaylist(y).then(v=>{if(v){const S=document.getElementById("playlist-modal");document.getElementById("playlist-modal-title").textContent="Edit Playlist",document.getElementById("playlist-name-input").value=v.name;const E=document.getElementById("playlist-public-toggle"),T=document.getElementById("playlist-share-btn");E&&(E.checked=!!v.isPublic),T&&(T.style.display=v.isPublic?"flex":"none",T.onclick=()=>{const L=`${window.location.origin}${window.location.pathname}#userplaylist/${v.id}`;navigator.clipboard.writeText(L).then(()=>alert("Link copied to clipboard!"))}),S.dataset.editingId=y,document.getElementById("csv-import-section").style.display="none",S.style.display="flex",document.getElementById("playlist-name-input").focus()}})}if(b.target.closest("#delete-playlist-btn")){const y=window.location.hash.split("/")[1];confirm("Are you sure you want to delete this playlist?")&&A.deletePlaylist(y).then(()=>{window.location.hash="#library"})}if(b.target.closest(".remove-from-playlist-btn")){b.stopPropagation();const y=b.target.closest(".remove-from-playlist-btn"),v=parseInt(y.dataset.trackIndex),S=window.location.hash.split("/")[1];A.getPlaylist(S).then(async E=>{if(E&&E.tracks[v]){const T=E.tracks[v].id,L=await A.removeTrackFromPlaylist(S,T);q.syncUserPlaylist(L,"update"),n.renderPlaylistPage(S,"user")}})}if(b.target.closest("#play-playlist-btn")){if(b.target.closest("#play-playlist-btn").disabled)return;const v=window.location.hash.split("/")[1];if(!v)return;try{let S;const E=await A.getPlaylist(v);if(E)S=E.tracks;else try{const{tracks:T}=await i.getPlaylist(v);S=T}catch(T){const L=await q.getPublicPlaylist(v);if(L)S=L.tracks;else throw T}S.length>0&&(s.setQueue(S,0),document.getElementById("shuffle-btn").classList.remove("active"),s.playTrackFromQueue())}catch(S){console.error("Failed to play playlist:",S),alert("Failed to play playlist: "+S.message)}}if(b.target.closest("#download-album-btn")){const y=b.target.closest("#download-album-btn");if(y.disabled)return;const v=window.location.hash.split("/")[1];if(!v)return;y.disabled=!0;const S=y.innerHTML;y.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{const{album:E,tracks:T}=await i.getAlbum(v);await Ms(E,T,i,s.quality,r)}catch(E){console.error("Album download failed:",E),alert("Failed to download album: "+E.message)}finally{y.disabled=!1,y.innerHTML=S}}if(b.target.closest("#play-artist-radio-btn")){const y=b.target.closest("#play-artist-radio-btn");if(y.disabled)return;const v=window.location.hash.split("/")[1];if(!v)return;y.disabled=!0;const S=y.innerHTML;y.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Loading...</span>';try{const E=await i.getArtist(v),T=[...E.albums||[],...E.eps||[]];if(T.length===0)throw new Error("No albums or EPs found for this artist");const L=new Set,x=[],_=[],U=3,C=T;for(let B=0;B<C.length;B+=U)_.push(C.slice(B,B+U));for(const B of _)await Promise.all(B.map(async N=>{try{const{tracks:$}=await i.getAlbum(N.id);$.forEach(F=>{L.has(F.id)||(L.add(F.id),x.push(F))})}catch($){console.warn(`Failed to fetch tracks for album ${N.title}:`,$)}}));if(x.length>0){for(let B=x.length-1;B>0;B--){const N=Math.floor(Math.random()*(B+1));[x[B],x[N]]=[x[N],x[B]]}s.setQueue(x,0),s.playTrackFromQueue()}else throw new Error("No tracks found across all albums")}catch(E){console.error("Artist radio failed:",E),alert("Failed to start artist radio: "+E.message)}finally{document.body.contains(y)&&(y.disabled=!1,y.innerHTML=S)}}if(b.target.closest("#download-discography-btn")){const y=b.target.closest("#download-discography-btn");if(y.disabled)return;const v=window.location.hash.split("/")[1];if(!v)return;y.disabled=!0;const S=y.innerHTML;y.innerHTML='<svg class="animate-spin" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle></svg><span>Downloading...</span>';try{const E=await i.getArtist(v);await Bs(E,i,s.quality,r)}catch(E){console.error("Discography download failed:",E),alert("Failed to download discography: "+E.message)}finally{y.disabled=!1,y.innerHTML=S}}});const l=document.getElementById("search-form"),d=document.getElementById("search-input"),m=Oe(b=>{b&&(window.location.hash=`#search/${encodeURIComponent(b)}`)},300);d.addEventListener("input",b=>{const y=b.target.value.trim();y.length>2&&m(y)}),l.addEventListener("submit",b=>{b.preventDefault();const y=d.value.trim();y&&(window.location.hash=`#search/${encodeURIComponent(y)}`)}),window.addEventListener("online",()=>{Us(),console.log("Back online")}),window.addEventListener("offline",()=>{Os(),console.log("Gone offline")}),document.querySelector(".play-pause-btn").innerHTML=st;const u=Es(n);u(),window.addEventListener("hashchange",u);const h=[window.location.hash];let f=0;const p=()=>{const b=document.getElementById("nav-back"),y=document.getElementById("nav-forward");b&&(b.disabled=f<=0),y&&(y.disabled=f>=h.length-1)};window.addEventListener("hashchange",()=>{const b=window.location.hash;b!==h[f]&&(f>0&&b===h[f-1]?f--:f<h.length-1&&b===h[f+1]?f++:(f++,h.splice(f),h.push(b)),p())}),p(),t.addEventListener("play",()=>{ge(s)});const g=_s({onNeedRefresh(){js(()=>g(!0))},onOfflineReady(){console.log("App ready to work offline")}});let w;window.addEventListener("beforeinstallprompt",b=>{b.preventDefault(),w=b,localStorage.getItem("installPromptDismissed")||Ns(w)}),document.getElementById("show-shortcuts-btn")?.addEventListener("click",()=>{ne()}),!localStorage.getItem("shortcuts-shown")&&window.innerWidth>768&&setTimeout(()=>{ne(),localStorage.setItem("shortcuts-shown","true")},3e3),window.addEventListener("library-changed",()=>{const b=window.location.hash;b==="#library"?n.renderLibraryPage():(b==="#home"||b==="")&&n.renderHomePage()}),window.addEventListener("history-changed",()=>{window.location.hash==="#recent"&&n.renderRecentPage()})});function js(i){const t=document.createElement("div");t.className="update-notification",t.innerHTML=`
        <div>
            <strong>Update Available</strong>
            <p>A new version of Monochrome is available.</p>
        </div>
        <button class="btn-secondary" id="update-now-btn">Update Now</button>
    `,document.body.appendChild(t),document.getElementById("update-now-btn").addEventListener("click",()=>{typeof i=="function"?i():i&&i.postMessage?i.postMessage({action:"skipWaiting"}):window.location.reload()})}function Ns(i){if(!i)return;const t=document.createElement("div");t.className="install-prompt",t.innerHTML=`
        <div>
            <strong>Install Monochrome</strong>
            <p>Install this app for a better experience.</p>
        </div>
        <div style="display: flex; gap: 0.5rem;">
            <button class="btn-secondary" id="install-btn">Install</button>
            <button class="btn-secondary" id="dismiss-install">Dismiss</button>
        </div>
    `,document.body.appendChild(t),document.getElementById("install-btn").addEventListener("click",async()=>{t.remove(),i.prompt();const{outcome:e}=await i.userChoice;console.log(`User response to install prompt: ${e}`),i=null}),document.getElementById("dismiss-install").addEventListener("click",()=>{t.remove(),localStorage.setItem("installPromptDismissed","true")})}function qs(i){const t=document.createElement("div");t.className="missing-tracks-modal-overlay",t.innerHTML=`
        <div class="missing-tracks-modal">
            <div class="missing-tracks-header">
                <h3>Note</h3>
                <button class="close-missing-tracks">&times;</button>
            </div>
            <div class="missing-tracks-content">
                <p>Unfortunately some songs weren't able to be added. This could be an issue with our import system, try searching for the song and adding it. But it could also be due to Monochrome not having it sadly :(</p>
                <div class="missing-tracks-list">
                    <h4>Missing Tracks:</h4>
                    <ul>
                        ${i.map(s=>`<li>${s}</li>`).join("")}
                    </ul>
                </div>
            </div>
            <div class="missing-tracks-actions">
                <button class="btn-secondary" id="close-missing-tracks-btn">OK</button>
            </div>
        </div>
    `,document.body.appendChild(t);const e=()=>t.remove();t.addEventListener("click",s=>{(s.target===t||s.target.classList.contains("close-missing-tracks")||s.target.id==="close-missing-tracks-btn")&&e()})}async function Qs(i,t,e){const s=i.trim().split(`
`);if(s.length<2)return[];const n=d=>{const m=[];let u="",h=!1;for(let f=0;f<d.length;f++){const p=d[f];p==='"'?h=!h:p===","&&!h?(m.push(u),u=""):u+=p}return m.push(u),m.map(f=>f.trim().replace(/^"|"$/g,"").replace(/""/g,'"').trim())},a=n(s[0]),r=s.slice(1),c=[],o=[],l=r.length;for(let d=0;d<r.length;d++){const m=r[d];if(!m.trim())continue;const u=n(m);if(u.length>=a.length){let h="",f="";if(a.forEach((p,g)=>{const w=u[g];if(w)switch(p.toLowerCase()){case"track name":case"title":case"song":h=w;break;case"artist name(s)":case"artist":case"artists":f=w;break}}),e&&e({current:d,total:l,currentTrack:h||"Unknown track"}),h&&f){await new Promise(p=>setTimeout(p,300));try{const p=`${h} ${f}`,g=await t.searchTracks(p);if(g.items&&g.items.length>0){const w=g.items[0];c.push(w),console.log(`Found track: "${h}" by ${f}`)}else console.warn(`Track not found: "${h}" by ${f}`),o.push(`${h} - ${f}`)}catch(p){console.error(`Error searching for track "${h}":`,p),o.push(`${h} - ${f}`)}}}}return e&&e({current:l,total:l,currentTrack:"Import complete"}),{tracks:c,missingTracks:o}}function ne(){const i=document.createElement("div");i.className="shortcuts-modal-overlay",i.innerHTML=`
        <div class="shortcuts-modal">
            <div class="shortcuts-header">
                <h3>Keyboard Shortcuts</h3>
                <button class="close-shortcuts">&times;</button>
            </div>
            <div class="shortcuts-content">
                <div class="shortcut-item">
                    <kbd>Space</kbd>
                    <span>Play / Pause</span>
                </div>
                <div class="shortcut-item">
                    <kbd>→</kbd>
                    <span>Seek forward 10s</span>
                </div>
                <div class="shortcut-item">
                    <kbd>←</kbd>
                    <span>Seek backward 10s</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Shift</kbd> + <kbd>→</kbd>
                    <span>Next track</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Shift</kbd> + <kbd>←</kbd>
                    <span>Previous track</span>
                </div>
                <div class="shortcut-item">
                    <kbd>↑</kbd>
                    <span>Volume up</span>
                </div>
                <div class="shortcut-item">
                    <kbd>↓</kbd>
                    <span>Volume down</span>
                </div>
                <div class="shortcut-item">
                    <kbd>M</kbd>
                    <span>Mute / Unmute</span>
                </div>
                <div class="shortcut-item">
                    <kbd>S</kbd>
                    <span>Toggle shuffle</span>
                </div>
                <div class="shortcut-item">
                    <kbd>R</kbd>
                    <span>Toggle repeat</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Q</kbd>
                    <span>Open queue</span>
                </div>
                <div class="shortcut-item">
                    <kbd>L</kbd>
                    <span>Toggle lyrics</span>
                </div>
                <div class="shortcut-item">
                    <kbd>/</kbd>
                    <span>Focus search</span>
                </div>
                <div class="shortcut-item">
                    <kbd>Esc</kbd>
                    <span>Close modals</span>
                </div>
            </div>
        </div>
    `,document.body.appendChild(i),i.addEventListener("click",t=>{(t.target===i||t.target.classList.contains("close-shortcuts"))&&i.remove()})}
